/**
  * music21j 0.8.0 built on   * 2016-08-28.
 * Copyright (c) 2013-2016 Michael Scott Cuthbert and cuthbertLab
 *
 * http://github.com/cuthbertLab/music21j
 */

!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(exports,require("jquery"),require("vexflow"),require("jsonpickle"),require("MIDI")):"function"==typeof define&&define.amd?define(["exports","jquery","vexflow","jsonpickle","MIDI"],b):b(a.music21=a.music21||{},a.$,a.Vex,a.jsonpickle,a.MIDI)}(this,function(d,e,f,g,h){"use strict";var i={};i.merge=function a(b,c){if(void 0===c||null===c)return b;for(var d in c)try{c[d].constructor==Object?b[d]=a(b[d],c[d]):b[d]=c[d]}catch(a){b[d]=c[d]}return b},i.statisticalMode=function(a){if(0==a.length)return null;for(var b={},c=a[0],d=1,e=0;e<a.length;e++){var f=a[e];null==b[f]&&(b[f]=0),b[f]++,b[f]>d&&(c=f,d=b[f])}return c},i.makeSVGright=function(a,b){void 0===a&&(a="svg"),void 0===b&&(b={});var c=document.createElementNS("http://www.w3.org/2000/svg",a);for(var d in b)c.setAttribute(d,b[d]);return c},i.ordinalAbbreviation=function(a,b){var c="",d=a%100;if(11==d||12==d||13==d)c="th";else{var e=a%10;c=1==e?"st":2==e?"nd":3==e?"rd":"th"}return"st"!=c&&b&&(c+="s"),c},i.rationalize=function(a,b,c){b=b||.001,c=c||50;for(var d=2;d<c;d++)if(Math.abs(a*d-Math.round(a*d))<b){var e=Math.round(a*d),f=d;return{numerator:e,denominator:f}}},i.stripPx=function(a){if("string"==typeof a){var b=a.indexOf("px");return a=a.slice(0,b),parseInt(a)}return a},i.urlParam=function(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null==c?"":decodeURIComponent(c[1].replace(/\+/g," "))},i.jQueryEventCopy=function(a,b,c){b=b.jquery?b:jQuery(b),c=c.jquery?c:jQuery(c);var d=b[0].events||jQuery.data(b[0],"events")||jQuery._data(b[0],"events");if(b.length&&c.length&&d)return c.each(function(){for(var b in d)for(var c in d[b])jQuery.event.add(a,b,d[b][c],d[b][c].data)})},i.setWindowVisibilityWatcher=function(a){function b(b){var d="visible",e="hidden",f={focus:d,focusin:d,pageshow:d,blur:e,focusout:e,pagehide:e};b=b||window.event;var g="";g=b.type in f?f[b.type]:this[c]?"hidden":"visible",a(g,b)}var c="hidden";c in document?document.addEventListener("visibilitychange",b):(c="mozHidden")in document?document.addEventListener("mozvisibilitychange",b):(c="webkitHidden")in document?document.addEventListener("webkitvisibilitychange",b):(c="msHidden")in document?document.addEventListener("msvisibilitychange",b):"onfocusin"in document&&(document.onfocusin=document.onfocusout=b),window.onpageshow=window.onpagehide=window.onfocus=window.onblur=b;var d="visible"==document.visibilityState?"focus":"blur",e={type:d};b(e)};var j="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},k=function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")},l=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),m=function(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)},o=function(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b},q={};q.ProtoM21Object=function(){this.classes=["ProtoM21Object"],this.isProtoM21Object=!0,this.isMusic21Object=!1,this._cloneCallbacks={}},q.ProtoM21Object.prototype.clone=function(){var a=new this.constructor;for(var b in this)if(0!=this.hasOwnProperty(b))if(b in this._cloneCallbacks)this._cloneCallbacks[b]===!0?a[b]=this[b]:this._cloneCallbacks[b]===!1?a[b]=void 0:this._cloneCallbacks[b](b,a,this);else if(void 0!==Object.getOwnPropertyDescriptor(this,b).get||void 0!==Object.getOwnPropertyDescriptor(this,b).set);else if("function"==typeof this[b]);else if("object"==j(this[b])&&null!==this[b]&&this[b].isProtoM21Object)a[b]=this[b].clone();else try{a[b]=this[b]}catch(a){if(!(a instanceof TypeError))throw a;console.log("typeError:",a,b)}return a},q.ProtoM21Object.prototype.isClassOrSubclass=function(a){a instanceof Array==0&&(a=[a]);for(var b=0;b<a.length;b++)if(this.classes.indexOf(a[b])!=-1)return!0;return!1};var r={};r.typeFromNumDict={1:"whole",2:"half",4:"quarter",8:"eighth",16:"16th",32:"32nd",64:"64th",128:"128th",256:"256th",512:"512th",1024:"1024th",0:"zero",.5:"breve",.25:"longa",.125:"maxima",.0625:"duplex-maxima"},r.quarterTypeIndex=6,r.ordinalTypeFromNum=["duplex-maxima","maxima","longa","breve","whole","half","quarter","eighth","16th","32nd","64th","128th","256th","512th","1024th"],r.vexflowDurationArray=[void 0,void 0,void 0,void 0,"w","h","q","8","16","32",void 0,void 0,void 0,void 0,void 0],r.Duration=function(a){q.ProtoM21Object.call(this,a),this.classes.push("Duration"),this._quarterLength=1,this._dots=0,this._durationNumber=void 0,this._type="quarter",this._tuplets=[],this._cloneCallbacks._tuplets=function(a,b,c){for(var d=[],e=0;e<c[a].length;e++){var f=c[a][e].clone();d.push(f)}b[a]=d},Object.defineProperties(this,{dots:{get:function(){return this._dots},set:function(a){this._dots=a,this.updateQlFromFeatures()}},quarterLength:{get:function(){return this._quarterLength},set:function(a){void 0===a&&(a=1),this._quarterLength=a,this.updateFeaturesFromQl()}},type:{get:function(){return this._type},set:function(a){var b=r.ordinalTypeFromNum.indexOf(a);if(b==-1)throw console.log("invalid type "+a),"invalid type "+a;this._type=a,this.updateQlFromFeatures()}},tuplets:{enumerable:!0,get:function(){return this._tuplets}},vexflowDuration:{get:function(){var a=r.ordinalTypeFromNum.indexOf(this.type),b=r.vexflowDurationArray[a];if(this.dots>0)for(var c=0;c<this.dots;c++)b+="d";return b}}}),"string"==typeof a?this.type=a:this.quarterLength=a},r.Duration.prototype=new q.ProtoM21Object,r.Duration.prototype.constructor=r.Duration,r.Duration.prototype._findDots=function(a){if(0===a)return 0;for(var b=r.ordinalTypeFromNum.indexOf(this._type),c=Math.pow(2,r.quarterTypeIndex-b),d=0;d<=4;d++){var e=(Math.pow(2,d)-1)/Math.pow(2,d),f=1+e;if(Math.abs(c*f-a)<1e-4)return d}return music21.debug&&console.log("no dots available for ql; probably a tuplet",a),0},r.Duration.prototype.updateQlFromFeatures=function(){var a=r.ordinalTypeFromNum.indexOf(this._type),b=Math.pow(2,r.quarterTypeIndex-a),c=1+(Math.pow(2,this._dots)-1)/Math.pow(2,this._dots),d=b*c,e=d;this._tuplets.forEach(function(a){e*=a.tupletMultiplier()}),this._quarterLength=e},r.Duration.prototype.updateFeaturesFromQl=function(){var a=this._quarterLength,b=Math.floor(Math.log(a+1e-5)/Math.log(2)),c=r.quarterTypeIndex-b;this._type=r.ordinalTypeFromNum[c],this._dots=this._findDots(a);var d=Math.pow(2,r.quarterTypeIndex-c),e=1+(Math.pow(2,this._dots)-1)/Math.pow(2,this._dots),f=d*e;if(f!=a&&0!=a){c-=1,this._type=r.ordinalTypeFromNum[c],f=2*f;var g=a/f,h=i.rationalize(g);if(void 0===h);else{var j=new r.Tuplet(h.denominator,h.numerator,new r.Duration(f));this.appendTuplet(j,!0)}}},r.Duration.prototype.appendTuplet=function(a,b){a.frozen=!0,this._tuplets.push(a),b!==!0&&this.updateQlFromFeatures()},r.Tuplet=function(a,b,c,d){q.ProtoM21Object.call(this),this.classes.push("Tuplet"),this.numberNotesActual=a||3,this.numberNotesNormal=b||2,this.durationActual=c||new r.Duration(.5),"number"==typeof this.durationActual&&(this.durationActual=new r.Duration(this.durationActual)),this.durationNormal=d||this.durationActual,this.frozen=!1,this.type=void 0,this.bracket=!0,this.placement="above",this.tupletActualShow="number",this.tupletNormalShow=void 0,Object.defineProperties(this,{fullName:{enumerable:!0,get:function(){var a=this.numberNotesActual,b=this.numberNotesNormal;return 3==a&&2==b?"Triplet":5!=a||4!=b&&2!=b?6==a&&4==b?"Sextuplet":(ordStr=i.ordinalAbbreviation(b,!0),"Tuplet of "+a.toString()+"/"+b.toString()+ordStr):"Quintuplet"}}})},r.Tuplet.prototype=new q.ProtoM21Object,r.Tuplet.prototype.constructor=r.Tuplet,r.Tuplet.prototype.setDurationType=function(a){if(self.frozen===!0)throw"A frozen tuplet (or one attached to a duration) is immutable";return this.durationActual=new r.Duration(a),this.durationNormal=this.durationActual,this.durationActual},r.Tuplet.prototype.setRatio=function(a,b){if(self.frozen===!0)throw"A frozen tuplet (or one attached to a duration) is immutable";this.numberNotesActual=a||3,this.numberNotesNormal=b||2},r.Tuplet.prototype.totalTupletLength=function(){return this.numberNotesNormal*this.durationNormal.quarterLength},r.Tuplet.prototype.tupletMultiplier=function(){var a=this.durationActual.quarterLength;return this.totalTupletLength()/(this.numberNotesActual*a)},r.tests=function(){test("music21.duration.Duration",function(){var a=new music21.duration.Duration(1);equal(a.type,"quarter","got quarter note from 1.0"),equal(a.dots,0,"got no dots"),equal(a.quarterLength,1,"got 1.0 from 1.0"),equal(a.vexflowDuration,"q","vexflow q"),a.type="half",equal(a.type,"half","got half note from half"),equal(a.dots,0,"got no dots"),equal(a.quarterLength,2,"got 2.0 from half"),equal(a.vexflowDuration,"h","vexflow h"),a.quarterLength=6,equal(a.type,"whole"),equal(a.dots,1,"got one dot from 6.0"),equal(a.quarterLength,6,"got 6.0"),equal(a.vexflowDuration,"wd","vexflow duration wd"),a.quarterLength=7.75,equal(a.type,"whole"),equal(a.dots,4,"got four dots from 7.75")}),test("music21.duration.Tuplet",function(){var a=new music21.duration.Duration(.5),b=new music21.duration.Tuplet(5,4);equal(b.tupletMultiplier(),.8,"tuplet multiplier"),a.appendTuplet(b),equal(b.frozen,!0,"tuplet is frozen"),equal(a._tuplets[0],b,"tuplet appended"),equal(a.quarterLength,.4,"quarterLength Updated");var c=new music21.duration.Duration(1/3);equal(c.type,"eighth","got eighth note from 1/3"),equal(c.dots,0,"got no dots"),equal(c.quarterLength,1/3,"got 1/3 from 1/3");var d=c.tuplets[0];equal(d.numberNotesActual,3,"3/2 tuplet"),equal(d.numberNotesNormal,2,"3/2 tuplet"),equal(d.durationActual.quarterLength,.5),equal(d.tupletMultiplier(),2/3,"2/3 tuplet multiplier"),equal(d.totalTupletLength(),1,"total tuplet == 1.0");var e=new music21.stream.Stream;e.timeSignature=new music21.meter.TimeSignature("2/2");for(var f=0;f<6;f++){var g=new music21.note.Note("C4");g.duration.quarterLength=2/3,f%3===0&&g.articulations.push(new music21.articulations.Accent),e.append(g)}e.appendNewCanvas(),ok(!0,"quarter note triplets displayed");var h=new music21.stream.Measure;h.renderOptions.staffLines=1,h.timeSignature=new music21.meter.TimeSignature("2/4");var i=new music21.note.Note("B4");i.duration.quarterLength=2/3,i.duration.tuplets[0].durationNormal.type="eighth",i.duration.tuplets[0].tupletNormalShow="ratio";var j=new music21.note.Note("B4");j.duration.quarterLength=1/3,j.duration.tuplets[0].tupletNormalShow="ratio",h.append(i),h.append(j),h.append(j.clone());var k=i.clone();h.append(k),h.appendNewCanvas(),ok(!0,"tuplets beginning with different type than original"),equal(i.duration.tuplets[0]!==k.duration.tuplets[0],!0,"tuplet should not be the same object after clone")}),test("music21.duration.Tuplet multiple parts",function(){var a=new music21.stream.Measure;a.timeSignature=new music21.meter.TimeSignature("3/2");var b=new music21.note.Note("F4"),c=new music21.note.Note("E4");a.append(b),a.append(c);for(var d=0;d<10;d++){var e=new music21.note.Note("F4");e.pitch.diatonicNoteNum+=d,e.duration.quarterLength=.4,e.duration.tuplets[0].tupletNormalShow="ratio",d%5===0&&e.articulations.push(new music21.articulations.Accent),a.append(e)}var f=new music21.stream.Measure;f.timeSignature=new music21.meter.TimeSignature("3/2"),f.append(new music21.note.Note("B5",6));var g=new music21.stream.Part;g.append(a),g.append(f);var h=new music21.stream.Measure;h.timeSignature=new music21.meter.TimeSignature("3/2"),h.append(new music21.note.Note("B3",6));var i=new music21.stream.Measure;i.timeSignature=new music21.meter.TimeSignature("3/2"),i.append(new music21.note.Note("B3",6));var j=new music21.stream.Part;j.append(h),j.append(i);var k=new music21.stream.Score;k.insert(0,g),k.insert(0,j),k.appendNewCanvas(),ok(!0,"5:4 tuplets in 3/2 with multiple parts")})};var s={};s.Music21Object=function(){q.ProtoM21Object.call(this),this.classes.push("Music21Object"),this.classSortOrder=20,this._priority=0,this.offset=null,this.activeSite=void 0,this.isMusic21Object=!0,this.isStream=!1,this._duration=new r.Duration,this.groups=[],Object.defineProperties(this,{priority:{configurable:!0,enumerable:!0,get:function(){return this._priority},set:function(a){this._priority=a}},duration:{configurable:!0,get:function(){return this._duration},set:function(a){"object"==("undefined"==typeof a?"undefined":j(a))?this._duration=a:"number"==typeof a?this._duration.quarterLength=a:"string"==typeof a&&(this._duration.type=a)}}}),this._cloneCallbacks.activeSite=function(a,b,c){b[a]=void 0}},s.Music21Object.prototype=new q.ProtoM21Object,s.Music21Object.prototype.constructor=s.Music21Object,s.Music21Object.prototype.getOffsetBySite=function(a){if(void 0===a)return this.offset;for(var b=0;b<a.length;b++)if(a._elements[b]===this)return a._elementOffsets[b]};var u={},v=function(a){function b(){k(this,b);var a=o(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("Articulation"),a.name=void 0,a.placement="above",a.vexflowModifier=void 0,a.setPosition=void 0,a.dynamicScale=1,a.lengthScale=1,a}return m(b,a),l(b,[{key:"vexflow",value:function(){var a=new f.Flow.Articulation(this.vexflowModifier);return this.setPosition&&a.setPosition(this.setPosition),a}}]),b}(q.ProtoM21Object);u.Articulation=v;var w=function(a){function b(){k(this,b);var a=o(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("LengthArticulation"),a}return m(b,a),b}(v);u.LengthArticulation=w;var x=function(a){function b(){k(this,b);var a=o(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("DynamicArticulation"),a}return m(b,a),b}(v);u.DynamicArticulation=x;var y=function(a){function b(){k(this,b);var a=o(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("PitchArticulation"),a}return m(b,a),b}(v);u.PitchArticulation=y;var z=function(a){function b(){k(this,b);var a=o(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("TimbreArticulation"),a}return m(b,a),b}(v);u.TimbreArticulation=z;var A=function(a){function b(){k(this,b);var a=o(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("Accent"),a.name="accent",a.vexflowModifier="a>",a.dynamicScale=1.5,a}return m(b,a),b}(x);u.Accent=A;var B=function(a){function b(){k(this,b);var a=o(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("StrongAccent"),a.name="strong accent",a.vexflowModifier="a^",a.dynamicScale=2,a}return m(b,a),b}(A);u.StrongAccent=B;var C=function(a){function b(){k(this,b);var a=o(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("Staccato"),a.name="staccato",a.vexflowModifier="a.",a}return m(b,a),b}(w);u.Staccato=C;var D=function(a){function b(){k(this,b);var a=o(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("Staccatissimo"),a.name="staccatissimo",a.vexflowModifier="av",a}return m(b,a),b}(C);u.Staccatissimo=D;var E=function(a){function b(){k(this,b);var a=o(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("Spiccato"),a.name="spiccato",a.vexflowModifier=void 0,a}return m(b,a),b}(C);u.Spiccato=E;var F=function(a){function b(){k(this,b);var a=o(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return w.call(a),a.classes.push("Marcato"),a.name="marcato",a.vexflowModifier="a^",a.dynamicScale=1.7,a}return m(b,a),b}(x);u.Marcato=F;var G=function(a){function b(){k(this,b);var a=o(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("Tenuto"),a.name="tenuto",a.vexflowModifier="a-",a}return m(b,a),b}(w);u.Tenuto=G,u.tests=function(){test("music21.articulations.Articulation",function(){var a=new music21.articulations.Accent;equal(a.name,"accent","matching names for accent");var b=new music21.articulations.Tenuto;equal(b.name,"tenuto","matching names for tenuto");var c=new music21.note.Note("C");c.articulations.push(a),c.articulations.push(b),equal(c.articulations[0].name,"accent","accent in array"),equal(c.articulations[1].name,"tenuto","tenuto in array")}),test("music21.articulations.Articulation display",function(){var a=new music21.articulations.Marcato;equal(a.name,"marcato","matching names for marcato");var b=new music21.note.Note("D#5");b.articulations.push(a);var c=new music21.note.Note("D#5"),d=new music21.stream.Measure;d.append(b),d.append(c),d.append(c.clone()),d.append(b.clone()),d.appendNewCanvas(),ok(!0,"something worked")})};var H={};H.Accidental=function(a){q.ProtoM21Object.call(this),this.classes.push("Accidental"),this._name="",this._alter=0,this._modifier="",this._unicodeModifier="",this.displayType="normal",this.displayStatus=void 0,this.set(a)},H.Accidental.prototype=new q.ProtoM21Object,H.Accidental.prototype.constructor=H.Accidental,H.Accidental.prototype.set=function(a){void 0!=a&&void 0!=a.toLowerCase&&(a=a.toLowerCase()),"natural"==a||"n"==a||0==a||void 0==a?(this._name="natural",this._alter=0,this._modifier="",this._unicodeModifier="♮"):"sharp"==a||"#"==a||1==a?(this._name="sharp",this._alter=1,this._modifier="#",this._unicodeModifier="♯"):"flat"==a||"-"==a||a==-1?(this._name="flat",this._alter=-1,this._modifier="-",this._unicodeModifier="♭"):"double-flat"==a||"--"==a||a==-2?(this._name="double-flat",this._alter=-2,this._modifier="--",this._unicodeModifier="&#x1d12b;"):"double-sharp"==a||"##"==a||2==a?(this._name="double-sharp",this._alter=2,this._modifier="##",this._unicodeModifier="&#x1d12a;"):"triple-flat"==a||"---"==a||a==-3?(this._name="triple-flat",this._alter=-3,this._modifier="---",this._unicodeModifier="♭&#x1d12b;"):"triple-sharp"!=a&&"###"!=a&&3!=a||(this._name="triple-sharp",this._alter=3,this._modifier="###",this._unicodeModifier="&#x1d12a;")},Object.defineProperties(H.Accidental.prototype,{name:{enumerable:!0,configurable:!0,get:function(){return this._name},set:function(a){this.set(a)}},alter:{enumerable:!0,configurable:!0,get:function(){return this._alter},set:function(a){this.set(a)}},modifier:{enumerable:!0,configurable:!0,get:function(){return this._modifier},set:function(a){this.set(a)}},vexflowModifier:{enumerable:!0,configurable:!1,get:function(){var a=this.modifier;if(""==a)return"n";if("#"==a)return"#";if("-"==a)return"b";if("##"==a)return"##";if("--"==a)return"bb";if("###"==a)return"###";if("---"==a)return"bbb";throw"Vexflow does not support: "+a}},unicodeModifier:{enumerable:!0,configurable:!1,get:function(){return this._unicodeModifier}}}),H.nameToMidi={C:0,D:2,E:4,F:5,G:7,A:9,B:11},H.nameToSteps={C:0,D:1,E:2,F:3,G:4,A:5,B:6},H.stepsToName=["C","D","E","F","G","A","B"],H.midiToName=["C","C#","D","E-","E","F","F#","G","A-","A","B-","B"],H.Pitch=function(a){q.ProtoM21Object.call(this),this.classes.push("Pitch"),void 0==a&&(a="C"),this._step="C",this._octave=4,this._accidental=void 0,"number"==typeof a?(a<12&&(a+=60),this.ps=a):a.match(/\d+/)?this.nameWithOctave=a:this.name=a},H.Pitch.prototype=new q.ProtoM21Object,H.Pitch.prototype.constructor=H.Pitch,Object.defineProperties(H.Pitch.prototype,{step:{enumerable:!0,configurable:!0,get:function(){return this._step},set:function(a){this._step=a}},octave:{enumerable:!0,configurable:!0,get:function(){return this._octave},set:function(a){this._octave=a}},accidental:{enumerable:!0,configurable:!0,get:function(){return this._accidental},set:function(a){"object"!=("undefined"==typeof a?"undefined":j(a))&&void 0!==a&&(a=new music21.pitch.Accidental(a)),this._accidental=a}},name:{enumerable:!0,configurable:!0,get:function(){return void 0==this.accidental?this.step:this.step+this.accidental.modifier},set:function(a){this.step=a.slice(0,1).toUpperCase();var b=a.slice(1);void 0!=b?this.accidental=b:this.accidental=void 0}},nameWithOctave:{enumerable:!0,configurable:!0,get:function(){return this.name+this.octave.toString()},set:function(a){var b=a.match(/\d+/);void 0!=b?(a=a.replace(/\d+/,""),this.octave=parseInt(b),this.name=a):this.name=a}},diatonicNoteNum:{enumerable:!0,configurable:!0,get:function(){return 7*this.octave+H.nameToSteps[this.step]+1},set:function(a){a-=1,this.octave=Math.floor(a/7),this.step=H.stepsToName[a%7]}},frequency:{enumerable:!0,configurable:!0,get:function(){return 440*Math.pow(2,(this.ps-69)/12)}},midi:{enumerable:!0,configurable:!0,get:function(){return Math.floor(this.ps)}},ps:{enumerable:!0,configurable:!0,get:function(){var a=0;return void 0!=this.accidental&&(a=parseInt(this.accidental.alter)),12*(this.octave+1)+H.nameToMidi[this.step]+a},set:function(a){this.name=H.midiToName[a%12],this.octave=Math.floor(a/12)-1}}}),H.Pitch.prototype.vexflowName=function(a){var b=this;if(void 0!==a)try{b=a.convertPitchToTreble(this)}catch(b){console.log(b,a)}var c="n";void 0!=this.accidental&&(c=this.accidental.vexflowModifier);var d=b.step+c+"/"+b.octave;return d},H.tests=function(){test("music21.pitch.Accidental",function(){var a=new music21.pitch.Accidental("-");equal(a.alter,-1,"flat alter passed"),equal(a.name,"flat","flat name passed")}),test("music21.pitch.Pitch",function(){var a=new music21.pitch.Pitch("D#5");equal(a.name,"D#","Pitch Name set to D#"),equal(a.step,"D","Pitch Step set to D"),equal(a.octave,5,"Pitch octave set to 5");var b=new music21.clef.AltoClef,c=a.vexflowName(b);equal(c,"C#/6","Vexflow name set")})};var I={};I.fftSize=2048,I.AudioContextCaller=window.AudioContext||window.webkitAudioContext,I._audioContext=null,I.animationFrameCallbackId=null,Object.defineProperties(I,{audioContext:{get:function(){return null!==I._audioContext?I._audioContext:(I._audioContext=new I.AudioContextCaller,I._audioContext)},set:function(a){I._audioContext=a}}}),I.getUserMedia=function(a,b,c){void 0===c&&(c=function(){alert("navigator.getUserMedia either not defined (Safari, IE) or denied.")}),void 0===b&&(b=function(a){I.userMediaStarted(a)});var d=navigator;d.getUserMedia=d.getUserMedia||d.webkitGetUserMedia||d.mozGetUserMedia||d.msGetUserMedia,void 0===d.getUserMedia&&c(),void 0===a&&(a={audio:{mandatory:{},optional:[]}}),d.getUserMedia(a,b,c)},I.sampleBuffer=null,I.currentAnalyser=null,I.userMediaStarted=function(a){I.sampleBuffer=new Float32Array(I.fftSize/2);var b=I.audioContext.createMediaStreamSource(a),c=I.audioContext.createAnalyser();c.fftSize=I.fftSize,b.connect(c),I.currentAnalyser=c,I.animateLoop()},I.minFrequency=55,I.maxFrequency=1050,I.animateLoop=function(a){I.currentAnalyser.getFloatTimeDomainData(I.sampleBuffer);var b=I.autoCorrelate(I.sampleBuffer,I.audioContext.sampleRate,I.minFrequency,I.maxFrequency),c=I.sampleCallback(b);c!=-1&&(I.animationFrameCallbackId=window.requestAnimationFrame(I.animateLoop))},I.pitchSmoothingSize=40,I.lastPitchClassesDetected=[],I.lastPitchesDetected=[],I.lastCentsDeviationsDetected=[],I.smoothPitchExtraction=function(a){if(a==-1)I.lastPitchClassesDetected.shift(),I.lastPitchesDetected.shift(),I.lastCentsDeviationsDetected.shift();else{var b=I.midiNumDiffFromFrequency(a),c=b[0],d=b[1];I.lastPitchClassesDetected.length>I.pitchSmoothingSize&&(I.lastPitchClassesDetected.shift(),I.lastPitchesDetected.shift(),I.lastCentsDeviationsDetected.shift()),I.lastPitchClassesDetected.push(c%12),I.lastPitchesDetected.push(c),I.lastCentsDeviationsDetected.push(d)}var e=i.statisticalMode(I.lastPitchClassesDetected);if(null===e)return[-1,0];for(var f=[],g=[],h=0;h<I.lastPitchClassesDetected.length;h++)I.lastPitchClassesDetected[h]==e&&(f.push(I.lastPitchesDetected[h]),g.push(I.lastCentsDeviationsDetected[h]));for(var j=i.statisticalMode(f),k=0,l=0,m=0;m<g.length;m++){var n=Math.pow(m,2)+1;l+=n*g[m],k+=n}var d=Math.floor(l/k);return[j,d]},I.sampleCallback=function(a){var b=I.smoothPitchExtraction(a);b[0],b[1]},I.autoCorrelate=function(a,b,c,d){var e=a.length,f=Math.floor(e/2);void 0===c&&(c=0),void 0===d&&(d=b);for(var g=-1,h=0,i=0,j=!1,k=new Array(f),l=0;l<e;l++){var m=a[l];i+=m*m}if(i=Math.sqrt(i/e),i<.01)return-1;for(var n=1,o=0;o<f;o++){var p=0,q=b/o;if(q<c)break;if(!(q>d)){for(var l=0;l<f;l++)p+=Math.abs(a[l]-a[l+o]);if(p=1-p/f,k[o]=p,p>.9&&p>n)j=!0,p>h&&(h=p,g=o);else if(j){var r=(k[g+1]-k[g-1])/k[g];return b/(g+8*r)}n=p}}return h>.01?b/g:-1},I.midiNumDiffFromFrequency=function(a){var b=12*(Math.log(a/440)/Math.log(2))+69,c=Math.round(b),d=Math.round(100*(b-c));return[c,d]};var J=function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),e=Math.max(0,16-(d-a)),f=window.setTimeout(function(){b(d+e)},e);return a=d+e,f}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})};J();var K={};K.validBeamTypes={start:!0,stop:!0,continue:!0,partial:!0},K.Beam=function(a,b){q.ProtoM21Object.call(this),this.classes.push("Beam"),this.type=a,this.direction=b,this.independentAngle=void 0,this.number=void 0},K.Beam.prototype=new q.ProtoM21Object,K.Beam.prototype.constructor=K.Beam,K.Beams=function(){q.ProtoM21Object.call(this),this.classes.push("Beams"),this.beamsList=[],this.feathered=!1},K.Beams.prototype=new q.ProtoM21Object,K.Beams.prototype.constructor=K.Beams,Object.defineProperties(K.Beams.prototype,{length:{enumerable:!0,get:function(){return this.beamsList.length}}}),K.Beams.prototype.append=function(a,b){var c=new K.Beam(a,b);return c.number=this.beamsList.length+1,this.beamsList.push(c),c},K.Beams.prototype.fill=function(a,b){this.beamsList=[];var c=1;if(1==a||"8th"==a||a==r.typeFromNumDict[8])c=1;else if(2==a||a==r.typeFromNumDict[16])c=2;else if(3==a||a==r.typeFromNumDict[32])c=3;else if(4==a||a==r.typeFromNumDict[64])c=4;else if(5==a||a==r.typeFromNumDict[128])c=5;else{if(6!=a&&a!=r.typeFromNumDict[256])throw"cannot fill beams for level "+a;c=6}for(var d=1;d<=c;d++){var e=new K.Beam;e.number=d,this.beamsList.push(e)}return void 0!==b&&this.setAll(b),this},K.Beams.prototype.getByNumber=function(a){if(!(a in this.getNumbers()))throw"beam number error";for(var b=0;b<this.length;b++)if(this.beamsList[b].number==a)return this.beamsList[b]},K.Beams.prototype.getNumbers=function(){for(var a=[],b=0;b<this.length;b++)a.push(this.beamsList[b].number);return a},K.Beams.prototype.getTypeByNumber=function(a){var b=this.getByNumber(a);if(void 0===b.direction)return b.type;var c=b.type+"-"+b.direction;return c},K.Beams.prototype.getTypes=function(){for(var a=[],b=0;b<this.length;b++)a.push(this.beamsList[b].type);return a},K.Beams.prototype.setAll=function(a,b){if(void 0===K.validBeamTypes[a])throw"invalid beam type";for(var c=0;c<this.length;c++){var d=this.beamsList[c];d.type=a,d.direction=b}return this},K.Beams.prototype.setByNumber=function(a,b,c){if(void 0===c){var d=b.split("-");b=d[0],c=d[1]}if(void 0===K.validBeamTypes[b])throw"invalid beam type";for(var e=0;e<this.length;e++)this.beamsList[e].number==a&&(this.beamsList[e].type=b,this.beamsList[e].direction=c);return this},K.tests=function(){test("music21.beam.Beams",function(){var a=new music21.beam.Beams;a.fill("16th"),a.setAll("start"),equal(a.getTypes()[0],"start"),equal(a.getTypes()[1],"start");var b=new music21.beam.Beams;b.fill("16th"),b.setAll("start"),b.setByNumber(1,"continue"),equal(b.beamsList[0].type,"continue"),b.setByNumber(2,"stop"),equal(b.beamsList[1].type,"stop"),b.setByNumber(2,"partial-right"),equal(b.beamsList[1].type,"partial"),equal(b.beamsList[1].direction,"right")})};var L={};L.noteheadTypeNames=["arrow down","arrow up","back slashed","circle dot","circle-x","cluster","cross","diamond","do","fa","inverted triangle","la","left triangle","mi","none","normal","re","rectangle","slash","slashed","so","square","ti","triangle","x"],L.stemDirectionNames=["double","down","noStem","none","unspecified","up"],L.Lyric=function(a,b,c,d,e){q.ProtoM21Object.call(this),this.classes.push("Lyric"),this.lyricConnector="-",this.text=a,this._number=b||1,this.syllabic=c,this.applyRaw=d||!1,this.setTextAndSyllabic(this.text,this.applyRaw),this._identifier=e,Object.defineProperties(this,{identifier:{get:function(){return this._identifier||this._number},set:function(a){this._identifier=a},enumerable:!0},number:{get:function(){return this._number},set:function(a){this._number=a},enumerable:!0},rawText:{get:function(){return"begin"==this.syllabic?this.text+this.lyricConnector:"middle"==this.syllabic?this.lyricConnector+this.text+this.lyricConnector:"end"==this.syllabic?this.lyricConnector+this.text:this.text},set:function(a){this.setTextAndSyllabic(a,!1)},enumerable:!0}})},L.Lyric.prototype=new q.ProtoM21Object,L.Lyric.prototype.constructor=L.Lyric,L.Lyric.prototype.setTextAndSyllabic=function(a,b){return void 0===a?void(this.text=void 0):void(b||0!==a.indexOf(this.lyricConnector)||a.slice(-1)!=this.lyricConnector?b||0!==a.indexOf(this.lyricConnector)?b||a.slice(-1)!=this.lyricConnector?(this.text=a,void 0===this.syllabic&&(this.syllabic="single")):(this.text=a.slice(0,-1),this.syllabic="begin"):(this.text=a.slice(1),this.syllabic="end"):(this.text=a.slice(1,-1),this.syllabic="middle"))},L.GeneralNote=function(a){s.Music21Object.call(this),this.classes.push("GeneralNote"),this.isChord=!1,void 0!==a&&(this.duration.quarterLength=a),this.volume=60,this.activeVexflowNote=void 0,this.expressions=[],this.articulations=[],this.lyrics=[],this.tie=void 0,Object.defineProperties(this,{quarterLength:{get:function(){return this.duration.quarterLength},set:function(a){this.duration.quarterLength=a},enumerable:!0},lyric:{get:function(){return this.lyrics.length>0?this.lyrics[0].text:void 0},set:function(a){this.lyrics=[],void 0!==a&&a!==!1&&this.lyrics.push(new L.Lyric(a))},enumerable:!0},midiVolume:{enumerable:!0,get:function(){var a=this.volume;return void 0===a&&(a=60),void 0!==this.articulations&&this.articulations.forEach(function(b){a*=b.dynamicScale,a>127?a=127:isNaN(a)&&(a=60)}),a=Math.floor(a)}}})},L.GeneralNote.prototype=new s.Music21Object,L.GeneralNote.prototype.constructor=L.GeneralNote,L.GeneralNote.prototype.addLyric=function(a,b,c,d){if(c=c||!1,void 0===b)maxLyrics=this.lyrics.length+1,this.lyrics.push(new L.Lyric(a,maxLyrics,void 0,c,d));else{foundLyric=!1;for(var e=0;e<self.lyrics.length;e++)if(thisLyric=self.lyrics[e],thisLyric.number==b){thisLyric.text=a,foundLyric=!0;break}foundLyric===!1&&this.lyrics.push(new L.Lyric(a,b,void 0,c,d))}},L.GeneralNote.prototype.setStemDirectionFromClef=function(a){},L.GeneralNote.prototype.vexflowAccidentalsAndDisplay=function(a,b){if(this.duration.dots>0)for(var c=0;c<this.duration.dots;c++)a.addDotToAll();if(void 0!==this.activeSite&&void 0!==this.activeSite.renderOptions.stemDirection?this.stemDirection=this.activeSite.renderOptions.stemDirection:void 0===this.stemDirection&&void 0!==b.clef&&this.setStemDirectionFromClef(b.clef),music21.debug&&console.log(this.stemDirection),a.setStemDirection("down"==this.stemDirection?f.Flow.StaveNote.STEM_DOWN:f.Flow.StaveNote.STEM_UP),"noStem"==this.stemDirection)a.hasStem=function(){return!1};else{var d=5;if(b.stave&&(d=Math.floor(b.stave.options.spacing_between_lines_px/2)),void 0!==b.clef&&void 0!==this.pitch){var e=b.clef.lowestLine+4,g=Math.abs(this.pitch.diatonicNoteNum-e),h=g-7;if(h>0&&void 0!==a.getStemLength){var i=h*d+a.getStemLength();a.setStemLength(i)}}}},L.GeneralNote.prototype.playMidi=function(a,b,c){if(void 0===a&&(a=120),void 0===c){var d=void 0;void 0!==this.activeSite&&(d=this.activeSite.instrument),
c={instrument:d}}var e=this.midiVolume,f=0;void 0!==c&&void 0!==c.instrument&&(f=c.instrument.midiChannel);var g=6e4/a,h=this.duration.quarterLength;g=60*h*1e3/a;var i=void 0;if(this.isClassOrSubclass("Note")){i=this.pitch.midi;var j=g/1e3;void 0!==b&&b.isClassOrSubclass("Note")?b.pitch.midi!=this.pitch.midi?j+=15/a:void 0===this.tie||"start"!=this.tie.type&&"continue"!=this.tie.type||(j+=60*b.duration.quarterLength/a):void 0===b&&(j+=60/a),void 0!==this.tie&&"start"!=this.tie.type||(music21.MIDI.noteOn(f,i,e,0),music21.MIDI.noteOff(f,i,j))}else if(this.isClassOrSubclass("Chord"))for(var k=0;k<this._notes.length;k++)i=this._notes[k].pitch.midi,music21.MIDI.noteOn(f,i,e,0),music21.MIDI.noteOff(f,i,g/1e3);return g},L.NotRest=function(a){L.GeneralNote.call(this,a),this.classes.push("NotRest"),this.notehead="normal",this.noteheadFill="default",this.noteheadColor=void 0,this.noteheadParenthesis=!1,this.volume=void 0,this.beams=new K.Beams,this.stemDirection=void 0},L.NotRest.prototype=new L.GeneralNote,L.NotRest.prototype.constructor=L.NotRest,L.Note=function(a,b){L.NotRest.call(this,b),this.classes.push("Note"),this.isNote=!0,this.isRest=!1,void 0!==a&&void 0!==a.isClassOrSubclass&&a.isClassOrSubclass("Pitch")===!0?this.pitch=a:this.pitch=new H.Pitch(a),Object.defineProperties(this,{name:{get:function(){return this.pitch.name},set:function(a){this.pitch.name=a},enumerable:!0},nameWithOctave:{get:function(){return this.pitch.nameWithOctave},set:function(a){this.pitch.nameWithOctave=a},enumerable:!0},step:{get:function(){return this.pitch.step},set:function(a){this.pitch.step=a},enumerable:!0},octave:{get:function(){return this.pitch.octave},set:function(a){this.pitch.octave=a},enumerable:!0}})},L.Note.prototype=new L.NotRest,L.Note.prototype.constructor=L.Note,L.Note.prototype.setStemDirectionFromClef=function(a){if(void 0===a)return this;var b=a.lowestLine+4,c=this.pitch.diatonicNoteNum-b;return c>=0?this.stemDirection="down":this.stemDirection="up",this},L.Note.prototype.vexflowNote=function(a){var b={};i.merge(b,a);var c=b.clef;if(void 0!==this.duration){var d=this.duration.vexflowDuration;if(void 0!==d){var e=this.pitch.vexflowName(c),g=new f.Flow.StaveNote({keys:[e],duration:d});if(this.vexflowAccidentalsAndDisplay(g,b),void 0!==this.pitch.accidental&&("n"!=this.pitch.accidental.vexflowModifier&&this.pitch.accidental.displayStatus!==!1?g.addAccidental(0,new f.Flow.Accidental(this.pitch.accidental.vexflowModifier)):"always"!=this.pitch.accidental.displayType&&this.pitch.accidental.displayStatus!==!0||g.addAccidental(0,new f.Flow.Accidental(this.pitch.accidental.vexflowModifier))),void 0!==this.articulations[0])for(var h=0;h<this.articulations.length;h++){var j=this.articulations[h];g.addArticulation(0,j.vexflow())}if(void 0!==this.expressions[0])for(var k=0;k<this.expressions.length;k++){var l=this.expressions[k];g.addArticulation(0,l.vexflow())}return this.noteheadColor&&g.setKeyStyle(0,{fillStyle:this.noteheadColor}),this.activeVexflowNote=g,g}}},L.Rest=function(a){L.GeneralNote.call(this,a),this.classes.push("Rest"),this.isNote=!1,this.isRest=!0,this.name="rest",this.lineShift=void 0},L.Rest.prototype=new L.GeneralNote,L.Rest.prototype.constructor=L.Rest,L.Rest.prototype.vexflowNote=function(){var a="b/4";if("whole"==this.duration.type&&void 0!==this.activeSite&&1!=this.activeSite.renderOptions.staffLines&&(a="d/5"),void 0!==this.lineShift){var b=new music21.pitch.Pitch("B4"),c=this.lineShift;"whole"==this.duration.type&&(c+=2),b.diatonicNoteNum+=c,a=b.vexflowName(void 0)}var d=new f.Flow.StaveNote({keys:[a],duration:this.duration.vexflowDuration+"r"});if(this.duration.dots>0)for(var e=0;e<this.duration.dots;e++)d.addDotToAll();return this.activeVexflowNote=d,d},L.tests=function(){test("music21.note.Note",function(){var a=new L.Note("D#5");equal(a.pitch.name,"D#","Pitch Name set to D#"),equal(a.pitch.step,"D","Pitch Step set to D"),equal(a.pitch.octave,5,"Pitch octave set to 5")})};var M={};M.Chord=function(a){"undefined"==typeof a&&(a=[]),L.NotRest.call(this),this.classes.push("Chord"),this.isChord=!0,this.isNote=!1,this.isRest=!1,this._notes=[],Object.defineProperties(this,{length:{enumerable:!0,get:function(){return this._notes.length}},pitches:{enumerable:!0,get:function(){for(var a=[],b=0;b<this._notes.length;b++)a.push(this._notes[b].pitch);return a},set:function(a){this._notes=[];for(var b=0;b<a.length;b++){var c=void 0;if("string"==typeof a[b])c=new L.Note(a[b]);else if(a[b].isClassOrSubclass("Pitch"))c=new L.Note,c.pitch=a[b];else{if(!a[b].isClassOrSubclass("Note"))throw console.warn("bad pitch",a[b]),"Cannot add pitch from "+a[b];c=a[b]}this._notes.push(c)}return this._notes}}}),a.forEach(this.add,this)},M.Chord.prototype=new L.NotRest,M.Chord.prototype.constructor=M.Chord,M.Chord.prototype.setStemDirectionFromClef=function(a){if(void 0===a)return this;for(var b=a.lowestLine+4,c=0,d=this.pitches,e=0;e<this.pitches.length;e++){var f=d[e],g=f.diatonicNoteNum-b;Math.abs(g)>=Math.abs(c)&&(c=g)}return c>=0?this.stemDirection="down":this.stemDirection="up",this},M.Chord.prototype.add=function(a){if("string"==typeof a)a=new L.Note(a);else if(a.isClassOrSubclass("Pitch")){var b=a,c=new L.Note;c.pitch=b,a=c}return this._notes.push(a),this._notes.sort(function(a,b){return a.pitch.ps-b.pitch.ps}),this},M.Chord.prototype.removeDuplicatePitches=function(){for(var a=[],b=[],c=this.pitches,d=0;d<c.length;d++){var e=c[d];a.indexOf(e.step)==-1&&(a.push(e.step),b.push(e))}var f=new M.Chord(b);return f},M.Chord.prototype.root=function(){var a=this.removeDuplicatePitches(),b=a.pitches;if(0==b.length)throw"No notes in Chord!";if(1==b.length)return this.pitches[0];for(var c=[],d=[3,5,7,2,4,6],e=0;e<b.length;e++){for(var f=b[e],g=[],h=0;h<d.length;h++){var i=a.getChordStep(d[h],f);void 0!=i?g.push(!0):g.push(!1)}hasFalse=!1;for(var j=0;j<b.length-1;j++)0==g[j]&&(hasFalse=!0);if(0==hasFalse)return c.push(e),a.pitches[e]}return a.pitches[0]},M.Chord.prototype.semitonesFromChordStep=function(a,b){void 0===b&&(b=this.root());var c=this.getChordStep(a,b);if(void 0!=c){var d=(c.ps-b.ps)%12;return d<0&&(d+=12),d}},M.Chord.prototype.bass=function(){for(var a=void 0,b=this.pitches,c=0;c<b.length;c++){var d=b[c];void 0==a?a=d:d.ps<a.ps&&(a=d)}return a},M.Chord.prototype.cardinality=function(){var a=this.removeDuplicatePitches();return a.pitches.length},M.Chord.prototype.isMajorTriad=function(){if(3!=this.cardinality())return!1;var a=this.semitonesFromChordStep(3),b=this.semitonesFromChordStep(5);return 4==a&&7==b},M.Chord.prototype.isMinorTriad=function(){if(3!=this.cardinality())return!1;var a=this.semitonesFromChordStep(3),b=this.semitonesFromChordStep(5);return 3==a&&7==b},M.Chord.prototype.inversion=function(){for(var a=this.bass(),b=this.root(),c=[1,6,4,2,7,5,3],d=0;d<c.length;d++){var e=this.getChordStep(c[d],a);if(void 0!=e&&e.name==b.name)return d}},M.Chord.prototype.vexflowNote=function(a){for(var b=a.clef,c=[],d=0;d<this._notes.length;d++)c.push(this._notes[d].pitch.vexflowName(b));var e=new f.Flow.StaveNote({keys:c,duration:this.duration.vexflowDuration});this.vexflowAccidentalsAndDisplay(e,a);for(var d=0;d<this._notes.length;d++){var g=this._notes[d];void 0!=g.pitch.accidental&&("n"!=g.pitch.accidental.vexflowModifier&&0!=g.pitch.accidental.displayStatus?e.addAccidental(d,new f.Flow.Accidental(g.pitch.accidental.vexflowModifier)):"always"!=g.pitch.accidental.displayType&&1!=g.pitch.accidental.displayStatus||e.addAccidental(d,new f.Flow.Accidental(g.pitch.accidental.vexflowModifier)))}return this.activeVexflowNote=e,e},M.Chord.prototype.getChordStep=function(a,b){void 0==b&&(b=this.root()),a>=8&&(a%=7);for(var c=this.pitches,d=b.diatonicNoteNum,e=0;e<c.length;e++){var f=c[e],g=(f.diatonicNoteNum-d+1)%7;if(g<=0&&(g+=7),g==a)return f}},M.chordDefinitions={major:["M3","m3"],minor:["m3","M3"],diminished:["m3","m3"],augmented:["M3","M3"],"major-seventh":["M3","m3","M3"],"dominant-seventh":["M3","m3","m3"],"minor-seventh":["m3","M3","m3"],"diminished-seventh":["m3","m3","m3"],"half-diminished-seventh":["m3","m3","M3"]};var N={};N.lowestLines={treble:31,soprano:29,"mezzo-soprano":27,alto:25,tenor:23,bass:19,percussion:31},N.Clef=function(a,b){s.Music21Object.call(this),this.classes.push("Clef"),void 0!=a?(a=a.toLowerCase(),this.name=a,this.lowestLine=N.lowestLines[a],this.lowestLineTrebleOffset=N.lowestLines.treble-this.lowestLine):(this.name=void 0,this.lowestLine=N.lowestLines.treble,this.lowestLineTrebleOffset=0),void 0===b?this.octaveChange=0:(this.octaveChange=b,this.lowestLine=this.lowestLine+7*b,this.lowestLineTrebleOffset=this.lowestLineTrebleOffset-7*b)},N.Clef.prototype=new s.Music21Object,N.Clef.prototype.constructor=N.Clef,N.Clef.prototype.convertPitchToTreble=function(a){if(void 0==this.lowestLine)return console.log("no first line defined for clef",this.name,this),a;var b=this.lowestLineTrebleOffset,c=new H.Pitch(a.step);return c.octave=a.octave,c.diatonicNoteNum+=b,c.accidental=a.accidental,c},N.TrebleClef=function(){N.Clef.call(this,"treble"),this.classes.push("TrebleClef")},N.TrebleClef.prototype=new N.Clef,N.TrebleClef.prototype.constructor=N.TrebleClef,N.Treble8vbClef=function(){N.Clef.call(this,"treble",-1),this.classes.push("Treble8vbClef")},N.Treble8vbClef.prototype=new N.Clef,N.Treble8vbClef.prototype.constructor=N.Treble8vbClef,N.Treble8vaClef=function(){N.Clef.call(this,"treble",1),this.classes.push("Treble8vaClef")},N.Treble8vaClef.prototype=new N.Clef,N.Treble8vaClef.prototype.constructor=N.Treble8vaClef,N.BassClef=function(){N.Clef.call(this,"bass"),this.classes.push("BassClef")},N.BassClef.prototype=new N.Clef,N.BassClef.prototype.constructor=N.BassClef,N.AltoClef=function(){N.Clef.call(this,"alto"),this.classes.push("AltoClef")},N.AltoClef.prototype=new N.Clef,N.AltoClef.prototype.constructor=N.AltoClef,N.TenorClef=function(){N.Clef.call(this,"tenor"),this.classes.push("TenorClef")},N.TenorClef.prototype=new N.Clef,N.TenorClef.prototype.constructor=N.TenorClef,N.SopranoClef=function(){N.Clef.call(this,"soprano"),this.classes.push("SopranoClef")},N.SopranoClef.prototype=new N.Clef,N.SopranoClef.prototype.constructor=N.SopranoClef,N.MezzoSopranoClef=function(){N.Clef.call(this,"mezzo-soprano"),this.classes.push("MezzoSopranoClef")},N.MezzoSopranoClef.prototype=new N.Clef,N.MezzoSopranoClef.prototype.constructor=N.MezzoSopranoClef,N.PercussionClef=function(){N.Clef.call(this,"percussion"),this.classes.push("PercussionClef")},N.PercussionClef.prototype=new N.Clef,N.PercussionClef.prototype.constructor=N.PercussionClef,N.bestClef=function(a){for(var b=a.flat,c=0,d=0,e=0;e<b.length;e++){var f=b.get(e);if(void 0!=f.pitch)c+=1,d+=f.pitch.diatonicNoteNum;else if(void 0!=f.pitches)for(var g=0;g<f.pitches.length;g++)c+=1,d+=f.pitches[g].diatonicNoteNum}var h=void 0;return h=0==c?29:d/c,h>28?new N.TrebleClef:new N.BassClef},N.tests=function(){test("music21.clef.Clef",function(){var a=new music21.clef.Clef;equal(a.isClassOrSubclass("Clef"),!0,"clef is a Clef");var b=new music21.clef.AltoClef;equal(b.lowestLine,25,"first line set");var c=new music21.note.Note("C#4");c.setStemDirectionFromClef(b),equal(c.stemDirection,"down","stem direction set"),c.pitch.diatonicNoteNum-=1,c.setStemDirectionFromClef(b),equal(c.stemDirection,"up","stem direction set"),c.pitch.diatonicNoteNum+=1;var d=b.convertPitchToTreble(c.pitch);equal(d.nameWithOctave,"B#4","converted to treble")}),test("music21.clef.Clef 8va",function(){var a=new music21.clef.Treble8vaClef;equal(a.lowestLine,38,"first line set");var b=new music21.note.Note("C#5");b.setStemDirectionFromClef(a),equal(b.stemDirection,"up","stem direction set");var c=a.convertPitchToTreble(b.pitch);equal(c.nameWithOctave,"C#4","converted to treble");var d=new music21.stream.Stream;d.clef=a,d.append(b),d.appendNewCanvas($("body"))})};var O={};O.shortNames=["pppppp","ppppp","pppp","ppp","pp","p","mp","mf","f","fp","sf","ff","fff","ffff","fffff","ffffff"],O.longNames={ppp:["pianississimo"],pp:["pianissimo"],p:["piano"],mp:["mezzopiano"],mf:["mezzoforte"],f:["forte"],fp:["fortepiano"],sf:["sforzando"],ff:["fortissimo"],fff:["fortississimo"]},O.englishNames={ppp:["extremely soft"],pp:["very soft"],p:["soft"],mp:["moderately soft"],mf:["moderately loud"],f:["loud"],ff:["very loud"],fff:["extremely loud"]},O.dynamicStrToScalar={None:[.5],n:[0],pppp:[.1],ppp:[.15],pp:[.25],p:[.35],mp:[.45],mf:[.55],f:[.7],fp:[.75],sf:[.85],ff:[.85],fff:[.9],ffff:[.95]},O.Dynamic=function(a){s.Music21Object.call(this),this.classes.push("Dynamic"),this._value=void 0,this._volumeScalar=void 0,this.longName=void 0,this.englishName=void 0,Object.defineProperties(this,{value:{get:function(){return this._value},set:function(a){"string"!=typeof a?(this._volumeScalar=a,a<=0?this._value="n":a<.11?this._value="pppp":a<.16?this._value="ppp":a<.26?this._value="pp":a<.36?this._value="p":a<.5?this._value="mp":a<.65?this._value="mf":a<.8?this._value="f":a<.9?this._value="ff":this._value="fff"):(this._value=a,this._volumeScalar=void 0),this._value in O.longNames?this.longName=O.longNames[this._value][0]:this.longName=void 0,this._value in O.englishNames?this.englishName=O.englishNames[this._value][0]:this.englishName=void 0}},volumeScalar:{get:function(){return void 0!==this._volumeScalar?this._volumeScalar:this._value in O.dynamicStrToScalar?O.dynamicStrToScalar[this._value][0]:void 0},set:function(a){"number"==typeof a&&a<=1&&a>=0&&(this._volumeScalar=a)}}}),this.value=a},O.Dynamic.prototype=new s.Music21Object,O.Dynamic.prototype.constructor=O.Dynamic,O.tests=function(){test("music21.dynamics.Dynamic",function(){var a=new music21.dynamics.Dynamic("pp");equal(a.value,"pp","matching dynamic"),a=new music21.dynamics.Dynamic(.98),equal(a.value,"fff","number conversion successful"),equal(a.volumeScalar,.98,"correct volume"),equal(a.longName,"fortississimo","matching long name"),equal(a.englishName,"extremely loud","matching english names"),a=new music21.dynamics.Dynamic("other"),equal(a.value,"other","record non standard dynamic"),equal(a.longName,void 0,"no long name for non standard dynamic"),equal(a.englishName,void 0,"no english name for non standard dynamic"),a.value=.18,equal(a.value,"pp","change in dynamic"),equal(a.volumeScalar,.18,"change in volume"),a.value="other",equal(a.value,"other","change to non standard"),equal(a.longName,void 0,"change to non standard dynamic"),equal(a.englishName,void 0,"change to non standard dynamic")})};var P={};P.Expression=function(){s.Music21Object.call(this),this.classes.push("Expression"),this.name="expression",this.vexflowModifier="",this.setPosition=void 0},P.Expression.prototype=new s.Music21Object,P.Expression.prototype.constructor=P.Expression,P.Expression.prototype.vexflow=function(){var a=new Vex.Flow.Articulation(this.vexflowModifier);return this.setPosition&&a.setPosition(this.setPosition),a},P.Fermata=function(){P.Expression.call(this),this.classes.push("Fermata"),this.name="fermata",this.vexflowModifier="a@a",this.setPosition=3},P.Fermata.prototype=new P.Expression,P.Fermata.prototype.constructor=P.Fermata;var Q=jsonpickle,R=Q.unpickler,S={};S.Converter=function(){this.debug=!0,this.knownUnparsables=["music21.spanner.Line","music21.instrument.Instrument","music21.layout.StaffGroup","music21.layout.StaffLayout","music21.layout.SystemLayout","music21.layout.PageLayout","music21.expressions.TextExpression","music21.bar.Barline","music21.tempo.MetronomeMark","music21.metadata.Metadata"];var a=this;this.streamPostRestore=function(b){var c=a,d=b._storedElementOffsetTuples;b._clef=c.lastClef,b._keySignature=c.lastKeySignature,b._timeSignature=c.lastTimeSignature;for(var e=0;e<d.length;e++){var f=d[e][0];f.offset=d[e][1];var g=f.classes;void 0===g&&(console.warn("M21object without classes: ",f),console.warn("Javascript classes are: ",f._py_class),g=[]);var h=c.currentPart;void 0==h&&(h=b);for(var i=!0,j=!1,k=0;k<g.length;k++){for(var l=g[k],m=0;m<c.knownUnparsables.length;m++){var n=c.knownUnparsables[m];n.indexOf(l)!=-1&&(i=!1)}"TimeSignature"==l?(b._timeSignature=f,c.lastTimeSignature=f,void 0!==h&&void 0===h.timeSignature&&(h.timeSignature=f),i=!1):"Clef"==l?(b._clef=f,c.lastClef=f,void 0!==h&&void 0===h.clef&&(h.clef=f),i=!1):"KeySignature"==l?(b._keySignature=f,this.lastKeySignature=f,void 0!==h&&void 0===h.keySignature&&(h.keySignature=f),i=!1):"Part"==l&&(i=!1,j=!0)}i?b.append(f):j&&b.insert(0,f)}return b},this.handlers={"music21.duration.Duration":{post_restore:function(a){return a.quarterLength=a._qtrLength,a}},"music21.meter.TimeSignature":{post_restore:function(a){return a._numerator=a.displaySequence._numerator,a._denominator=a.displaySequence._denominator,a}},"music21.stream.Part":{post_restore:function(b){return a.currentPart=b,a.lastClef=void 0,a.lastKeySignature=void 0,a.lastTimeSignature=void 0,a.streamPostRestore(b),b}},"music21.stream.Score":{post_restore:a.streamPostRestore},"music21.stream.Stream":{post_restore:a.streamPostRestore},"music21.stream.Measure":{post_restore:a.streamPostRestore},"music21.stream.Voice":{post_restore:a.streamPostRestore}},this.currentPart=void 0,this.lastClef=void 0,this.lastKeySignature=void 0,this.lastTimeSignature=void 0},S.Converter.prototype.run=function(a){var b=R.decode(a,this.handlers);return b.stream};var T={};T.Instrument=function(a){return s.Music21Object.call(this),this.classSortOrder=-25,this.partId=void 0,this.partName=void 0,this.partAbbreviation=void 0,this.instrumentId=void 0,this.instrumentName=void 0,this.instrumentAbbreviation=void 0,this.midiProgram=void 0,this._midiChannel=void 0,this.lowestNote=void 0,this.highestNote=void 0,this.transpostion=void 0,this.inGMPercMap=!1,this.soundfontFn=void 0,void 0!==a&&T.find(a),this},T.Instrument.prototype=new s.Music21Object,T.Instrument.prototype.constructor=T.Instrument,T.Instrument.usedChannels=[],T.Instrument.maxMidi=16,T.Instrument.prototype.autoAssignMidiChannel=function(a){void 0===a&&(a=T.Instrument.usedChannels);var b=0;1==this.inGMPercMap&&(b=10);for(var c=b;c<T.Instrument.maxMidi;c++)if(!(c%16==10&&1!=this.inGMPercMap||void 0!==a[c]&&a[c]!==this.midiProgram))return a[c]=this.midiProgram,this.midiChannel=c,c},Object.defineProperties(T.Instrument.prototype,{oggSoundfont:{enumerable:!0,configurable:!0,get:function(){return this.soundfontFn+"-ogg.js"}},mp3Soundfont:{enumerable:!0,configurable:!0,get:function(){return this.soundfontFn+"-mp3.js"}},midiChannel:{enumerable:!0,configurable:!0,get:function(){return void 0===this._midiChannel&&this.autoAssignMidiChannel(),this._midiChannel},set:function(a){this._midiChannel=a}}}),T.info=[{fn:"acoustic_grand_piano",name:"Acoustic Grand Piano",midiNumber:0},{fn:"bright_acoustic_piano",name:"Bright Acoustic Piano",midiNumber:1},{fn:"electric_grand_piano",name:"Electric Grand Piano",midiNumber:2},{fn:"honkytonk_piano",name:"Honky-tonk Piano",midiNumber:3},{fn:"electric_piano_1",name:"Electric Piano 1",midiNumber:4},{fn:"electric_piano_2",name:"Electric Piano 2",midiNumber:5},{fn:"harpsichord",name:"Harpsichord",midiNumber:6},{fn:"clavinet",name:"Clavinet",midiNumber:7},{fn:"celesta",name:"Celesta",midiNumber:8},{fn:"glockenspiel",name:"Glockenspiel",midiNumber:9},{fn:"music_box",name:"Music Box",midiNumber:10},{fn:"vibraphone",name:"Vibraphone",midiNumber:11},{fn:"marimba",name:"Marimba",midiNumber:12},{fn:"xylophone",name:"Xylophone",midiNumber:13},{fn:"tubular_bells",name:"Tubular Bells",midiNumber:14},{fn:"dulcimer",name:"Dulcimer",midiNumber:15},{fn:"drawbar_organ",name:"Drawbar Organ",midiNumber:16},{fn:"percussive_organ",name:"Percussive Organ",midiNumber:17},{fn:"rock_organ",name:"Rock Organ",midiNumber:18},{fn:"church_organ",name:"Church Organ",midiNumber:19},{fn:"reed_organ",name:"Reed Organ",midiNumber:20},{fn:"accordion",name:"Accordion",midiNumber:21},{fn:"harmonica",name:"Harmonica",midiNumber:22},{fn:"tango_accordion",name:"Tango Accordion",midiNumber:23},{fn:"acoustic_guitar_nylon",name:"Acoustic Guitar (nylon)",midiNumber:24},{fn:"acoustic_guitar_steel",name:"Acoustic Guitar (steel)",midiNumber:25},{fn:"electric_guitar_jazz",name:"Electric Guitar (jazz)",midiNumber:26},{fn:"electric_guitar_clean",name:"Electric Guitar (clean)",midiNumber:27},{fn:"electric_guitar_muted",name:"Electric Guitar (muted)",midiNumber:28},{fn:"overdriven_guitar",name:"Overdriven Guitar",midiNumber:29},{fn:"distortion_guitar",name:"Distortion Guitar",midiNumber:30},{fn:"guitar_harmonics",name:"Guitar Harmonics",midiNumber:31},{fn:"acoustic_bass",name:"Acoustic Bass",midiNumber:32},{fn:"electric_bass_finger",name:"Electric Bass (finger)",midiNumber:33},{fn:"electric_bass_pick",name:"Electric Bass (pick)",midiNumber:34},{fn:"fretless_bass",name:"Fretless Bass",midiNumber:35},{fn:"slap_bass_1",name:"Slap Bass 1",midiNumber:36},{fn:"slap_bass_2",name:"Slap Bass 2",midiNumber:37},{fn:"synth_bass_1",name:"Synth Bass 1",midiNumber:38},{fn:"synth_bass_2",name:"Synth Bass 2",midiNumber:39},{fn:"violin",name:"Violin",midiNumber:40},{fn:"viola",name:"Viola",midiNumber:41},{fn:"cello",name:"Cello",midiNumber:42},{fn:"contrabass",name:"Contrabass",midiNumber:43},{fn:"tremolo_strings",name:"Tremolo Strings",midiNumber:44},{fn:"pizzicato_strings",name:"Pizzicato Strings",midiNumber:45},{fn:"orchestral_harp",name:"Orchestral Harp",midiNumber:46},{fn:"timpani",name:"Timpani",midiNumber:47},{fn:"string_ensemble_1",name:"String Ensemble 1",midiNumber:48},{fn:"string_ensemble_2",name:"String Ensemble 2",midiNumber:49},{fn:"synth_strings_1",name:"Synth Strings 1",midiNumber:50},{fn:"synth_strings_2",name:"Synth Strings 2",midiNumber:51},{fn:"choir_aahs",name:"Choir Aahs",midiNumber:52},{fn:"voice_oohs",name:"Voice Oohs",midiNumber:53},{fn:"synth_choir",name:"Synth Choir",midiNumber:54},{fn:"orchestra_hit",name:"Orchestra Hit",midiNumber:55},{fn:"trumpet",name:"Trumpet",midiNumber:56},{fn:"trombone",name:"Trombone",midiNumber:57},{fn:"tuba",name:"Tuba",midiNumber:58},{fn:"muted_trumpet",name:"Muted Trumpet",midiNumber:59},{fn:"french_horn",name:"French Horn",midiNumber:60},{fn:"brass_section",name:"Brass Section",midiNumber:61},{fn:"synth_brass_1",name:"Synth Brass 1",midiNumber:62},{fn:"synth_brass_2",name:"Synth Brass 2",midiNumber:63},{fn:"soprano_sax",name:"Soprano Sax",midiNumber:64},{fn:"alto_sax",name:"Alto Sax",midiNumber:65},{fn:"tenor_sax",name:"Tenor Sax",midiNumber:66},{fn:"baritone_sax",name:"Baritone Sax",midiNumber:67},{fn:"oboe",name:"Oboe",midiNumber:68},{fn:"english_horn",name:"English Horn",midiNumber:69},{fn:"bassoon",name:"Bassoon",midiNumber:70},{fn:"clarinet",name:"Clarinet",midiNumber:71},{fn:"piccolo",name:"Piccolo",midiNumber:72},{fn:"flute",name:"Flute",midiNumber:73},{fn:"recorder",name:"Recorder",midiNumber:74},{fn:"pan_flute",name:"Pan Flute",midiNumber:75},{fn:"blown_bottle",name:"Blown bottle",midiNumber:76},{fn:"shakuhachi",name:"Shakuhachi",midiNumber:77},{fn:"whistle",name:"Whistle",midiNumber:78},{fn:"ocarina",name:"Ocarina",midiNumber:79},{fn:"lead_1_square",name:"Lead 1 (square)",midiNumber:80},{fn:"lead_2_sawtooth",name:"Lead 2 (sawtooth)",midiNumber:81},{fn:"lead_3_calliope",name:"Lead 3 (calliope)",midiNumber:82},{fn:"lead_4_chiff",name:"Lead 4 chiff",midiNumber:83},{fn:"lead_5_charang",name:"Lead 5 (charang)",midiNumber:84},{fn:"lead_6_voice",name:"Lead 6 (voice)",midiNumber:85},{fn:"lead_7_fifths",name:"Lead 7 (fifths)",midiNumber:86},{fn:"lead_8_bass__lead",name:"Lead 8 (bass + lead)",midiNumber:87},{fn:"pad_1_new_age",name:"Pad 1 (new age)",midiNumber:88},{fn:"pad_2_warm",name:"Pad 2 (warm)",midiNumber:89},{fn:"pad_3_polysynth",name:"Pad 3 (polysynth)",midiNumber:90},{fn:"pad_4_choir",name:"Pad 4 (choir)",midiNumber:91},{fn:"pad_5_bowed",name:"Pad 5 (bowed)",midiNumber:92},{fn:"pad_6_metallic",name:"Pad 6 (metallic)",midiNumber:93},{fn:"pad_7_halo",name:"Pad 7 (halo)",midiNumber:94},{fn:"pad_8_sweep",name:"Pad 8 (sweep)",midiNumber:95},{fn:"fx_1_rain",name:"FX 1 (rain)",midiNumber:96},{fn:"fx_2_soundtrack",name:"FX 2 (soundtrack)",midiNumber:97},{fn:"fx_3_crystal",name:"FX 3 (crystal)",midiNumber:98},{fn:"fx_4_atmosphere",name:"FX 4 (atmosphere)",midiNumber:99},{fn:"fx_5_brightness",name:"FX 5 (brightness)",midiNumber:100},{fn:"fx_6_goblins",name:"FX 6 (goblins)",midiNumber:101},{fn:"fx_7_echoes",name:"FX 7 (echoes)",midiNumber:102},{fn:"fx_8_scifi",name:"FX 8 (sci-fi)",midiNumber:103},{fn:"sitar",name:"Sitar",midiNumber:104},{fn:"banjo",name:"Banjo",midiNumber:105},{fn:"shamisen",name:"Shamisen",midiNumber:106},{fn:"koto",name:"Koto",midiNumber:107},{fn:"kalimba",name:"Kalimba",midiNumber:108},{fn:"bagpipe",name:"Bagpipe",midiNumber:109},{fn:"fiddle",name:"Fiddle",midiNumber:110},{fn:"shanai",name:"Shanai",midiNumber:111},{fn:"tinkle_bell",name:"Tinkle Bell",midiNumber:112},{fn:"agogo",name:"Agogo",midiNumber:113},{fn:"steel_drums",name:"Steel Drums",midiNumber:114},{fn:"woodblock",name:"Woodblock",midiNumber:115},{fn:"taiko_drum",name:"Taiko Drum",midiNumber:116},{fn:"melodic_tom",name:"Melodic Tom",midiNumber:117},{fn:"synth_drum",name:"Synth Drum",midiNumber:118},{fn:"reverse_cymbal",name:"Reverse Cymbal",midiNumber:119},{fn:"guitar_fret_noise",name:"Guitar Fret Noise",midiNumber:120},{fn:"breath_noise",name:"Breath Noise",midiNumber:121},{fn:"seashore",name:"Seashore",midiNumber:122},{fn:"bird_tweet",name:"Bird Tweet",midiNumber:123},{fn:"telephone_ring",name:"Telephone Ring",midiNumber:124},{fn:"helicopter",name:"Helicopter",midiNumber:125},{fn:"applause",name:"Applause",midiNumber:126},{fn:"gunshot",name:"Gunshot",midiNumber:127}],T.find=function(a,b){void 0===b&&(b=new T.Instrument);for(var c=0;c<T.info.length;c++){var d=T.info[c];if(d.fn==a||d.name==a)return b.soundfontFn=d.fn,b.instrumentName=d.name,b.midiProgram=d.midiNumber,b}};var U={};U.IntervalDirections={DESCENDING:-1,OBLIQUE:0,ASCENDING:1},U.IntervalDirectionTerms=["Descending","Oblique","Ascending"],U.MusicOrdinals=[void 0,"Unison","Second","Third","Fourth","Fifth","Sixth","Seventh","Octave","Ninth","Tenth","Eleventh","Twelfth","Thirteenth","Fourteenth","Double Octave"],U.GenericInterval=function(a){q.ProtoM21Object.call(this),this.classes.push("GenericInterval"),void 0===a&&(a=1),this.value=a,this.directed=this.value,this.undirected=Math.abs(this.value),1==this.directed?this.direction=U.IntervalDirections.OBLIQUE:this.directed<0?this.direction=U.IntervalDirections.DESCENDING:this.directed>1&&(this.direction=U.IntervalDirections.ASCENDING),this.undirected>2?this.isSkip=!0:this.isSkip=!1,2==this.undirected?this.isDiatonicStep=!0:this.isDiatonicStep=!1,this.isStep=this.isDiatonicStep,1==this.undirected?this.isUnison=!0:this.isUnison=!1;var b=this.undirected%7,c=parseInt(this.undirected/7);0===b&&(c-=1,b=7),this.simpleUndirected=b,this.undirectedOctaves=c,1==b&&c>=1?this.semiSimpleUndirected=8:this.semiSimpleUndirected=this.simpleUndirected,this.direction==U.IntervalDirections.DESCENDING?(this.octaves=-1*c,1!=b?this.simpleDirected=-1*b:this.simpleDirected=1,this.semiSimpleDirected=-1*this.semiSimpleUndirected):(this.octaves=c,this.simpleDirected=b,this.semiSimpleDirected=this.semiSimpleUndirected),1==this.simpleUndirected||4==this.simpleUndirected||5==this.simpleUndirected?this.perfectable=!0:this.perfectable=!1,this.undirected<U.MusicOrdinals.length?this.niceName=U.MusicOrdinals[this.undirected]:this.niceName=this.undirected.toString(),this.simpleNiceName=U.MusicOrdinals[this.simpleUndirected],this.semiSimpleNiceName=U.MusicOrdinals[this.semiSimpleUndirected],1==Math.abs(this.directed)?this.staffDistance=0:this.directed>1?this.staffDistance=this.directed-1:this.directed<-1&&(this.staffDistance=this.directed+1),this.mod7inversion=9-this.semiSimpleUndirected,this.direction==U.IntervalDirections.DESCENDING?this.mod7=this.mod7inversion:this.mod7=this.simpleDirected},U.GenericInterval.prototype=new q.ProtoM21Object,U.GenericInterval.prototype.constructor=U.GenericInterval,U.GenericInterval.prototype.complement=function(){return new U.GenericInterval(this.mod7inversion)},U.GenericInterval.prototype.reverse=function(){return 1==this.undirected?new U.GenericInterval(1):new U.GenericInterval(this.undirected*(-1*this.direction))},U.GenericInterval.prototype.getDiatonic=function(a){return new U.DiatonicInterval(a,this)},U.GenericInterval.prototype.transposePitch=function(a){var b=new H.Pitch;b.step=a.step,b.octave=a.octave;var c=a.diatonicNoteNum,d=this.staffDistance,e=c+d,f=U.IntervalConvertDiatonicNumberToStep(e);return b.step=f[0],b.octave=f[1],void 0!==a.accidental&&(b.accidental=new music21.pitch.Accidental(a.accidental.name)),b},U.IntervalSpecifiersEnum={PERFECT:1,MAJOR:2,MINOR:3,AUGMENTED:4,DIMINISHED:5,DBLAUG:6,DBLDIM:7,TRPAUG:8,TRPDIM:9,QUADAUG:10,QUADDIM:11},U.IntervalNiceSpecNames=["ERROR","Perfect","Major","Minor","Augmented","Diminished","Doubly-Augmented","Doubly-Diminished","Triply-Augmented","Triply-Diminished","Quadruply-Augmented","Quadruply-Diminished"],U.IntervalPrefixSpecs=[void 0,"P","M","m","A","d","AA","dd","AAA","ddd","AAAA","dddd"],U.IntervalOrderedPerfSpecs=["dddd","ddd","dd","d","P","A","AA","AAA","AAAA"],U.IntervalPerfSpecifiers=[U.IntervalSpecifiersEnum.QUADDMIN,U.IntervalSpecifiersEnum.TRPDIM,U.IntervalSpecifiersEnum.DBLDIM,U.IntervalSpecifiersEnum.DIMINISHED,U.IntervalSpecifiersEnum.PERFECT,U.IntervalSpecifiersEnum.AUGMENTED,U.IntervalSpecifiersEnum.DBLAUG,U.IntervalSpecifiersEnum.TRPAUG,U.IntervalSpecifiersEnum.QUADAUG],U.IntervalPerfOffset=4,U.IntervalOrderedImperfSpecs=["dddd","ddd","dd","d","m","M","A","AA","AAA","AAAA"],U.IntervalSpecifiers=[U.IntervalSpecifiersEnum.QUADDMIN,U.IntervalSpecifiersEnum.TRPDIM,U.IntervalSpecifiersEnum.DBLDIM,U.IntervalSpecifiersEnum.DIMINISHED,U.IntervalSpecifiersEnum.MINOR,U.IntervalSpecifiersEnum.MAJOR,U.IntervalSpecifiersEnum.AUGMENTED,U.IntervalSpecifiersEnum.DBLAUG,U.IntervalSpecifiersEnum.TRPAUG,U.IntervalSpecifiersEnum.QUADAUG],U.IntervalMajOffset=5,U.IntervalSemitonesGeneric={1:0,2:2,3:4,4:5,5:7,6:9,7:11},U.IntervalAdjustPerfect={P:0,A:1,AA:2,AAA:3,AAAA:4,d:-1,dd:-2,ddd:-3,dddd:-4},U.IntervalAdjustImperf={M:0,m:-1,A:1,AA:2,AAA:3,AAAA:4,d:-2,dd:-3,ddd:-4,dddd:-5},U.DiatonicInterval=function(a,b){q.ProtoM21Object.call(this),this.classes.push("DiatonicInterval"),void 0===a&&(a="P"),void 0===b?b=new U.GenericInterval(1):"number"==typeof b&&(b=new U.GenericInterval(b)),this.name="","number"==typeof a?this.specifier=a:this.specifier=U.IntervalPrefixSpecs.indexOf(a),this.generic=b,1!=b.undirected||a==U.IntervalSpecifiersEnum.PERFECT?this.direction=b.direction:U.IntervalPerfSpecifiers.indexOf(a)<=U.IntervalPerfSpecifiers.indexOf(U.IntervalSpecifiersEnum.DIMINISHED)?this.direction=U.IntervalDirections.DESCENDING:this.direction=U.IntervalDirections.ASCENDING;var c=U.IntervalDirectionTerms[this.direction+1];this.name=U.IntervalPrefixSpecs[this.specifier]+b.undirected.toString(),this.niceName=U.IntervalNiceSpecNames[this.specifier]+" "+b.niceName,this.simpleName=U.IntervalPrefixSpecs[this.specifier]+b.simpleUndirected.toString(),this.simpleNiceName=U.IntervalNiceSpecNames[this.specifier]+" "+b.simpleNiceName,this.semiSimpleName=U.IntervalPrefixSpecs[this.specifier]+b.semiSimpleUndirected.toString(),this.semiSimpleNiceName=U.IntervalNiceSpecNames[this.specifier]+" "+b.semiSimpleNiceName,this.directedName=U.IntervalPrefixSpecs[this.specifier]+b.directed.toString(),this.directedNiceName=c+" "+this.niceName,this.directedSimpleName=U.IntervalPrefixSpecs[this.specifier]+b.simpleDirected.toString(),this.directedSimpleNiceName=c+" "+this.simpleNiceName,this.directedSemiSimpleName=U.IntervalPrefixSpecs[this.specifier]+b.semiSimpleDirected.toString(),this.directedSemiSimpleNiceName=c+" "+this.semiSimpleNameName,this.specificName=U.IntervalNiceSpecNames[this.specifier],this.perfectable=b.perfectable,this.isDiatonicStep=b.isDiatonicStep,this.isStep=b.isStep,this.perfectable?(this.orderedSpecifierIndex=U.IntervalOrderedPerfSpecs.indexOf(U.IntervalPrefixSpecs[this.specifier]),this.invertedOrderedSpecIndex=U.IntervalOrderedPerfSpecs.length-1-this.orderedSpecifierIndex,this.invertedOrderedSpecifier=U.IntervalOrderedPerfSpecs[this.invertedOrderedSpecIndex]):(this.orderedSpecifierIndex=U.IntervalOrderedImperfSpecs.indexOf(U.IntervalPrefixSpecs[this.specifier]),
this.invertedOrderedSpecIndex=U.IntervalOrderedImperfSpecs.length-1-this.orderedSpecifierIndex,this.invertedOrderedSpecifier=U.IntervalOrderedImperfSpecs[this.invertedOrderedSpecIndex]),this.mod7inversion=this.invertedOrderedSpecifier+b.mod7inversion.toString()},U.DiatonicInterval.prototype=new q.ProtoM21Object,U.DiatonicInterval.prototype.constructor=U.DiatonicInterval,U.DiatonicInterval.prototype.getChromatic=function(){var a=Math.floor(Math.abs(this.generic.staffDistance)/7),b=U.IntervalSemitonesGeneric[this.generic.simpleUndirected],c=U.IntervalPrefixSpecs[this.specifier],d=0;d=this.generic.perfectable?U.IntervalAdjustPerfect[c]:U.IntervalAdjustImperf[c];var e=12*a+b+d;return this.generic.direction==U.IntervalDirections.DESCENDING&&(e*=-1),music21.debug&&(console.log("DiatonicInterval.getChromatic -- octaveOffset: "+a),console.log("DiatonicInterval.getChromatic -- semitonesStart: "+b),console.log("DiatonicInterval.getChromatic -- specName: "+c),console.log("DiatonicInterval.getChromatic -- semitonesAdjust: "+d),console.log("DiatonicInterval.getChromatic -- semitones: "+e)),new U.ChromaticInterval(e)},U.ChromaticInterval=function(a){q.ProtoM21Object.call(this),this.classes.push("ChromaticInterval"),this.semitones=a,this.cents=Math.round(100*a,5),this.directed=a,this.undirected=Math.abs(a),0===this.directed?this.direction=U.IntervalDirections.OBLIQUE:this.directed==this.undirected?this.direction=U.IntervalDirections.ASCENDING:this.direction=U.IntervalDirections.DESCENDING,this.mod12=this.semitones%12,this.simpleUndirected=this.undirected%12,this.direction==U.IntervalDirections.DESCENDING?this.simpleDirected=-1*this.simpleUndirected:this.simpleDirected=this.simpleUndirected,this.intervalClass=this.mod12,this.mod12>6&&(this.intervalClass=12-this.mod12),1==this.undirected?this.isChromaticStep=!0:this.isChromaticStep=!1},U.ChromaticInterval.prototype=new q.ProtoM21Object,U.ChromaticInterval.prototype.constructor=U.ChromaticInterval,U.ChromaticInterval.prototype.reverse=function(){return new U.ChromaticInterval(this.undirected*(-1*this.direction))},U.ChromaticInterval.prototype.transposePitch=function(a){var b=!1;void 0===a.octave&&(b=!0);var c=a.ps;return newPitch=new H.Pitch,newPitch.ps=c+this.semitones,b&&(newPitch.octave=void 0),newPitch},U.IntervalStepNames=["C","D","E","F","G","A","B"],U.IntervalConvertDiatonicNumberToStep=function(a){var b=void 0,c=void 0;if(0===a)return["B",-1];a>0?(c=Math.floor((a-1)/7),b=a-1-7*c):(c=Math.floor(a/7),b=a-1-7*(c+1));var d=U.IntervalStepNames[b];return[d,c]},U.Interval=function(){if(q.ProtoM21Object.call(this),this.classes.push("Interval"),1==arguments.length){var a=arguments[0];if("string"==typeof a){var b=a.slice(0,1),c=parseInt(a.slice(1)),d=new U.GenericInterval(c),e=new U.DiatonicInterval(b,d);this.diatonic=e,this.chromatic=this.diatonic.getChromatic()}else void 0!==a.specifier?(this.diatonic=a,this.chromatic=this.diatonic.getChromatic()):console.error("cant parse string arguments to Interval yet")}else if(2==arguments.length)if(void 0===arguments[0].pitch&&void 0===arguments[0].diatonicNoteNum)this.diatonic=arguments[0],this.chromatic=arguments[1];else{var f=arguments[0],g=arguments[1],h=U.notesToGeneric(f,g),i=U.notesToChromatic(f,g);this.diatonic=U.intervalsToDiatonic(h,i),this.chromatic=i}this.reinit(),Object.defineProperties(this,{complement:{enumerable:!0,get:function(){return new U.Interval(this.diatonic.mod7inversion)}}})},U.Interval.prototype=new q.ProtoM21Object,U.Interval.prototype.constructor=U.Interval,U.Interval.prototype.reinit=function(){this.direction=this.chromatic.direction,this.specifier=this.diatonic.specifier,this.diatonicType=this.diatonic.specifier,this.generic=this.diatonic.generic,this.name=this.diatonic.name,this.niceName=this.diatonic.niceName,this.simpleName=this.diatonic.simpleName,this.simpleNiceName=this.diatonic.simpleNiceName,this.semiSimpleName=this.diatonic.semiSimpleName,this.semiSimpleNiceName=this.diatonic.semiSimpleNiceName,this.directedName=this.diatonic.directedName,this.directedNiceName=this.diatonic.directedNiceName,this.directedSimpleName=this.diatonic.directedSimpleName,this.directedSimpleNiceName=this.diatonic.directedSimpleNiceName,this.isDiatonicStep=this.diatonic.isDiatonicStep,this.isChromaticStep=this.chromatic.isChromaticStep,this.semitones=this.chromatic.semitones,this.intervalClass=this.chromatic.intervalClass,this.cents=this.chromatic.cents,this.isStep=this.isChromaticStep||this.isDiatonicStep},U.Interval.prototype.isConsonant=function(){var a=this.simpleName;return"P5"==a||"m3"==a||"M3"==a||"m6"==a||"M6"==a||"P1"==a},U.Interval.prototype.transposePitch=function(a){var b=this.diatonic.generic.transposePitch(a);b.accidental=void 0;var c=this.chromatic.semitones-parseInt(b.ps-a.ps);return 0!==c&&(b.accidental=new H.Accidental(c)),music21.debug&&(console.log("Interval.transposePitch -- distance to move"+distanceToMove),console.log("Interval.transposePitch -- old diatonic num"+oldDiatonicNum),console.log("Interval.transposePitch -- new step "+b.step),console.log("Interval.transposePitch -- new diatonic number "+newDiatonicNumber),console.log("Interval.transposePitch -- new octave "+b.octave),console.log("Interval.transposePitch -- fixing halfsteps for "+c)),b},U.notesToGeneric=function(a,b){var c=a;void 0!==a.pitch&&(c=a.pitch);var d=b;void 0!==b.pitch&&(d=b.pitch);var e=d.diatonicNoteNum-c.diatonicNoteNum,f=U.convertStaffDistanceToInterval(e);return new U.GenericInterval(f)},U.convertStaffDistanceToInterval=function(a){return 0===a?1:a>0?a+1:a-1},U.notesToChromatic=function(a,b){var c=a;void 0!==a.pitch&&(c=a.pitch);var d=b;return void 0!==b.pitch&&(d=b.pitch),new U.ChromaticInterval(d.ps-c.ps)},U.intervalsToDiatonic=function(a,b){var c=U._getSpecifierFromGenericChromatic(a,b);return new U.DiatonicInterval(c,a)},U._getSpecifierFromGenericChromatic=function(a,b){var c=[void 0,0,2,4,5,7,9,11],d=c[a.simpleUndirected]+12*a.undirectedOctaves,e=0;e=a.direction!=b.direction&&a.direction!=U.IntervalDirections.OBLIQUE&&b.direction!=U.IntervalDirections.OBLIQUE?-1*b.undirected:1==a.undirected?b.directed:b.undirected;var f=Math.round(e),g="";return g=a.perfectable?U.IntervalPerfSpecifiers[U.IntervalPerfOffset+f-d]:U.IntervalSpecifiers[U.IntervalMajOffset+f-d]};var V={};V.SimpleDiatonicScale=function(a,b){if(void 0==a)a=new H.Pitch("C4");else if(!(a instanceof H.Pitch))throw"Cannot make a scale not from a music21.pitch.Pitch object: "+a;void 0==b&&(b=["M","M","m","M","M","M","m"]);for(var c=new U.GenericInterval(2),d=[a],e=a,f=0;f<b.length;f++){var g=new U.DiatonicInterval(b[f],c),h=new U.Interval(g),i=h.transposePitch(e);music21.debug&&console.log("ScaleSimpleMajor -- adding pitch: "+i.name),d.push(i),e=i}return d},V.ScaleSimpleMajor=function(a){var b=["M","M","m","M","M","M","m"];return new V.SimpleDiatonicScale(a,b)},V.ScaleSimpleMinor=function(a,b){var c=["M","m","M","M","m","M","M"];return"string"==typeof b&&(b=b.replace(/\s/g,"-")),"harmonic"==b||"harmonic-minor"==b?(c[5]="A",c[6]="m"):"melodic"!=b&&"melodic-ascending"!=b&&"melodic-minor"!=b&&"melodic-minor-ascending"!=b||(c[4]="M",c[6]="m"),new V.SimpleDiatonicScale(a,c)};var W={};W.modeSharpsAlter={major:0,minor:-3,dorian:-2,phrygian:-4,lydian:1,mixolydian:-1,locrian:-5},W.KeySignature=function(a){s.Music21Object.call(this),this.classes.push("KeySignature"),this._sharps=a||0,this._alteredPitchesCache=void 0,this.flatMapping=["C","F","B-","E-","A-","D-","G-","C-","F-","B--","E--","A--","D--"],this.sharpMapping=["C","G","D","A","E","B","F#","C#","G#","D#","A#","E#","B#"],Object.defineProperties(this,{sharps:{enumerable:!0,configurable:!0,get:function(){return this._sharps},set:function(a){this._alteredPitchesCache=[],this._sharps=a}},width:{enumerable:!0,configurable:!0,get:function(){return 5*Math.abs(this.sharps)}},alteredPitches:{get:function(){if(void 0!=this._alteredPitchesCache)return this._alteredPitchesCache;var a="P5",b="B";this.sharps<0&&(a="P4",b="F");for(var c=new U.Interval(a),d=[],e=new H.Pitch(b),f=0;f<Math.abs(this.sharps);f++)e=c.transposePitch(e),e.octave=4,d.push(e);return this._alteredPitchesCache=d,d}}})},W.KeySignature.prototype=new s.Music21Object,W.KeySignature.prototype.constructor=W.KeySignature,W.KeySignature.prototype.majorName=function(){return this.sharps>=0?this.sharpMapping[this.sharps]:this.flatMapping[Math.abs(this.sharps)]},W.KeySignature.prototype.minorName=function(){var a=this.sharps+3;return a>=0?this.sharpMapping[a]:this.flatMapping[Math.abs(a)]},W.KeySignature.prototype.vexflow=function(){var a=this.majorName();return a.replace(/\-/g,"b")},W.KeySignature.prototype.accidentalByStep=function(a){for(var b=this.alteredPitches,c=0;c<b.length;c++)if(b[c].step==a){if(void 0==b[c].accidental)return;return new H.Accidental(b[c].accidental.alter)}},W.KeySignature.prototype.transposePitchFromC=function(a){var b=void 0,c=void 0;if(0==this.sharps)return new H.Pitch(a.nameWithOctave);this.sharps<0?(c=Math.abs(this.sharps),b=new U.Interval("P4")):(c=this.sharps,b=new U.Interval("P5"));for(var d=a,e=0;e<c;e++)d=b.transposePitch(d),e%2==1&&(d.octave=d.octave-1);return d},W.Key=function(a,b){if(void 0==a&&(a="C"),void 0==b){var c=a.toLowerCase();b=a==c?"minor":"major"}var d="A-- E-- B-- F- C- G- D- A- E- B- F C G D A E B F# C# G# D# A# E# B#".split(" "),e=d.indexOf(a.toUpperCase());if(e==-1)throw"Cannot find the key for "+a;var f=W.modeSharpsAlter[b]||0,g=e+f-11;music21.debug&&console.log("Found sharps "+g+" for key: "+a),W.KeySignature.call(this,g),this.tonic=a,this.mode=b},W.Key.prototype=new W.KeySignature,W.Key.prototype.constructor=W.Key,W.Key.prototype.getScale=function(a){void 0==a&&(a=this.mode);var b=new H.Pitch(this.tonic);return"major"==a?V.ScaleSimpleMajor(b):V.ScaleSimpleMinor(b,a)},W.tests=function(){test("music21.key.Key",function(){for(var a=[[0,"minor","a"],[0,"major","C"],[0,"major"],[6,"major","F#"],[3,"minor","f#"],[6,"major","f#","major"],[-2,"major","B-"],[-5,"minor","b-"]],b=0;b<a.length;b++){var c=a[b],d=c[0],e=c[1],f=c[2],g=c[3],h=new music21.key.Key(f,g),i=h.sharps,j=h.mode;equal(i,d,"Test sharps: "+f+" (mode: "+g+") "),equal(j,e,"Test mode: "+f+" (mode: "+g+") ")}var h=new music21.key.Key("f#"),k=h.getScale();equal(k[2].nameWithOctave,"A4","test minor scale"),equal(k[6].nameWithOctave,"E5"),k=h.getScale("major"),equal(k[2].nameWithOctave,"A#4","test major scale"),equal(k[6].nameWithOctave,"E#5"),k=h.getScale("harmonic minor"),equal(k[2].nameWithOctave,"A4","test harmonic minor scale"),equal(k[5].nameWithOctave,"D5"),equal(k[6].nameWithOctave,"E#5"),equal(h.width,15,"checking width is 5 * abs(sharps)")})};var X={};X.transposeOctave=0,X.Event=function(a,b,c,d){this.timing=a,this.data1=b,this.data2=c,this.data3=d,this.midiCommand=b>>4,this.noteOff=8==this.midiCommand,this.noteOn=9==this.midiCommand,this.midiNote=void 0,(this.noteOn||this.noteOff)&&(this.midiNote=this.data2+12*X.transposeOctave,this.velocity=this.data3)},X.Event.prototype.sendToMIDIjs=function(){void 0!==h?this.noteOn?h.noteOn(0,this.midiNote,this.velocity,0):this.noteOff&&h.noteOff(0,this.midiNote,0):console.warn("could not playback note because no MIDIout defined")},X.Event.prototype.music21Note=function(){var a=new L.Note;return a.pitch.ps=this.midiNote,a},X.maxDelay=100,X.heldChordTime=0,X.heldChordNotes=void 0,X.timeOfLastNote=Date.now(),X._baseTempo=60,X.metronome=void 0,Object.defineProperties(X,{tempo:{enumerable:!0,get:function(){return void 0===this.metronome?this._baseTempo:this.metronome.tempo},set:function(a){void 0===this.metronome?this._baseTempo=a:this.metronome.tempo=a}}}),X.clearOldChords=function(){var a=Date.now();X.heldChordTime+X.maxDelay<a&&(X.heldChordTime=a,void 0!==X.heldChordNotes&&(X.sendOutChord(X.heldChordNotes),X.heldChordNotes=void 0)),setTimeout(X.clearOldChords,X.maxDelay)},X.makeChords=function(a){if(a.noteOn){var b=a.music21Note();if(void 0===X.heldChordNotes)X.heldChordNotes=[b];else{for(var c=0;c<X.heldChordNotes.length;c++){var d=X.heldChordNotes[c];if(d.pitch.ps==b.pitch.ps)return}X.heldChordNotes.push(b)}}},X.lastElement=void 0,X.sendOutChord=function(a){var b=void 0;if(a.length>1)b=new M.Chord(a);else{if(1!=a.length)return;b=a[0]}return b.stemDirection="noStem",X.quantizeLastNote(),X.lastElement=b,void 0===music21.webmidi.callBacks.sendOutChord?b:void music21.webmidi.callBacks.sendOutChord(b)},X.quantizeLastNote=function(a){if(void 0!==a||(a=this.lastElement,void 0!==a)){a.stemDirection=void 0;var b=Date.now(),c=b-this.timeOfLastNote;this.timeOfLastNote=b;var d=6e4/this.tempo,e=c/d,f=Math.round(4*e)/4;return f>=4?f=4:f>=3?f=3:f>2?f=2:1.25==f?f=1:.75==f?f=.5:0===f&&(f=.125),a.duration.quarterLength=f,a}},X.sendToMIDIjs=function(a){a.sendToMIDIjs()},X.loadedSoundfonts={},X.postLoadCallback=function(a,b){music21.debug&&(console.log("soundfont loaded about to execute callback."),console.log("first playing two notes very softly -- seems to flush the buffer.")),e(".loadingSoundfont").remove();var c="undefined"!=typeof InstallTrigger,d="HTML Audio Tag"==h.technology,f=music21.instrument.find(a);if(void 0!==f&&(h.programChange(f.midiChannel,f.midiProgram),music21.debug&&console.log(a+" ("+f.midiProgram+") loaded on ",f.midiChannel),c===!1&&d===!1)){var g=f.midiChannel;h.noteOn(g,36,1,0),h.noteOff(g,36,1,.1),h.noteOn(g,48,1,.2),h.noteOff(g,48,1,.3),h.noteOn(g,60,1,.3),h.noteOff(g,60,1,.4)}void 0!==b&&b(f),X.loadedSoundfonts[a]=!0},X.loadSoundfont=function(a,b){if(X.loadedSoundfonts[a]===!0){if(void 0!==b){var c=music21.instrument.find(a);b(c)}}else"loading"==X.loadedSoundfonts[a]?!function(){var c=void 0;(c=function(){if(X.loadedSoundfonts[a]===!0){if(music21.debug&&console.log("other process has finished loading; calling callback"),void 0!==b){var d=music21.instrument.find(a);b(d)}}else music21.debug&&console.log("waiting for other process load"),setTimeout(c,100)})()}():(X.loadedSoundfonts[a]="loading",music21.debug&&console.log("waiting for document ready"),e(document).ready(function(){music21.debug&&console.log("document ready, waiting to load soundfont"),e(document.body).append(e("<div class='loadingSoundfont'><b>Loading MIDI Instrument</b>: audio will begin when this message disappears.</div>")),h.loadPlugin({soundfontUrl:music21.soundfontUrl,instrument:a,onsuccess:X.postLoadCallback.bind(h,a,b)})}))},X.MidiPlayer=function(){this.player=new music21.MIDI.Players.PlayInstance,this.speed=1,this.$playDiv=void 0},X.MidiPlayer.prototype.addPlayer=function(a){var b=a;void 0===a&&(a=document.body),void 0===a.jquery&&(b=e(a));var c=e('<div class="midiPlayer">'),d=e('<div class="positionControls">'),f=e('<input type="image" src="'+music21.m21basePath+'/css/play.png" align="absmiddle" value="play" class="playPause">'),g=e('<input type="image" src="'+music21.m21basePath+'/css/stop.png" align="absmiddle" value="stop" class="stopButton">');f.on("click",this.pausePlayStop.bind(this)),g.on("click",this.stopButton.bind(this)),d.append(f),d.append(g),c.append(d);var h=e('<div class="timeControls">'),i=e('<span class="timePlayed">0:00</span>'),j=e('<span class="capsule"><span class="cursor"></span></span>'),k=e('<span class="timeRemaining">-0:00</span>');return h.append(i),h.append(j),h.append(k),c.append(h),b.append(c),this.$playDiv=c,c},X.MidiPlayer.prototype.stopButton=function(){this.pausePlayStop("yes")},X.MidiPlayer.prototype.pausePlayStop=function(a){var b=void 0;b=void 0===this.$playDiv?{src:"doesnt matter"}:this.$playDiv.find(".playPause")[0],"yes"==a?(this.player.stop(),b.src=music21.m21basePath+"/css/play.png"):this.player.playing||"pause"==a?(b.src=music21.m21basePath+"/css/play.png",this.player.pause(!0)):(b.src=music21.m21basePath+"/css/pause.png",this.player.resume())},X.MidiPlayer.prototype.base64Load=function(a){var b=this.player;b.timeWarp=this.speed;var c=this;X.loadSoundfont("acoustic_grand_piano",function(){b.loadFile(a,function(){c.fileLoaded()},void 0,function(a){console.log(a)})})},X.MidiPlayer.prototype.songFinished=function(){this.pausePlayStop("yes")},X.MidiPlayer.prototype.fileLoaded=function(){this.updatePlaying()},X.MidiPlayer.prototype.startAndUpdate=function(){this.player.start(),this.updatePlaying()},X.MidiPlayer.prototype.updatePlaying=function(){function a(a){var b=a/60>>0,c=String(a-60*b>>0);return 1==c.length&&(c="0"+c),b+":"+c}var b=this,c=this.player;if(void 0!==this.$playDiv){var d=this.$playDiv,e=d.find(".timePlayed")[0],f=d.find(".timeRemaining")[0],g=d.find(".cursor")[0],h=d.find(".capsule");eventjs.add(h[0],"drag",function(a,b){eventjs.cancel(a);var c=this.player;c.currentTime=b.x/420*c.endTime,c.currentTime<0&&(c.currentTime=0),c.currentTime>c.endTime&&(c.currentTime=c.endTime),"down"===b.state?this.pausePlayStop("pause"):"up"===b.state&&this.pausePlayStop("play")}.bind(this)),c.setAnimation(function(c){var d=c.now/c.end,h=c.now>>0,i=c.end>>0;h===i&&b.songFinished(),g.style.width=100*d+"%",e.innerHTML=a(h),f.innerHTML="-"+a(i-h)})}};var Y={};Y.Key=function(){this.classes=["Key"],this.callbacks=[],this.scaleFactor=1,this.parent=void 0,this.id=0,this.width=23,this.height=120,this.pitchObj=void 0,this.svgObj=void 0,this.noteNameSvgObj=void 0,this.keyStyle="",this.keyClass="",this.makeKey=function(a){keyattrs={style:this.keyStyle,x:a,y:0,class:"keyboardkey "+this.keyClass,id:this.id,width:this.width*this.scaleFactor,height:this.height*this.scaleFactor};var b=i.makeSVGright("rect",keyattrs);for(var c in this.callbacks)b.addEventListener(c,this.callbacks[c],!1);return this.svgObj=b,b},this.addCircle=function(a){if(void 0!==this.svgObj&&void 0!==this.parent&&void 0!==this.parent.svgObj){void 0===a&&(a="red");var b=parseInt(this.svgObj.getAttribute("x")),c=b+this.parent.scaleFactor*this.width/2;keyattrs={stroke:a,"stroke-width":3,fill:"none",cx:c,cy:(this.height-10)*this.parent.scaleFactor,class:"keyboardkeyannotation",r:this.width*this.parent.scaleFactor/4};var d=i.makeSVGright("circle",keyattrs);return this.parent.svgObj.appendChild(d),d}},this.addNoteName=function(a){if(void 0!==this.svgObj&&void 0!==this.parent&&void 0!==this.parent.svgObj&&(0!=this.id||void 0!==this.pitchObj)&&(void 0===this.pitchObj&&(this.pitchObj=new H.Pitch,this.pitchObj.ps=this.id),void 0===this.pitchObj.accidental||0==this.pitchObj.accidental.alter)){var b=parseInt(this.svgObj.getAttribute("x")),c=this.pitchObj.name,d=14;1==a&&(c=this.pitchObj.nameWithOctave,d=12,b-=2),d=Math.floor(d*parent.scaleFactor);var e="white";"whitekey"==this.keyClass&&(e="black"),textattrs={fill:e,x:b+this.parent.scaleFactor*(this.width/2-5),y:this.parent.scaleFactor*(this.height-20),class:"keyboardkeyname","font-size":d};var f=i.makeSVGright("text",textattrs),g=document.createTextNode(c);f.appendChild(g),this.noteNameSvgObj=f,this.parent.svgObj.appendChild(f)}},this.removeNoteName=function(){void 0!==this.svgObj&&void 0!==this.parent&&void 0!==this.parent.svgObj&&void 0!==this.noteNameSvgObj&&(this.noteNameSvgObj.parentNode==this.parent.svgObj&&this.parent.svgObj.removeChild(this.noteNameSvgObj),this.noteNameSvgObj=void 0)}},Y.WhiteKey=function(){Y.Key.call(this),this.classes.push("WhiteKey"),this.width=23,this.height=120,this.keyStyle="fill:#fffff6;stroke:black",this.keyClass="whitekey"},Y.WhiteKey.prototype=new Y.Key,Y.WhiteKey.prototype.constructor=Y.WhiteKey,Y.BlackKey=function(){Y.Key.call(this),this.classes.push("BlackKey"),this.width=13,this.height=80,this.keyStyle="fill:black;stroke:black",this.keyClass="blackkey"},Y.BlackKey.prototype=new Y.Key,Y.BlackKey.prototype.constructor=Y.BlackKey,Y.Keyboard=function(){this.whiteKeyWidth=23,this._defaultWhiteKeyWidth=23,this._defaultBlackKeyWidth=13,this.scaleFactor=1,this.height=120,this.keyObjects={},this.svgObj=void 0,this.markC=!0,this.showNames=!1,this.showOctaves=!1,this.startPitch="C3",this.endPitch="C5",this._startDNN=void 0,this._endDNN=void 0,this.hideable=!1,this.scrollable=!1,this.redrawSVG=function(){if(void 0!==this.svgObj){var a=this.svgObj,b=a.parentNode;this.keyObjects={};var c=this.createSVG();return b.replaceChild(c,a),c}},this.appendKeyboard=function(a){return void 0===a?a=document.body:void 0!==a.jquery&&(a=a[0]),svgDOM=this.createSVG(),this.scrollable&&(svgDOM=this.wrapScrollable(svgDOM)[0]),this.hideable?this.appendHideableKeyboard(a,svgDOM):a.appendChild(svgDOM),this},this.callbacks={click:this.clickhandler},this.clickhandler=function(a){var b=a.id,c=this.keyObjects[b];if(void 0!==c){var d=c.keyStyle,e="#c0c000";"whitekey"==c.keyClass&&(e="yellow"),a.setAttribute("style","fill:"+e+";stroke:black"),X.loadSoundfont("acoustic_grand_piano",function(a){h.noteOn(a.midiChannel,b,100,0),h.noteOff(a.midiChannel,b,500)}),setTimeout(function(){a.setAttribute("style",d)},500)}},this.sharpOffsets={0:14.3333,1:18.6666,3:13.25,4:16.25,5:19.75},this.createSVG=function(){if(void 0===this._startDNN)if("string"==typeof this.startPitch){var a=new music21.pitch.Pitch(this.startPitch);this._startDNN=a.diatonicNoteNum}else this._startDNN=this.startPitch;if(void 0===this._endDNN)if("string"==typeof this.endPitch){var a=new music21.pitch.Pitch(this.endPitch);this._endDNN=a.diatonicNoteNum}else this._endDNN=this.endPitch;for(var b=(this._startDNN-1)%7,c=1+this._endDNN-this._startDNN,d=this.whiteKeyWidth*this.scaleFactor*c,e=120*this.scaleFactor,f=e.toString()+"px",g=i.makeSVGright("svg",{"xml:space":"preserve",height:f,width:d.toString()+"px",class:"keyboardSVG"}),h=new H.Pitch("C4"),j=[],k=this,l=0;l<c;l++){h.diatonicNoteNum=this._startDNN+l;var m=new Y.WhiteKey;m.id=h.midi,m.parent=this,this.keyObjects[h.midi]=m,m.scaleFactor=this.scaleFactor,m.width=this.whiteKeyWidth,m.callbacks.click=function(){k.clickhandler(this)};var n=m.makeKey(this.whiteKeyWidth*this.scaleFactor*l);if(g.appendChild(n),(0==b||1==b||3==b||4==b||5==b)&&l!=c-1){var o=new Y.BlackKey;o.id=h.midi+1,this.keyObjects[h.midi+1]=o,o.parent=this,o.scaleFactor=this.scaleFactor,o.width=this._defaultBlackKeyWidth*this.whiteKeyWidth/this._defaultWhiteKeyWidth,o.callbacks.click=function(){k.clickhandler(this)};var p=this.sharpOffsets[b];p=this.whiteKeyWidth/this._defaultWhiteKeyWidth*this.scaleFactor*p;var q=o.makeKey(this.whiteKeyWidth*this.scaleFactor*l+p);j.push(q)}b+=1,b%=7}for(var r=0;r<j.length;r++)g.appendChild(j[r]);return this.svgObj=g,this.markC&&this.markMiddleC(),this.showNames&&this.markNoteNames(this.showOctaves),g},this.markMiddleC=function(a){var b=this.keyObjects[60];void 0!==b&&b.addCircle("red")},this.markNoteNames=function(a){this.removeNoteNames();for(var b in this.keyObjects){var c=this.keyObjects[b];c.addNoteName(a)}},this.removeNoteNames=function(){for(var a in this.keyObjects){var b=this.keyObjects[a];b.removeNoteName()}},this.wrapScrollable=function(a){var b=e("<div class='keyboardScrollableWrapper'></div>").css({display:"inline-block"}),c=e("<button class='keyboardOctaveDown'>&lt;&lt;</button>").css({"font-size":Math.floor(15*this.scaleFactor).toString()+"px"}).bind("click",function(){music21.miditools.transposeOctave-=1,this._startDNN-=7,this._endDNN-=7,this.redrawSVG()}.bind(this)),d=e("<button class='keyboardOctaveUp'>&gt;&gt;</button>").css({"font-size":Math.floor(15*this.scaleFactor).toString()+"px"}).bind("click",function(){music21.miditools.transposeOctave+=1,this._startDNN+=7,this._endDNN+=7,this.redrawSVG()}.bind(this)),f=e("<div style='display:inline-block; vertical-align: middle' class='keyboardScrollableInnerDiv'></div>");return f[0].appendChild(a),b.append(c),b.append(f),b.append(d),b},this.appendHideableKeyboard=function(a,b){var c=e("<div class='keyboardHideableContainer'/>"),d=e("<div class='keyboardToggleInside'>↥</div>").css({display:"inline-block","padding-top":"40px","font-size":"40px"}),f=e("<div class='keyboardToggleOutside'/>").css({display:"inline-block","vertical-align":"top",background:"white"});f.append(d),f.data("defaultDisplay",c.find(".keyboardSVG").css("display")),f.data("state","down"),f.click(Y.triggerToggleShow);var g=e("<div class='keyboardExplain'>Show keyboard</div>").css({display:"none","background-color":"white",padding:"10px 10px 10px 10px","font-size":"12pt"});return f.append(g),c.append(f),c[0].appendChild(b),e(a).append(c),c}},Y.triggerToggleShow=function(a){var b=e(this),c=b.data("state"),d=b.parent(),f=d.find(".keyboardScrollableWrapper");0==f.length&&(f=d.find(".keyboardSVG"));var g=b.find(".keyboardToggleInside"),h=d.find(".keyboardExplain");if("up"==c){g.text("↥"),g.css("padding-top","40px"),h.css("display","none");var i=b.data("defaultDisplay");void 0===i&&(i="inline"),f.css("display",i),b.data("state","down")}else f.css("display","none"),h.css("display","inline-block"),g.text("↧"),g.css("padding-top","10px"),b.data("state","up")},Y.jazzHighlight=function(a){if(void 0!==a)if(a.noteOn){var b=a.midiNote;if(void 0!==this.keyObjects[b]){var c=this.keyObjects[b],d=c.svgObj,e="",f=(a.velocity+25)/127;if(f>1&&(f=1),"whitekey"==c.keyClass){var g=f.toString();e="rgba(255, 255, 0, "+g+")"}else{var g=Math.floor(255*f).toString();e="rgb("+g+","+g+",0)"}d.setAttribute("style","fill:"+e+";stroke:black")}}else if(a.noteOff){var b=a.midiNote;if(void 0!==this.keyObjects[b]){var c=this.keyObjects[b],d=c.svgObj;d.setAttribute("style",c.keyStyle)}}};var Z={};Z.RenderOptions=function(){return{displayClef:!0,displayTimeSignature:!0,displayKeySignature:!0,scaleFactor:{x:.7,y:.7},top:0,left:void 0,width:void 0,overriddenWidth:void 0,height:void 0,naiveHeight:120,systemIndex:0,partIndex:0,measureIndex:0,systemMeasureIndex:0,systemPadding:void 0,naiveSystemPadding:40,stemDirection:void 0,maxSystemWidth:void 0,rightBarline:void 0,staffLines:5,staffConnectors:["single","brace"],staffPadding:60,events:{click:"play",dblclick:void 0},startNewSystem:!1,startNewPage:!1,showMeasureNumber:void 0}};var _={};_.RenderStack=function(){this.voices=[],this.streams=[],this.textVoices=[]},_.RenderStack.prototype.allTickables=function(){var a=[];return a.push.apply(a,this.voices),a.push.apply(a,this.textVoices),a},_.Renderer=function(a,b,c){this.stream=a,this.canvas=void 0,this.$canvas=void 0,this.$where=void 0,this.activeFormatter=void 0,this._vfRenderer=void 0,this._ctx=void 0,this.beamGroups=[],this.stacks=[],this.ties=[],this.systemBreakOffsets=[],this.vfTuplets=[],Object.defineProperties(this,{vfRenderer:{get:function(){return void 0!==this._vfRenderer?this._vfRenderer:(this._vfRenderer=new f.Flow.Renderer(this.canvas,f.Flow.Renderer.Backends.CANVAS),this._vfRenderer)},set:function(a){this._vfRenderer=a}},ctx:{get:function(){return void 0!==this._ctx?this._ctx:(this._ctx=this.vfRenderer.getContext(),this.stream&&this.stream.renderOptions&&this._ctx.scale(this.stream.renderOptions.scaleFactor.x,this.stream.renderOptions.scaleFactor.y),this._ctx)},set:function(a){this._ctx=a}}}),void 0!==c&&(void 0!==c.jquery?this.$where=c:this.$where=$(c)),void 0!==b&&(void 0!==b.jquery?(this.$canvas=b,this.canvas=b[0]):(this.canvas=b,this.$canvas=$(b)))},_.Renderer.prototype.render=function(a){void 0===a&&(a=this.stream);var b=!1,c=!1,d=a.hasSubStreams();a.isClassOrSubclass("Score")?b=!0:d&&a.get(0).hasSubStreams()?b=!0:d&&(c=!0),b?this.prepareScorelike(a):c?this.preparePartlike(a):this.prepareArrivedFlat(a),this.formatMeasureStacks(),this.drawTies(),this.drawMeasureStacks(),this.drawBeamGroups(),this.drawTuplets()},_.Renderer.prototype.prepareScorelike=function(a){for(var b=0;b<a.length;b++){var c=a.get(b);this.preparePartlike(c)}this.addStaffConnectors(a)},_.Renderer.prototype.preparePartlike=function(a){this.systemBreakOffsets=[];for(var b=0;b<a.length;b++){var c=a.get(b);c.renderOptions.startNewSystem&&this.systemBreakOffsets.push(c.offset),b==a.length-1&&(c.renderOptions.rightBarline="end"),void 0===this.stacks[b]&&(this.stacks[b]=new _.RenderStack),this.prepareMeasure(c,this.stacks[b])}this.prepareTies(a)},_.Renderer.prototype.prepareArrivedFlat=function(a){var b=new _.RenderStack;this.prepareMeasure(a,b),this.stacks[0]=b,this.prepareTies(a)},_.Renderer.prototype.prepareMeasure=function(a,b){if(void 0===a.hasVoices||a.hasVoices()===!1)this.prepareFlat(a,b);else for(var c=void 0,d=a.renderOptions,e=0;e<a.length;e++){var f=a.get(e);c=this.prepareFlat(f,b,c,d)}return b},_.Renderer.prototype.prepareFlat=function(a,b,c,d){a.makeAccidentals();var e=void 0;e=void 0!==c?c:this.renderStave(a,d),a.activeVFStave=e;var f=this.getVoice(a,e);return b.voices.push(f),b.streams.push(a),a.hasLyrics()&&b.textVoices.push(this.getLyricVoice(a,e)),e},_.Renderer.prototype.renderStave=function(a,b){void 0===a&&(a=this.stream);var c=this.ctx,d=this.newStave(a,b);return this.setClefEtc(a,d,b),d.setContext(c),d.draw(),d},_.Renderer.prototype.drawMeasureStacks=function(){for(var a=this.ctx,b=0;b<this.stacks.length;b++)for(var c=this.stacks[b].allTickables(),d=0;d<c.length;d++){var e=c[d];e.draw(a)}},_.Renderer.prototype.drawTuplets=function(){var a=this.ctx;this.vfTuplets.forEach(function(b){b.setContext(a).draw()})},_.Renderer.prototype.drawTies=function(){for(var a=this.ctx,b=0;b<this.ties.length;b++)this.ties[b].setContext(a).draw()},_.Renderer.prototype.prepareTies=function(a){for(var b=a.flat.notesAndRests,c=0;c<b.length-1;c++){var d=b.get(c);if(void 0!==d.tie&&"stop"!=d.tie.type){for(var e=b.get(c+1),g=!0,h=0;h<this.systemBreakOffsets.length;h++){var i=this.systemBreakOffsets[h];if(d.offset<i&&e.offset>=i){g=!1;break}}if(g){var j=new f.Flow.StaveTie({first_note:d.activeVexflowNote,last_note:e.activeVexflowNote,first_indices:[0],last_indices:[0]});this.ties.push(j)}else{var k=new f.Flow.StaveTie({first_note:d.activeVexflowNote,first_indices:[0]});this.ties.push(k);var l=new f.Flow.StaveTie({last_note:e.activeVexflowNote,first_indices:[0]});this.ties.push(l)}}}},_.Renderer.prototype.getVoice=function(a,b){void 0===a&&(a=this.stream);var c=this.vexflowNotes(a,b),d=this.vexflowVoice(a);return d.setStave(b),d.addTickables(c),d},_.Renderer.prototype.getLyricVoice=function(a,b){var c=this.vexflowVoice(a),d=this.vexflowLyrics(a,b);return c.setStave(b),c.addTickables(d),c},_.Renderer.prototype.formatMeasureStacks=function(){for(var a=0;a<this.stacks.length;a++)for(var b=this.stacks[a],c=b.voices,d=b.streams,e=this.formatVoiceGroup(b),f=0;f<d.length;f++){var g=d[f],h=c[f];this.applyFormatterInformationToNotes(h.stave,g,e)}},_.Renderer.prototype.formatVoiceGroup=function(a,b){var c=a.allTickables(),d=a.voices,e=a.streams;void 0===b&&(b=e[0].autoBeam);var g=new f.Flow.Formatter;if(0===d.length)return g;for(var h=0,i=0;i<c.length;i++)c[i].stave.start_x>h&&(h=c[i].stave.start_x);for(var i=0;i<c.length;i++)c[i].stave.start_x=h;var j=d[0].stave;if(g.joinVoices(c),g.formatToStave(c,j),b)for(i=0;i<d.length;i++){var k=d[i],l=[new f.Flow.Fraction(2,8)];void 0!==e[i]&&void 0!==e[i].timeSignature&&(l=e[i].timeSignature.vexflowBeatGroups(f));var m=f.Flow.Beam.applyAndGetBeams(k,void 0,l);this.beamGroups.push.apply(this.beamGroups,m)}return g},_.Renderer.prototype.drawBeamGroups=function(){for(var a=this.ctx,b=0;b<this.beamGroups.length;b++)this.beamGroups[b].setContext(a).draw()},_.Renderer.prototype.newStave=function(a,b){void 0===a&&(a=this.stream),void 0===b&&(b=a.renderOptions);var c=b.width;void 0===c&&(c=a.estimateStaffLength()+b.staffPadding);var d=b.top;void 0===d&&(d=0);var e=b.left;void 0===e&&(e=10),music21.debug&&console.log("creating new stave: left:"+e+" top: "+d+" width: "+c);var g=new f.Flow.Stave(e,d,c);return g},_.Renderer.prototype.setClefEtc=function(a,b,c){if(void 0===c&&(c=a.renderOptions),this.setStafflines(a,b),c.showMeasureNumber&&b.setMeasure(c.measureIndex+1),c.displayClef){var d=void 0,e="default";1==a.clef.octaveChange?d="8va":a.clef.octaveChange==-1&&(d="8vb"),b.addClef(a.clef.name,e,d)}if(void 0!==a.keySignature&&c.displayKeySignature&&b.addKeySignature(a.keySignature.vexflow()),void 0!==a.timeSignature&&c.displayTimeSignature&&b.addTimeSignature(a.timeSignature.numerator.toString()+"/"+a.timeSignature.denominator.toString()),void 0!==c.rightBarline){var g=c.rightBarline,h={single:"SINGLE",double:"DOUBLE",end:"END"},i=h[g];void 0!==i&&b.setEndBarType(f.Flow.Barline.type[i])}},_.Renderer.prototype.setStafflines=function(a,b){var c=a.renderOptions;5!=c.staffLines&&(0===c.staffLines?b.setNumLines(0):1==c.staffLines?b.options.line_config=[{
visible:!1},{visible:!1},{visible:!0},{visible:!1},{visible:!1}]:2==c.staffLines?b.options.line_config=[{visible:!1},{visible:!1},{visible:!0},{visible:!0},{visible:!1}]:3==c.staffLines?b.options.line_config=[{visible:!1},{visible:!0},{visible:!0},{visible:!0},{visible:!1}]:b.setNumLines(c.staffLines))},_.Renderer.prototype.vexflowNotes=function(a,b){void 0===a&&(a=this.stream);for(var c=[],d=[],e=void 0,g=0,h=[],i={clef:a.clef,stave:b},j=0;j<a.length;j++){var k=a.get(j);if(k.isClassOrSubclass("GeneralNote")&&void 0!==k.duration){var l=k.vexflowNote(i);if(void 0===l&&console.error("Cannot create a vexflowNote from: ",k),void 0!==b&&l.setStave(b),c.push(l),k.duration.tuplets.length>0){var m=k.duration.tuplets[0];if(void 0===e&&(e=m),h.push(l),g+=k.duration.quarterLength,g>=e.totalTupletLength()||Math.abs(g-e.totalTupletLength())<.001){var n={num_notes:e.numberNotesActual,notes_occupied:e.numberNotesNormal},o=new f.Flow.Tuplet(h,n);"ratio"==e.tupletNormalShow&&o.setRatioed(!0),d.push(o),g=0,e=void 0,h=[]}}}}return void 0!==e&&console.warn("incomplete tuplet found in stream: ",a),d.length>0&&this.vfTuplets.push.apply(this.vfTuplets,d),c},_.Renderer.prototype.vexflowLyrics=function(a,b){var c=function(a,c,d){var e=new f.Flow.TextNote({text:a,font:c,duration:d}).setLine(11).setStave(b).setJustification(f.Flow.TextNote.Justification.LEFT);return e};void 0===a&&(a=this.stream);for(var d={family:"Serif",size:12,weight:""},e=[],g=0;g<a.length;g++){var h=a.get(g),i=h.lyrics,j=void 0,k=h.duration.vexflowDuration,l=!1;if(0===i.length)j="";else if(j=i[0].text,void 0===j&&(j=""),"middle"==i[0].syllabic||"begin"==i[0].syllabic){l=" "+i[0].lyricConnector;var m=h.duration.quarterLength/2;k=new music21.duration.Duration(m).vexflowDuration}var n=c(j,d,k);if(e.push(n),l!==!1){var o=c(l,d,k);e.push(o)}}return e},_.Renderer.prototype.vexflowVoice=function(a){var b=void 0,c=a.duration.quarterLength,d=Math.round(c/(1/256)),e=1024;return d%512===0?(e=2,d/=512):d%256===0?(e=4,d/=256):d%128===0?(e=8,d/=128):d%64===0?(e=16,d/=64):d%32===0?(e=32,d/=32):d%16===0?(e=64,d/=16):d%8===0?(e=128,d/=8):d%4===0?(e=256,d/=4):d%2===0&&(e=512,d/=2),music21.debug&&console.log("New voice, num_beats: "+d.toString()+" beat_value: "+e.toString()),b=new f.Flow.Voice({num_beats:d,beat_value:e,resolution:f.Flow.RESOLUTION}),b.setMode(f.Flow.Voice.Mode.SOFT),b},_.Renderer.prototype.staffConnectorsMap=function(a){var b={brace:f.Flow.StaveConnector.type.BRACE,single:f.Flow.StaveConnector.type.SINGLE,double:f.Flow.StaveConnector.type.DOUBLE,bracket:f.Flow.StaveConnector.type.BRACKET};return b[a]},_.Renderer.prototype.addStaffConnectors=function(a){void 0===a&&(a=this.stream);var b=a.length;if(!(b<2))for(var c=a.get(0),d=a.get(-1),e=c.length,g=0;g<e;g++){var h=c.get(g),i=d.get(g);if(h.renderOptions.startNewSystem)for(var j=h.activeVFStave,k=i.activeVFStave,l=0;l<a.renderOptions.staffConnectors.length;l++){var m=new f.Flow.StaveConnector(j,k),n=a.renderOptions.staffConnectors[l],o=this.staffConnectorsMap(n);m.setType(o),m.setContext(this.ctx),m.draw()}}},_.Renderer.prototype.removeFormatterInformation=function(a,b){a.storedVexflowStave=void 0;for(var c=0;c<a.length;c++){var d=a.get(c);d.x=void 0,d.y=void 0,d.width=void 0,d.systemIndex=void 0,d.activeVexflowNote=void 0,b&&d.isClassOrSubclass("Stream")&&this.removeFormatterInformation(d,b)}},_.Renderer.prototype.applyFormatterInformationToNotes=function(a,b,c){void 0===b&&(b=this.stream);var d=0;void 0!==a&&(d=a.start_x+a.glyph_start_x,music21.debug&&(console.log("noteOffsetLeft: "+d+" ; stave.start_x: "+a.start_x),console.log("Bottom y: "+a.getBottomY())));for(var e=0,f=0;f<b.length;f++){var g=b.get(f);if(g.isClassOrSubclass("GeneralNote")){var h=g.activeVexflowNote;if(void 0===h)continue;var i=parseInt(h.ticks),j=c.tContexts.map[String(e)];if(e+=i,g.x=h.getAbsoluteX(),g.systemIndex=b.renderOptions.systemIndex,void 0===j)continue;g.width=j.width,void 0!==g.pitch&&(g.y=a.getBottomY()-(b.clef.lowestLine-g.pitch.diatonicNoteNum)*a.options.spacing_between_lines_px)}}if(music21.debug)for(f=0;f<b.length;f++){var k=b.get(f);void 0!==k.pitch&&console.log(k.pitch.diatonicNoteNum+" "+k.x+" "+(k.x+k.width))}b.storedVexflowStave=a};var aa={};aa.TimeSignature=function(a){s.Music21Object.call(this),this.classes.push("TimeSignature"),this._numerator=4,this._denominator=4,this.beatGroups=[],Object.defineProperties(this,{numerator:{enumerable:!0,configurable:!0,get:function(){return this._numerator},set:function(a){this._numerator=a}},denominator:{enumerable:!0,configurable:!0,get:function(){return this._denominator},set:function(a){this._denominator=a}},ratioString:{enumerable:!0,configurable:!0,get:function(){return this.numerator.toString()+"/"+this.denominator.toString()},set:function(a){var b=a.split("/");this.numerator=parseInt(b[0]),this.denominator=parseInt(b[1])}},barDuration:{enumerable:!0,configurable:!0,get:function(){var a=4*this._numerator/this._denominator;return new r.Duration(a)}}}),"string"==typeof a&&(this.ratioString=a)},aa.TimeSignature.prototype=new s.Music21Object,aa.TimeSignature.prototype.constructor=aa.TimeSignature,aa.TimeSignature.prototype.computeBeatGroups=function(){var a=[],b=this.numerator,c=this.denominator;if(c<8&&b>=5){var d=8/c;c=8,b*=d}if(c>=8){for(;b>=5;)a.push([3,c]),b-=3;4==b?(a.push([2,c]),a.push([2,c])):b>0&&a.push([b,c])}else 2==c?a.push([1,2]):c<=1?a.push([1,1]):a.push([2,8]);return a},aa.TimeSignature.prototype.vexflowBeatGroups=function(a){var b=void 0;b=this.beatGroups.length>0?this.beatGroups:this.computeBeatGroups();for(var c=[],d=0;d<b.length;d++){var e=b[d];c.push(new a.Flow.Fraction(e[0],e[1]))}return c};var ba={};ba.ScrollPlayer=function(a,b){this.pixelMapper=new ba.PixelMapper(a),this.stream=a,this.canvas=b,this.tempo=a.tempo,this.lastX=0,this.lastNoteIndex=-1,this.barDOM=void 0,this.svgDOM=void 0,this.canvasParent=void 0,this.lastTimeout=void 0,this.startTime=(new Date).getTime(),this.previousSystemIndex=0,this.eachSystemHeight=120,this.timingMS=50,this.savedRenderOptionClick=void 0,this.scrollScore=function(){var a=(new Date).getTime()-this.startTime,b=a/1e3*this.tempo/60,c=this.pixelMapper,d=c.getSystemIndexAtOffset(b);d>this.previousSystemIndex&&(this.lastX=-100,this.previousSystemIndex=d,this.barDOM.setAttribute("y",d*this.eachSystemHeight));var e=c.getXAtOffset(b);e=Math.floor(e),e>this.lastX&&(this.barDOM.setAttribute("x",e),this.lastX=e);for(var f=0;f<c.allMaps.length;f++){var g=c.allMaps[f].offset;if(!(f<=this.lastNoteIndex||Math.abs(b-g)>.1)){for(var h=c.allMaps[f].elements,i=0;i<h.length;i++){var j=h[i];void 0!==j&&void 0!==j.playMidi&&j.playMidi(this.tempo)}this.lastNoteIndex=f}}var k=void 0;if(e<c.maxX||d<c.maxSystemIndex)k=setTimeout(this.scrollScore,this.timingMS),this.lastTimeout=k;else{var l=void 0;this.stopPlaying(l)}}.bind(this)},ba.ScrollPlayer.prototype.createScrollBar=function(){var a=this.canvas,b=i.makeSVGright("svg",{height:a.height.toString()+"px",width:a.width.toString()+"px",style:"position:absolute; top: 0px; left: 0px;"}),c=this.stream.renderOptions.scaleFactor.y,d=a.height/(c*(this.pixelMapper.maxSystemIndex+1)),f=i.makeSVGright("rect",{width:10,height:d-6,x:this.pixelMapper.startX,y:3,style:"fill: rgba(255, 255, 20, .5);stroke:white"});f.setAttribute("transform","scale("+c+")"),b.appendChild(f);var g=e(a).parent()[0];return g.appendChild(b),this.barDOM=f,this.svgDOM=b,this.canvasParent=g,this.eachSystemHeight=d,f},ba.ScrollPlayer.prototype.startPlaying=function(){this.createScrollBar(),this.savedRenderOptionClick=this.stream.renderOptions.events.click,this.stream.renderOptions.events.click=function(a){this.stopPlaying(a)}.bind(this),this.stream.setRenderInteraction(this.canvasParent),this.scrollScore()},ba.ScrollPlayer.prototype.stopPlaying=function(a){this.stream.renderOptions.events.click=this.savedRenderOptionClick,this.barDOM.setAttribute("style","display:none"),this.canvasParent.removeChild(this.svgDOM),void 0!==this.lastTimeout&&clearTimeout(this.lastTimeout),this.stream.setRenderInteraction(this.canvasParent),void 0!==a&&a.stopPropagation()},ba.PixelMapper=function(a){this.allMaps=[],this.stream=a,this.notesAndRests=this.stream.flat.notesAndRests,this.pixelScaling=a.renderOptions.scaleFactor.x,Object.defineProperties(this,{startX:{enumerable:!0,configurable:!1,get:function(){return this.allMaps[0].x}},maxX:{enumerable:!0,configurable:!1,get:function(){var a=this.allMaps[this.allMaps.length-1];return a.x}},maxSystemIndex:{enumerable:!0,configurable:!1,get:function(){return this.allMaps[this.allMaps.length-1].systemIndex}}}),this.processStream(a)},ba.PixelMapper.prototype.processStream=function(){for(var a=this.notesAndRests,b=0;b<a.length;b++){var c=a.get(b);this.addNoteToMap(c)}var d=a.get(-1).activeVexflowNote.stave,e=d.x+d.width,f=a.get(-1).duration.quarterLength+a.get(-1).offset,g=new ba.PixelMap(this,f);return g.elements=[void 0],g.x=e,g.systemIndex=this.allMaps[this.allMaps.length-1].systemIndex,this.allMaps.push(g),this.allMaps},ba.PixelMapper.prototype.addNoteToMap=function(a){var b=a.offset,c=this.findMapForExactOffset(b);if(void 0!==c)return c.elements.push(a),c;var d=new ba.PixelMap(this,b);return d.elements=[a],this.allMaps.push(d),d},ba.PixelMapper.prototype.findMapForExactOffset=function(a){for(var b=this.allMaps.length-1;b>=0;b-=1)if(this.allMaps[b].offset==a)return this.allMaps[b]},ba.PixelMapper.prototype.getPixelMapsAroundOffset=function(a){for(var b=void 0,c=void 0,d=0;d<this.allMaps.length;d++){var e=this.allMaps[d];if(e.offset<=a&&(b=e),e.offset>=a){c=e;break}}if(void 0===b&&void 0===c){var f=this.allMaps[this.allMaps.length-1];b=f,c=f}else void 0===b?b=c:void 0===c&&(c=b);return[b,c]},ba.PixelMapper.prototype.getXAtOffset=function(a){var b=this.getPixelMapsAroundOffset(a),c=b[0],d=b[1],e=this.pixelScaling,f=a-c.offset,g=d.offset-c.offset,h=d.x-c.x;if(d.systemIndex!=c.systemIndex){var i=c.elements[0].activeVexflowNote.stave;h=(i.x+i.width)*e-c.x}var j=0;j=0!=g?h/g:0;var k=f*j,l=c.x+k;return l/e},ba.PixelMapper.prototype.getSystemIndexAtOffset=function(a){var b=this.getPixelMapsAroundOffset(a),c=b[0];return c.systemIndex},ba.PixelMap=function(a,b){this.pixelScaling=a.pixelScaling,this.elements=[],this.offset=b,this._x=void 0,this._systemIndex=void 0,Object.defineProperties(this,{x:{enumerable:!0,configurable:!0,get:function(){return void 0!==this._x?this._x:0==this.elements.length?0:this.elements[0].x*this.pixelScaling},set:function(a){this._x=a}},systemIndex:{enumerable:!0,configurable:!0,get:function(){return void 0!==this._systemIndex?this._systemIndex:0==this.elements.length?0:this.elements[0].systemIndex},set:function(a){this._systemIndex=a}}})},ba.CursorSelect=function(a){this.stream=a,this.activeElementHierarchy=[void 0]};var ca={};ca.Stream=function(){s.Music21Object.call(this),this.classes.push("Stream"),this._duration=void 0,this._elements=[],this._elementOffsets=[],this._clef=void 0,this.displayClef=void 0,this._keySignature=void 0,this._timeSignature=void 0,this._instrument=void 0,this._autoBeam=void 0,this.activeVFStave=void 0,this.renderOptions=new Z.RenderOptions,this._tempo=void 0,this.staffLines=5,this._stopPlaying=!1,this._allowMultipleSimultaneousPlays=!0,this.changedCallbackFunction=void 0,Object.defineProperties(this,{duration:{configurable:!0,enumerable:!0,get:function(){if(void 0!==this._duration)return this._duration;for(var a=0,b=0;b<this.length;b++){var c=this.get(b),d=c.offset;void 0!==c.duration&&(d+=c.duration.quarterLength),d>a&&(a=d)}return new r.Duration(a)},set:function(a){this._duration=a}},flat:{configurable:!0,enumerable:!0,get:function(){if(this.hasSubStreams()){for(var a=[],b=0;b<this.length;b++){var c=this.get(b);if(void 0!==c.elements){for(var d=c.offset,e=c.flat,f=0;f<e.length;f++)e.get(f).offset+=d;a.push.apply(a,e._elements)}else a.push(c)}var g=this.clone(!1);return g.elements=a,g}return this}},notes:{configurable:!0,enumerable:!0,get:function(){return this.getElementsByClass(["Note","Chord"])}},notesAndRests:{configurable:!0,enumerable:!0,get:function(){return this.getElementsByClass("GeneralNote")}},tempo:{configurable:!0,enumerable:!0,get:function(){return void 0===this._tempo&&void 0!==this.activeSite?this.activeSite.tempo:void 0===this._tempo?150:this._tempo},set:function(a){this._tempo=a}},instrument:{configurable:!0,enumerable:!0,get:function(){return void 0===this._instrument&&void 0!==this.activeSite?this.activeSite.instrument:this._instrument},set:function(a){"string"==typeof a&&(a=new music21.instrument.Instrument(a)),this._instrument=a}},clef:{configurable:!0,enumerable:!0,get:function(){return void 0===this._clef&&void 0===this.activeSite?new N.Clef("treble"):void 0===this._clef?this.activeSite.clef:this._clef},set:function(a){this._clef=a}},keySignature:{configurable:!0,enumerable:!0,get:function(){return void 0===this._keySignature&&void 0!==this.activeSite?this.activeSite.keySignature:this._keySignature},set:function(a){this._keySignature=a}},timeSignature:{configurable:!0,enumerable:!0,get:function(){return void 0===this._timeSignature&&void 0!==this.activeSite?this.activeSite.timeSignature:this._timeSignature},set:function(a){"string"==typeof a&&(a=new aa.TimeSignature(a)),this._timeSignature=a}},autoBeam:{configurable:!0,enumerable:!0,get:function(){return void 0===this._autoBeam&&void 0!==this.activeSite?this.activeSite.autoBeam:void 0===this._autoBeam||this._autoBeam},set:function(a){this._autoBeam=a}},maxSystemWidth:{configurable:!0,enumerable:!0,get:function(){var a=750;return void 0===this.renderOptions.maxSystemWidth&&void 0!==this.activeSite?a=this.activeSite.maxSystemWidth:void 0!==this.renderOptions.maxSystemWidth&&(a=this.renderOptions.maxSystemWidth),a/this.renderOptions.scaleFactor.x},set:function(a){this.renderOptions.maxSystemWidth=a*this.renderOptions.scaleFactor.x}},parts:{configurable:!0,enumerable:!0,get:function(){for(var a=[],b=0;b<this.length;b++){var c=this.get(b);c.isClassOrSubclass("Part")&&a.push(c)}return a}},measures:{configurable:!0,enumerable:!0,get:function(){for(var a=[],b=0;b<this.length;b++){var c=this.get(b);c.isClassOrSubclass("Measure")&&a.push(c)}return a}},length:{configurable:!0,enumerable:!0,get:function(){return this._elements.length}},elements:{configurable:!0,enumerable:!0,get:function(){return this._elements},set:function(a){var b=0;this._elements=[],this._elementOffsets=[];var c=[],d=void 0,e=void 0;for(d=0;d<a.length;d++){e=a[d];var f=e.offset;null===f||f==b?(this._elements.push(e),e.offset=b,this._elementOffsets.push(b),void 0===e.duration&&console.error("No duration for ",e," in ",this),b+=e.duration.quarterLength):c.push(e)}for(d=0;d<c.length;d++)e=c[d],this.insert(e.offset,e)}}}),this.canvasChangerFunction=function(a){var b=a.currentTarget,c=this.findNoteForClick(b,a),d=c[0],e=c[1];return void 0===e?void(music21.debug&&console.log("No note found")):this.noteChanged(d,e,b)}.bind(this)},ca.Stream.prototype=new s.Music21Object,ca.Stream.prototype.constructor=ca.Stream,ca.Stream.prototype.clone=function(a){var b=Object.create(this.constructor.prototype);for(var c in b)if(this.hasOwnProperty(c)!==!1)if("activeSite"==c)b[c]=this[c];else if("renderOptions"==c)b[c]=i.merge({},this[c]);else if(a===!0||"_elements"!=c&&"_elementOffsets"!=c){if(!a||"_elements"!=c&&"_elementOffsets"!=c)"activeVexflowNote"==c||"storedVexflowstave"==c||void 0!==Object.getOwnPropertyDescriptor(this,c).get||void 0!==Object.getOwnPropertyDescriptor(this,c).set||"function"==typeof this[c]||(null!==this[c]&&void 0!==this[c]&&this[c].isMusic21Object===!0?b[c]=this[c].clone(a):b[c]=this[c]);else if("_elements"==c){b._elements=[],b._elementOffsets=[];for(var d=0;d<this._elements.length;d++){b._elementOffsets[d]=this._elementOffsets[d];var e=this._elements[d],f=e.clone(a);f.activeSite=b,b._elements[d]=f}}}else b[c]=this[c].slice();return b},ca.Stream.prototype.append=function(a){try{void 0!==a.isClassOrSubclass&&a.isClassOrSubclass("NotRest");var b=0;if(this._elements.length>0){var c=this._elements[this._elements.length-1].duration.quarterLength;b=this._elementOffsets[this._elementOffsets.length-1]+c}this._elementOffsets.push(b),this._elements.push(a),a.offset=b,a.activeSite=this}catch(b){console.error("Cannot append element ",a," to stream ",this," : ",b)}return this},ca.Stream.prototype.insert=function(a,b){try{void 0!==b.isClassOrSubclass&&b.isClassOrSubclass("NotRest");for(var c=0;c<this._elements.length;c++){var d=this._elementOffsets[c];if(!(d<=a))return this._elementOffsets.splice(c,0,a),this._elements.splice(c,0,b),b.offset=a,void(b.activeSite=this)}this._elementOffsets.push(a),this._elements.push(b),b.offset=a,b.activeSite=this}catch(a){console.error("Cannot insert element ",b," to stream ",this," : ",a)}return this},ca.Stream.prototype.pop=function(){if(this.length>0){var a=this.get(-1);return this._elementOffsets.pop(),this._elements.pop(),a}},ca.Stream.prototype.get=function(a){var b=void 0;return void 0===a?void 0:Math.abs(a)>this._elements.length?void 0:a==this._elements.length?void 0:a<0?(b=this._elements[this._elements.length+a],b.offset=this._elementOffsets[this._elements.length+a],b):(b=this._elements[a],b.offset=this._elementOffsets[a],b)},ca.Stream.prototype.hasSubStreams=function(){for(var a=!1,b=0;b<this.length;b++){var c=this.elements[b];if(c.isClassOrSubclass("Stream")){a=!0;break}}return a},ca.Stream.prototype.makeMeasures=function(a){var b={meterStream:void 0,refStreamOrTimeRange:void 0,searchContext:!1,innerBarline:void 0,finalBarline:"final",bestClef:!1,inPlace:!1};i.merge(b,a),this.hasVoices()?voiceCount=srcObj.getElementsByClass("Voice").length:voiceCount=0;var c=this.getElementsByClass("TimeSignature");0===c.length&&c.append(this.timeSignature);var d=this.clef,e=this.offsetMap(),f=0,g=void 0;for(g=0;g<e.length;g++)e[g].endTime>f&&(f=e[g].endTime);for(var h=new this.constructor,j=0,k=0,l=void 0,m=void 0,n=void 0;;){m=new ca.Measure,m.number=k+1;var o=this.timeSignature;for(m.clef=d,m.timeSignature=o.clone(),g=0;g<voiceCount;g++){var p=new ca.Voice;p.id=t,m.insert(0,p)}if(h.insert(j,m),j+=o.barDuration.quarterLength,j>=f)break;k+=1}var q=void 0;for(g=0;g<e.length;g++){var r=e[g];q=r.element;var s=r.offset,t=(r.endTime,r.voiceIndex),u=!1;l=void 0;for(var v=0;v<h.length;v++){m=h.get(v),void 0!==m.timeSignature&&(l=m.timeSignature),n=m.getOffsetBySite(h);var w=n+l.barDuration.quarterLength;if(s>=n&&s<w){u=!0;break}}var x=s-n;if(m.clef!==q&&(0!==x||!q.isClassOrSubclass("TimeSignature"))){var y=m;void 0!==t&&(y=m.getElementsByClass("Voice").get(t)),y.insert(x,q)}}if(b.inPlace!==!0)return h;for(this.elements=[],g=0;g<h.length;g++)q=h.get(g),this.insert(q.offset,q);return this},ca.Stream.prototype.hasLyrics=function(){for(var a=0;a<this.length;a++){var b=this.elements[a];if(void 0!==b.lyric)return!0}return!1},ca.Stream.prototype.offsetMap=function(){var a=[],b=[];this.hasVoices()?e.each(srcObj.getElementsByClass("Voice").elements,function(a,c){b.push([c.flat,a])}):b=[[this,void 0]];for(var c=0;c<b.length;c++)for(var d=b[c][0],f=b[c][1],g=0;g<d.length;g++){var h=d.get(g),i=h.duration.quarterLength,j=h.offset,k=j+i,l=new ca.OffsetMap(h,j,k,f);a.push(l)}return a},ca.Stream.prototype.getElementsByClass=function(a){for(var b=[],c=0;c<this.length;c++){var d=this.get(c);void 0===d.isClassOrSubclass?console.err("what the hell is a ",d,"doing in a Stream?"):d.isClassOrSubclass(a)&&b.push(d)}var e=new ca.Stream;return e.elements=b,e},ca.Stream.prototype.makeAccidentals=function(){var a,b={},c=["C","D","E","F","G","A","B"];for(a=0;a<c.length;a++){var d=c[a],f=0;if(void 0!==this.keySignature){var g=this.keySignature.accidentalByStep(d);void 0!==g&&(f=g.alter)}b[d]=f}var h=[],i=void 0,j=void 0;for(a=0;a<10;a++)i=e.extend({},b),h.push(i);for(var k=e.extend({},b),a=0;a<this.length;a++){var l=this.get(a);if(void 0!==l.pitch)j=l.pitch,i=h[j.octave],this._makeAccidentalForOnePitch(j,i,k);else if(void 0!==l._notes)for(var m=0;m<l._notes.length;m++)j=l._notes[m].pitch,i=h[j.octave],this._makeAccidentalForOnePitch(j,i,k)}return this},ca.Stream.prototype._makeAccidentalForOnePitch=function(a,b,c){var d=void 0;return d=void 0===a.accidental?0:a.accidental.alter,b[a.step]!=d||c[a.step]!=d?(void 0===a.accidental&&(a.accidental=new H.Accidental("natural")),a.accidental.displayStatus=!0):b[a.step]==d&&c[a.step]==d&&void 0!==a.accidental&&(a.accidental.displayStatus=!1),b[a.step]=d,c[a.step]=d,a},ca.Stream.prototype.setSubstreamRenderOptions=function(){return this},ca.Stream.prototype.resetRenderOptions=function(a,b){var c=this.renderOptions.events;if(this.renderOptions=new Z.RenderOptions,b&&(this.renderOptions.events=c),a)for(var d=0;d<this.length;d++){var e=this.get(d);e.isClassOrSubclass("Stream")&&e.resetRenderOptions(a,b)}return this},ca.Stream.prototype.renderVexflowOnCanvas=function(a){a.jquery&&(a=a[0]);var b=new _.Renderer(this,a);return b.render(),a.storedStream=this,this.setRenderInteraction(a),this},ca.Stream.prototype.estimateStreamHeight=function(a){var b=this.renderOptions.naiveHeight,c=this.systemPadding,d=void 0;if(this.isClassOrSubclass("Score")){var e=this.length;d=this.numSystems(),(void 0===d||a)&&(d=1);var f=d*b*e+(d-1)*c;return f}return this.isClassOrSubclass("Part")?(d=1,a||(d=this.numSystems()),music21.debug&&console.log("estimateStreamHeight for Part: numSystems ["+d+"] * staffHeight ["+b+"] + (numSystems ["+d+"] - 1) * systemPadding ["+c+"]."),d*b+(d-1)*c):b},ca.Stream.prototype.estimateStaffLength=function(){var a=void 0,b=void 0;if(void 0!==this.renderOptions.overriddenWidth)return this.renderOptions.overriddenWidth;if(this.hasVoices()){var c=0;for(a=0;a<this.length;a++){var d=this.get(a);if(d.isClassOrSubclass("Stream")){var e=d.estimateStaffLength()+d.renderOptions.staffPadding;e>c&&(c=e)}}return c}if(this.hasSubStreams()){for(b=0,a=0;a<this.length;a++){var f=this.get(a);if(f.isClassOrSubclass("Stream")&&(b+=f.estimateStaffLength()+f.renderOptions.staffPadding,0!==a&&f.renderOptions.startNewSystem===!0))break}return b}var g=this.renderOptions;return b=30*this.length,b+=g.displayClef?20:0,b+=g.displayKeySignature&&this.keySignature?this.keySignature.width:0,b+=g.displayTimeSignature?30:0},ca.Stream.prototype.playStream=function(a){var b={instrument:this.instrument,tempo:this.tempo,done:void 0,startNote:void 0};i.merge(b,a);var c=b.startNote,d=0;void 0!==c&&(d=c);var e=this.flat.elements,f=e.length;this._stopPlaying=!1;var g=this,h=function a(b,c){if(d<f&&!g._stopPlaying){var e=b[d],h=void 0;d<f+1&&(h=b[d+1]);var i=0;void 0!==e.playMidi&&(i=e.playMidi(c.tempo,h,c)),d+=1,setTimeout(function(){a(b,c)},i)}else c&&c.done&&c.done.call()};return h(e,b),this},ca.Stream.prototype.stopPlayStream=function(){this._stopPlaying=!0;for(var a=0;a<127;a++)music21.MIDI.noteOff(0,a,0);return this},ca.Stream.prototype.createNewCanvas=function(a,b){this.hasSubStreams()&&this.setSubstreamRenderOptions();var c=e("<canvas/>");if(void 0!==a)"string"==typeof a&&(a=i.stripPx(a)),c.attr("width",a);else{var d=this.estimateStaffLength()+this.renderOptions.staffPadding+0;c.attr("width",d)}if(void 0!==b)c.attr("height",b);else{var f=void 0;f=void 0===this.renderOptions.height?this.estimateStreamHeight():this.renderOptions.height,c.attr("height",f*this.renderOptions.scaleFactor.y)}return c},ca.Stream.prototype.createPlayableCanvas=function(a,b){return this.renderOptions.events.click="play",this.createCanvas(a,b)},ca.Stream.prototype.createCanvas=function(a,b){var c=this.createNewCanvas(a,b);return this.renderVexflowOnCanvas(c),c},ca.Stream.prototype.appendNewCanvas=function(a,b,c){void 0===a&&(a="body");var d=a;void 0===a.jquery&&(d=e(a));var f=this.createCanvas(b,c);return d.append(f),f[0]},ca.Stream.prototype.replaceCanvas=function(a,b){void 0===a&&(a="body");var c=void 0;void 0===a.jquery?c=e(a):(c=a,a=c[0]);var d=void 0;if(d="CANVAS"==c.prop("tagName")?c:c.find("canvas"),0===d.length)throw"No canvas defined for replaceCanvas!";d.length>1&&(d=e(d[d.length-1]));var f=void 0;if(b){var g=d.width(),h=d.height();f=this.createCanvas(g,h)}else f=this.createCanvas();return d.replaceWith(f),f},ca.Stream.prototype.renderScrollableCanvas=function(a){var b=a;void 0===a?b=e(document.body):void 0===a.jquery&&(b=e(a));var c=e("<div>").css("position","absolute"),d=void 0;return this.renderOptions.events.click=function(a){return function(b){a.scrollScoreStart(d,b)}}(this),d=this.appendNewCanvas(c),this.setRenderInteraction(c),b.append(c),d},ca.Stream.prototype.scrollScoreStart=function(a,b){var c=new ba.ScrollPlayer(this,a);return c.startPlaying(),void 0!==b&&b.stopPropagation(),c},ca.Stream.prototype.setRenderInteraction=function(a){var b=a;if(void 0!==a){void 0===a.jquery&&(b=e(a));var c=function(){this.playStream()}.bind(this);return e.each(this.renderOptions.events,e.proxy(function(a,d){b.off(a),"string"==typeof d&&"play"==d?b.on(a,c):"string"==typeof d&&"resize"==a&&"reflow"==d?this.windowReflowStart(b):void 0!==d&&b.on(a,d)},this)),this}},ca.Stream.prototype.recursiveGetStoredVexflowStave=function(){var a=this.storedVexflowStave;if(void 0===a){if(!this.hasSubStreams())return;var b=this.getElementsByClass("Stream");a=b.get(0).storedVexflowStave,void 0===a&&b.get(0).hasSubStreams()&&(a=b.get(0).get(0).storedVexflowStave)}return a},ca.Stream.prototype.getUnscaledXYforCanvas=function(a,b){var c=null;c=void 0===a?{left:0,top:0}:e(a).offset();var d=void 0,f=void 0;void 0!==b.pageX&&void 0!==b.pageY?(d=b.pageX,f=b.pageY):(d=b.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,f=b.clientY+document.body.scrollTop+document.documentElement.scrollTop);var g=d-c.left,h=f-c.top;return[g,h]},ca.Stream.prototype.getScaledXYforCanvas=function(a,b){var c=this.getUnscaledXYforCanvas(a,b),d=c[0],e=c[1],f=this.renderOptions.scaleFactor,g=e/f.y,h=d/f.x;return[h,g]},ca.Stream.prototype.diatonicNoteNumFromScaledY=function(a){var b=this.recursiveGetStoredVexflowStave(),c=b.options.spacing_between_lines_px,d=b.options.space_above_staff_ln,e=2*a/c,f=2*(b.options.num_lines-1+d)-e,g=this.clef.lowestLine+Math.round(f);return g},ca.Stream.prototype.noteElementFromScaledX=function(a,b,c){var d=void 0;void 0===b&&(b=10);for(var e=0;e<this.length;e++){var f=this.get(e);if(a>f.x-b&&a<f.x+f.width+b){d=f;break}}return d},ca.Stream.prototype.findNoteForClick=function(a,b,c,d){if(void 0===c||void 0===d){var e=this.getScaledXYforCanvas(a,b);c=e[0],d=e[1]}var f=this.diatonicNoteNumFromScaledY(d),g=this.noteElementFromScaledX(c);return[f,g]},ca.Stream.prototype.noteChanged=function(a,b,c){var d=b;if(p=new H.Pitch("C"),p.diatonicNoteNum=a,p.accidental=d.pitch.accidental,d.pitch=p,d.stemDirection=void 0,this.activeNote=d,this.redrawCanvas(c),void 0!==this.changedCallbackFunction)return this.changedCallbackFunction({foundNote:d,canvas:c})},ca.Stream.prototype.redrawCanvas=function(a){var b=e(a),c=this.createNewCanvas(a.width,a.height);return this.renderVexflowOnCanvas(c),b.replaceWith(c),i.jQueryEventCopy(e.event,b,c),this},ca.Stream.prototype.editableAccidentalCanvas=function(a,b){var c=e("<div/>").css("text-align","left").css("position","relative"),d=this.getAccidentalToolbar();return c.append(d),c.append(e("<br clear='all'/>")),this.renderOptions.events.click=this.canvasChangerFunction,this.appendNewCanvas(c,a,b),c},ca.Stream.prototype.getAccidentalToolbar=function(a,b){void 0===a&&(a=-1),void 0===b&&(b=1),a=Math.round(a),b=Math.round(b);var c=function(a,b){var c=e(a).parent(),d=c.parent().find("canvas"),f=d[0].storedStream;void 0!==f.activeNote&&(n=f.activeNote,n.pitch.accidental=new H.Accidental(b),f.redrawCanvas(d[0]),void 0!==f.changedCallbackFunction&&f.changedCallbackFunction({canvas:d[0]}))},d=e("<div/>").attr("class","buttonToolbar vexflowToolbar").css("position","absolute").css("top","10px");d.append(e("<span/>").css("margin-left","50px"));for(var f=function(){c(this,e(this).data("alter"))},g=a;g<=b;g++){var h=new music21.pitch.Accidental(g);d.append(e("<button>"+h.unicodeModifier+"</button>").data("alter",g).click(f))}return d},ca.Stream.prototype.getPlayToolbar=function(){var a=e("<div/>").attr("class","playToolbar vexflowToolbar").css("position","absolute").css("top","10px");return a.append(e("<span/>").css("margin-left","50px")),a.append(e("<button>&#9658</button>").click(function(){this.playStream()}.bind(this))),a.append(e("<button>&#9724</button>").click(function(){this.stopPlayStream()}.bind(this))),a},ca.Stream.prototype.windowReflowStart=function(a){var b=this,c=a;return e(window).bind("resizeEnd",function(){var a=c.parent(),d=a.width(),f=d;console.log("resizeEnd triggered",d),b.resetRenderOptions(!0,!0),b.maxSystemWidth=f-40,c.remove();var g=b.appendNewCanvas(a);c=e(g)}),e(window).resize(function(){this.resizeTO&&clearTimeout(this.resizeTO),this.resizeTO=setTimeout(function(){e(this).trigger("resizeEnd")},200)}),setTimeout(function(){var a=e(window),b=a.data("triggerResizeOnCreateCanvas");void 0!==b&&b!==!0||(e(this).trigger("resizeEnd"),a.data("triggerResizeOnCreateCanvas",!1))},1e3),this},ca.Stream.prototype.hasVoices=function(){for(var a=0;a<this.length;a++){var b=this.get(a);if(b.isClassOrSubclass("Voice"))return!0}return!1},ca.Voice=function(){ca.Stream.call(this),this.classes.push("Voice")},ca.Voice.prototype=new ca.Stream,ca.Voice.prototype.constructor=ca.Voice,ca.Measure=function(){ca.Stream.call(this),this.classes.push("Measure"),this.number=0},ca.Measure.prototype=new ca.Stream,ca.Measure.prototype.constructor=ca.Measure,ca.Part=function(){ca.Stream.call(this),this.classes.push("Part"),this.systemHeight=this.renderOptions.naiveHeight},ca.Part.prototype=new ca.Stream,ca.Part.prototype.constructor=ca.Part,ca.Part.prototype.numSystems=function(){for(var a=0,b=this.getElementsByClass("Stream"),c=0;c<b.length;c++)b.get(c).renderOptions.startNewSystem&&a++;return 0===a&&(a=1),a},ca.Part.prototype.getMeasureWidths=function(){for(var a=[],b=0;b<this.length;b++){var c=this.get(b);if(c.isClassOrSubclass("Measure")){var d=c.renderOptions;a[d.measureIndex]=d.width}}return a},ca.Part.prototype.estimateStaffLength=function(){if(void 0!==this.renderOptions.overriddenWidth)return this.renderOptions.overriddenWidth;if(this.hasSubStreams()){for(var a=0,b=this.getElementsByClass("Measure"),c=0;c<b.length;c++){var d=b.get(c);if(a+=d.estimateStaffLength()+d.renderOptions.staffPadding,0!==c&&d.renderOptions.startNewSystem===!0)break}return a}var e=new ca.Measure;return e.elements=this.elements,e.estimateStaffLength()},ca.Part.prototype.fixSystemInformation=function(a){void 0===a?a=this.systemHeight:music21.debug&&console.log("overridden systemHeight: "+a);var b=this.renderOptions.systemPadding||this.renderOptions.naiveSystemPadding,c=this.getMeasureWidths(),d=this.maxSystemWidth,e=[],f=[],g=0,h=20,i=h,j=void 0;for(j=0;j<c.length;j++){var k=i+c[j];k>d&&g!=j?(f.push(j-1),e.push(i),i=h+c[j],g=j):i=k}var l=0,m=0;for(j=0;j<this.length;j++){var n=this.get(j);if(void 0!==n.renderOptions){0===j&&(n.renderOptions.startNewSystem=!0),i=n.renderOptions.left,f.indexOf(j-1)!=-1?(m=i-20,n.renderOptions.displayClef=!0,n.renderOptions.displayKeySignature=!0,n.renderOptions.startNewSystem=!0,l++):0!==j&&(n.renderOptions.startNewSystem=!1,n.renderOptions.displayClef=!1,n.renderOptions.displayKeySignature=!1),n.renderOptions.systemIndex=l;var o=void 0;if(l>=e.length)o=1;else{var p=e[l];o=d/p}var q=i-m;n.renderOptions.left=Math.floor(q*o),n.renderOptions.width=Math.floor(n.renderOptions.width*o);var r=n.renderOptions.top+l*(a+b);n.renderOptions.top=r}}return e},ca.Part.prototype.setSubstreamRenderOptions=function(){for(var a=0,b=20,c=this.renderOptions,d=void 0,e=void 0,f=void 0,g=0;g<this.length;g++){var h=this.get(g);if(h.isClassOrSubclass("Measure")){var i=h.renderOptions;i.measureIndex=a,i.top=c.top,i.partIndex=c.partIndex,i.left=b,0===a?(f=h._clef,d=h._timeSignature,e=h._keySignature,i.displayClef=!0,i.displayKeySignature=!0,i.displayTimeSignature=!0):(void 0!==h._clef&&void 0!==f&&h._clef.name!=f.name?(console.log("changing clefs for ",i.measureIndex," from ",f.name," to ",h._clef.name),f=h._clef,i.displayClef=!0):i.displayClef=!1,void 0!==h._keySignature&&void 0!==e&&h._keySignature.sharps!=e.sharps?(e=h._keySignature,
i.displayKeySignature=!0):i.displayKeySignature=!1,void 0!==h._timeSignature&&void 0!==d&&h._timeSignature.ratioString!=d.ratioString?(d=h._timeSignature,i.displayTimeSignature=!0):i.displayTimeSignature=!1),i.width=h.estimateStaffLength()+i.staffPadding,i.height=h.estimateStreamHeight(),b+=i.width,a++}}return this},ca.Part.prototype.findNoteForClick=function(a,b){var c=this.getScaledXYforCanvas(a,b),d=c[0],f=c[1];music21.debug&&console.log("this.estimateStreamHeight(): "+this.estimateStreamHeight()+" / $(canvas).height(): "+e(a).height());var g=this.renderOptions.systemPadding;void 0===g&&(g=this.renderOptions.naiveSystemPadding);var h=Math.floor(f/(this.systemHeight+g)),i=f-h*(this.systemHeight+g),j=this.diatonicNoteNumFromScaledY(i),k=this.noteElementFromScaledX(d,void 0,h);return[j,k]},ca.Part.prototype.noteElementFromScaledX=function(a,b,c){for(var d=void 0,e=0;e<this.length;e++){var f=this.get(e),g=f.renderOptions,h=g.left,i=h+g.width,j=g.top,k=j+g.height;if(music21.debug&&console.log("Searching for X:"+Math.round(a)+" in M "+e+" with boundaries L:"+h+" R:"+i+" T: "+j+" B: "+k),a>=h&&a<=i){if(void 0===c){d=f;break}if(g.systemIndex==c){d=f;break}}}if(d)return d.noteElementFromScaledX(a,b)},ca.Score=function(){ca.Stream.call(this),this.classes.push("Score"),this.measureWidths=[],this.partSpacing=this.renderOptions.naiveHeight,Object.defineProperties(this,{systemPadding:{enumerable:!0,configurable:!0,get:function(){var a=this.parts.length,b=this.renderOptions.systemPadding;return void 0===b&&(b=1==a?this.renderOptions.naiveSystemPadding:this.renderOptions.naiveSystemPadding),b}}})},ca.Score.prototype=new ca.Stream,ca.Score.prototype.constructor=ca.Score,ca.Score.prototype.setSubstreamRenderOptions=function(){var a=0,b=0,c=this.partSpacing,d=void 0,e=void 0;for(d=0;d<this.length;d++)e=this.get(d),e.isClassOrSubclass("Part")&&(e.renderOptions.partIndex=a,e.renderOptions.top=b,e.setSubstreamRenderOptions(),b+=c,a++);this.evenPartMeasureSpacing();var f=!0,g=this.estimateStreamHeight(f);for(d=0;d<this.length;d++)e=this.get(d),e.isClassOrSubclass("Part")&&e.fixSystemInformation(g);return this.renderOptions.height=this.estimateStreamHeight(),this},ca.Score.prototype.estimateStaffLength=function(){if(void 0!==this.renderOptions.overriddenWidth)return this.renderOptions.overriddenWidth;for(var a=0;a<this.length;a++){var b=this.get(a);if(b.isClassOrSubclass("Part"))return b.estimateStaffLength()}console.log("no parts found in score");var c=new ca.Part;return c.elements=this.elements,c.estimateStaffLength()},ca.Score.prototype.playStream=function(a){for(var b=0;b<this.length;b++){var c=this.get(b);c.isClassOrSubclass("Part")&&c.playStream(a)}return this},ca.Score.prototype.stopPlayStream=function(){for(var a=0;a<this.length;a++){var b=this.get(a);b.isClassOrSubclass("Part")&&b.stopPlayStream()}return this},ca.Score.prototype.getMaxMeasureWidths=function(){var a=[],b=[],c=void 0;for(c=0;c<this.length;c++){var d=this.get(c);b.push(d.getMeasureWidths())}for(c=0;c<b[0].length;c++){for(var e=0,f=0;f<this.length;f++)b[f][c]>e&&(e=b[f][c]);a.push(e)}return a},ca.Score.prototype.findNoteForClick=function(a,b){var c=this.getScaledXYforCanvas(a,b),d=c[0],e=c[1],f=this.parts.length,g=f*this.partSpacing+this.systemPadding,h=Math.floor(e/g),i=e-h*g,j=Math.floor(i/this.partSpacing),k=i-j*this.partSpacing,l=this.get(j),m=l.diatonicNoteNumFromScaledY(k),n=l.noteElementFromScaledX(d,void 0,h);return[m,n]},ca.Score.prototype.numSystems=function(){return this.getElementsByClass("Part").get(0).numSystems()},ca.Score.prototype.evenPartMeasureSpacing=function(){var a=[],b=0,c=[],d=void 0,e=void 0;for(d=0;d<this.length;d++){var f=this.get(d);if(f.isClassOrSubclass("Part")){var g=f.getMeasureWidths();for(e=0;e<g.length;e++){var h=g[e];void 0===a[e]?(a[e]=[],c[e]=h):h>c[e]&&(c[e]=h),a[e][b]=h}b++}}var i=20;for(d=0;d<c.length;d++){var j=c[d];for(e=0;e<this.length;e++){var k=this.get(e),l=k.get(d),m=l.renderOptions;m.width=j,m.left=i}i+=j}return this},ca.OffsetMap=function(a,b,c,d){this.element=a,this.offset=b,this.endTime=c,this.voiceIndex=d},ca.tests=function(){test("music21.stream.Stream",function(){var a=new music21.stream.Stream;a.append(new music21.note.Note("C#5")),a.append(new music21.note.Note("D#5"));var b=new music21.note.Note("F5");b.duration.type="half",a.append(b),equal(a.length,3,"Simple stream length")}),test("music21.stream.Stream.duration",function(){var a=new music21.stream.Stream;equal(a.duration.quarterLength,0,"EmptyString QuarterLength"),a.append(new music21.note.Note("C#5")),equal(a.duration.quarterLength,1,"1 quarter QuarterLength");var b=new music21.note.Note("F5");b.duration.type="half",a.append(b),equal(a.duration.quarterLength,3,"3 quarter QuarterLength"),a.duration=new music21.duration.Duration(3),a.append(new music21.note.Note("D#5")),equal(a.duration.quarterLength,3,"overridden duration -- remains");var c=new music21.stream.Score,d=new music21.stream.Part,e=new music21.stream.Part,f=new music21.stream.Measure,g=new music21.stream.Measure,h=new music21.note.Note,i=new music21.note.Note;i.duration.type="half";var j=new music21.note.Note;j.duration.type="eighth",f.append(h),f.append(i),f.append(j);var k=new music21.note.Note;k.duration.type="whole",g.append(k),d.append(f),e.append(g),c.insert(0,d),c.insert(0,e),equal(c.duration.quarterLength,4,"duration of streams with nested parts"),equal(c.flat.duration.quarterLength,4,"duration of flat stream with overlapping notes"),k.duration.type="half",equal(c.duration.quarterLength,3.5,"new duration with nested parts"),equal(c.flat.duration.quarterLength,3.5,"new duration of flat stream")}),test("music21.stream.Stream.insert and offsets",function(){var a=new music21.stream.Stream;a.append(new music21.note.Note("C#5"));var b=new music21.note.Note("E5");a.insert(2,b);var c=new music21.note.Note("D#5");a.insert(1,c),equal(a.get(0).name,"C#"),equal(a.get(1).name,"D#"),equal(a.get(2).name,"E"),equal(a.get(0).offset,0),equal(a.get(1).offset,1),equal(a.get(2).offset,2);var d=new music21.stream.Part,e=new music21.stream.Measure,f=new music21.note.Note("C#");f.duration.type="whole",e.append(f);var g=new music21.stream.Measure;c=new music21.note.Note("D#"),c.duration.type="whole",g.append(c),d.append(e),d.append(g),equal(d.get(0).get(0).offset,0);var h=d.flat;equal(h.get(1).offset,4);var i=d.flat;equal(i.get(1).offset,4,"repeated calls do not change offset");var j=i.flat;equal(j.get(1).offset,4,".flat.flat does not change offset")}),test("music21.stream.Stream.canvas",function(){var a=new music21.stream.Stream;a.append(new music21.note.Note("C#5")),a.append(new music21.note.Note("D#5"));var b=new music21.note.Note("F5");b.duration.type="half",a.append(b);var c=a.createNewCanvas(100,50);equal(c.attr("width"),100,"stored width matches"),equal(c.attr("height"),50,"stored height matches")}),test("music21.stream.Stream.getElementsByClass",function(){var a=new music21.stream.Stream,b=new music21.note.Note("C#5"),c=new music21.note.Note("D#5"),d=new music21.note.Rest,e=new music21.clef.TrebleClef;a.append(e),a.append(b),a.append(d),a.append(c);var f=a.getElementsByClass("Note");equal(f.length,2,"got two notes"),equal(f.get(0),b,"n1 first"),equal(f.get(1),c,"n2 second"),f=a.getElementsByClass("Clef"),equal(f.length,1,"got clef from subclass"),f=a.getElementsByClass(["Note","TrebleClef"]),equal(f.length,3,"got multiple classes"),f=a.getElementsByClass("GeneralNote"),equal(f.length,3,"got multiple subclasses")}),test("music21.stream.offsetMap",function(){var a=new music21.note.Note("G3"),b=new music21.note.Note("A3"),c=new music21.stream.Measure;c.insert(0,a),c.insert(.5,b);var d=c.offsetMap();equal(d.length,2,"offsetMap should have length 2");var e=d[0],f=d[1];equal(e.element,a,"omn element should be n"),equal(e.offset,0,"omn offset should be 0"),equal(e.endTime,1,"omn endTime should be 1.0"),equal(e.voiceIndex,void 0,"omn voiceIndex should be undefined"),equal(f.element,b,"omo element should be o"),equal(f.offset,.5,"omo offset should be 0.5"),equal(f.endTime,1.5,"omo endTime should be 1.5")}),test("music21.stream.Stream appendNewCanvas ",function(){var a=new music21.note.Note("G3"),b=new music21.stream.Measure;b.append(a),b.appendNewCanvas(document.body),equal(b.length,1,"ensure that should have one note");var c=new music21.note.Note("G3"),d=new music21.stream.Measure;d.append(c);var f=new music21.note.Note("G3");d.append(f);var g=new music21.note.Note("G3");d.append(g);var h=new music21.note.Note("G3");d.append(h);var i=d.editableAccidentalCanvas();e(document.body).append(i)})};var da={};da.makeLayoutFromScore=function(a,b){var c=a.parts,d=c.length,e=c[0],f=e.length,g=e.getMeasureWidths(),h=b||a.maxSystemWidth,i=new music21.layout.LayoutScore,j=new music21.layout.Page;j.measureStart=1,j.measureEnd=f,i.insert(0,j);var k=new music21.layout.System;currentSystemNumber=1,k.measureStart=1;var l=function(a,b,c){for(var d=0;d<b;d++){var e=new music21.layout.Staff;e.measureStart=c,e.staffNumber=d+1,a.push(e)}};l(currentStaves,d,1);for(var m=[],n=[],o=0,p=20,q=p,r=0,s=!0,t=a.estimateStreamHeight(s),u=0;u<g.length;u++){var v=q+g[u];if(v>h&&o!=u){for(var w=0;w<currentStaves.length;w++)currentStaves.measureEnd=u,k.insert(0,currentStaves[w]);currentStaves=[],l(currentStaves,d,u+1),r+=t,k.measureEnd=u,j.insert(0,k),currentSystemNumber+=1,k=new music21.layout.System,k.measureStart=u+1,k.systemNumber=currentSystemNumber,n.push(u-1),m.push(q),console.log("setting new width at "+q+" measure "+u),q=p+g[u],o=u}else q=v;for(var x=0;x<currentStaves.length;x++)currentStaves[x].append(c[x].get(u))}for(var w=0;w<currentStaves.length;w++)currentStaves.measureEnd=g.length-1,k.insert(0,currentStaves[w]);return j.insert(0,k),i},da.LayoutScore=function(){ca.Score.call(this),this.classes.push("LayoutScore"),this.scoreLayout=void 0,this.measureStart=void 0,this.measureEnd=void 0,this._width=void 0,this.height=void 0,this.top=0,this.left=0,Object.defineProperties(this,{pages:{configurable:!0,enumerable:!0,get:function(){return this.getElementsByClass("Page")}},width:{configurable:!0,enumerable:!0,get:function(){return this._width?this._width:this.activeSite?this.activeSite.width:void 0}}})},da.LayoutScore.prototype=new ca.Score,da.LayoutScore.prototype.constructor=da.LayoutScore,da.LayoutScore.prototype.getPositionForStaff=function(a,b,c,d){d=d||"pixels"},da.Page=function(){ca.Score.call(this),this.classes.push("Page"),this.pageNumber=1,this.measureStart=void 0,this.measureEnd=void 0,this.systemStart=void 0,this.systemEnd=void 0,this.pageLayout=void 0,Object.defineProperties(this,{systems:{configurable:!0,enumerable:!0,get:function(){return this.getElementsByClass("System")}},width:{configurable:!0,enumerable:!0,get:function(){return this._width?this._width:this.activeSite?this.activeSite.width:void 0}}})},da.Page.prototype=new ca.Score,da.Page.prototype.constructor=da.Page,da.System=function(){ca.Score.call(this),this.classes.push("System"),this.systemNumber=1,this.systemLayout=void 0,this.measureStart=void 0,this.measureEnd=void 0,this._width=void 0,this.height=void 0,this.top=void 0,this.left=void 0,Object.defineProperties(this,{staves:{configurable:!0,enumerable:!0,get:function(){return this.getElementsByClass("Staff")}},width:{configurable:!0,enumerable:!0,get:function(){return this._width?this._width:this.activeSite?this.activeSite.width:void 0}}})},da.System.prototype=new ca.Score,da.System.prototype.constructor=da.System,da.Staff=function(){ca.Part.call(this),this.classes.push("Staff"),this.staffNumber=1,this.optimized=0,this.top=void 0,this.left=void 0,this._width=void 0,this.height=void 0,this.inheritedHeight=void 0,this.staffLayout=void 0,Object.defineProperties(this,{width:{configurable:!0,enumerable:!0,get:function(){return this._width?this._width:this.activeSite?this.activeSite.width:void 0}}})},da.Staff.prototype=new ca.Part,da.Staff.prototype.constructor=da.Staff;var ea={};ea.romanToNumber=[void 0,"i","ii","iii","iv","v","vi","vii"],ea.RomanNumeral=function(a,b){this.figure=a,this._scale=void 0,this._key=void 0,M.Chord.call(this),this.classes.push("RomanNumeral"),Object.defineProperties(this,{scale:{enumerable:!0,get:function(){return void 0!=this._scale?this._scale:(this._scale=this.key.getScale(),this._scale)}},key:{enumerable:!0,get:function(){return this._key},set:function(a){"string"==typeof a?this._key=new W.Key(a):"undefined"==typeof a?this._key=new W.Key("C"):this._key=a}},degreeName:{enumerable:!0,get:function(){if(this.scaleDegree<7)return[void 0,"Tonic","Supertonic","Mediant","Subdominant","Dominant","Submediant"][this.scaleDegree];var a=new H.Pitch(this.key.tonic),b=(a.ps-this.root.ps)%12;return b<0&&(b+=12),1==b?"Leading-tone":"Subtonic"}}}),this.key=b;var c=a,d="major",e=c.toLowerCase();c.match("/o")?(d="half-diminished",c=c.replace("/o","")):c.match("o")?(d="diminished",c=c.replace("o","")):c==e&&(d="minor");var f=c.match(/\d+/);this.numbers=void 0,null!=f&&(c=c.replace(/\d+/,""),this.numbers=parseInt(f[0]));var g=ea.romanToNumber.indexOf(c.toLowerCase());if(g==-1)throw"Cannot make a romanNumeral from "+c;if(this.scaleDegree=g,this.root=this.scale[this.scaleDegree-1],"minor"==this.key.mode&&(6==this.scaleDegree||7==this.scaleDegree)&&["minor","diminished","half-diminished"].indexOf(d)!=-1){var h=new U.Interval("A1");this.root=h.transposePitch(this.root),music21.debug&&console.log("raised root because minor/dim on scaleDegree 6 or 7")}7==this.numbers&&(5==g&&"major"==d?d="dominant-seventh":d+="-seventh"),this.impliedQuality=d,this.updatePitches()},ea.RomanNumeral.prototype=new M.Chord,ea.RomanNumeral.prototype.constructor=ea.RomanNumeral,ea.RomanNumeral.prototype.updatePitches=function(){for(var a=this.impliedQuality,b=M.chordDefinitions[a],c=[this.root],d=this.root,e=0;e<b.length;e++){var f=b[e],g=new U.Interval(f),h=g.transposePitch(d);c.push(h),d=h}this.pitches=c},ea.RomanNumeral.prototype.asString=function(a,b){var c=this.key,d=c.tonic,e=c.mode;void 0===b&&(b=0);var f="";1==b?f="roman"==a?"6":" (first inversion)":2==b&&(f="roman"==a?"64":" (second inversion)");var g=void 0,h=" in ",i="";"roman"==a?g=this.figure:"nameOnly"==a?(g="",h="",i=" triad"):"bassName"==a?(g=this.bass().name.replace(/\-/,"b"),h=" in ",i=""):(g=this.degreeName,void 0!=this.numbers&&(g+=" "+this.numbers.toString()));var j=d.replace(/\-/,"b");"minor"==e&&(j=j.toLowerCase());var k=g+f+h+j+" "+e+i;return k},ea.tests=function(){test("music21.roman.RomanNumeral",function(){var a="IV",b=new music21.roman.RomanNumeral(a,"F");equal(b.scaleDegree,4,"test scale dgree of F IV");var c=b.scale;equal(c[0].name,"F","test scale is F"),equal(b.root.name,"B-","test root of F IV"),equal(b.impliedQuality,"major","test quality is major"),equal(b.pitches[0].name,"B-","test pitches[0] == B-"),equal(b.pitches[1].name,"D","test pitches[1] == D"),equal(b.pitches[2].name,"F","test pitches[2] == F"),equal(b.degreeName,"Subdominant","test is Subdominant");var d="viio7";b=new music21.roman.RomanNumeral(d,"a"),equal(b.scaleDegree,7,"test scale dgree of A viio7"),equal(b.root.name,"G#","test root name == G#"),equal(b.impliedQuality,"diminished-seventh","implied quality"),equal(b.pitches[0].name,"G#","test pitches[0] == G#"),equal(b.pitches[1].name,"B","test pitches[1] == B"),equal(b.pitches[2].name,"D","test pitches[2] == D"),equal(b.pitches[3].name,"F","test pitches[3] == F"),equal(b.degreeName,"Leading-tone","test is Leading-tone"),d="V7",b=new music21.roman.RomanNumeral(d,"a"),equal(b.scaleDegree,5,"test scale dgree of a V7"),equal(b.root.name,"E","root name is E"),equal(b.impliedQuality,"dominant-seventh","implied quality dominant-seventh"),equal(b.pitches[0].name,"E","test pitches[0] == E"),equal(b.pitches[1].name,"G#","test pitches[1] == G#"),equal(b.pitches[2].name,"B","test pitches[2] == B"),equal(b.pitches[3].name,"D","test pitches[3] == D"),equal(b.degreeName,"Dominant","test is Dominant"),d="VII",b=new music21.roman.RomanNumeral(d,"f#"),equal(b.scaleDegree,7,"test scale dgree of a VII"),equal(b.root.name,"E","root name is E"),equal(b.impliedQuality,"major","implied quality major"),equal(b.pitches[0].name,"E","test pitches[0] == E"),equal(b.pitches[1].name,"G#","test pitches[1] == G#"),equal(b.pitches[2].name,"B","test pitches[2] == B"),equal(b.degreeName,"Subtonic","test is Subtonic")}),test("music21.roman.RomanNumeral - inversions",function(){var a="IV",b=new music21.roman.RomanNumeral(a,"F");equal(b.scaleDegree,4,"test scale dgree of F IV");var c=b.scale;equal(c[0].name,"F","test scale is F"),equal(b.root.name,"B-","test root of F IV"),equal(b.impliedQuality,"major","test quality is major"),equal(b.pitches[0].name,"B-","test pitches[0] == B-"),equal(b.pitches[1].name,"D","test pitches[1] == D"),equal(b.pitches[2].name,"F","test pitches[2] == F"),equal(b.degreeName,"Subdominant","test is Subdominant")})};var fa={};fa.defaultTempoValues={larghissimo:16,largamente:32,grave:40,"molto adagio":40,largo:46,lento:52,adagio:56,slow:56,langsam:56,larghetto:60,adagietto:66,andante:72,andantino:80,"andante moderato":83,maestoso:88,moderato:92,moderate:92,allegretto:108,animato:120,"allegro moderato":128,allegro:132,fast:132,schnell:132,allegrissimo:140,"molto allegro":144,"très vite":144,vivace:160,vivacissimo:168,presto:184,prestissimo:208},fa.baseTempo=60,fa.Metronome=function(a){q.ProtoM21Object.call(this),this.classes.push("Metronome"),this._tempo=60,void 0===a?this.tempo=fa.baseTempo:this.tempo=a,this.numBeatsPerMeasure=4,this.minTempo=10,this.maxTempo=600,this.beat=this.numBeatsPerMeasure,this.chirpTimeout=void 0,this.silent=!1,this.flash=!1,Object.defineProperties(this,{tempo:{enumerable:!0,get:function(){return this._tempo},set:function(a){this._tempo=a,this._tempo>this.maxTempo?this._tempo=this.maxTempo:this._tempo<this.minTempo&&(this._tempo=this.minTempo)}},beatLength:{enumerable:!0,get:function(){return 60/this.tempo}}})},fa.Metronome.prototype=new q.ProtoM21Object,fa.Metronome.prototype.constructor=fa.Metronome,fa.Metronome.prototype._silentFlash=function(a){this.$metronomeDiv.find(".metroFlash").css("background-color",a).fadeOut(1e3*this.beatLength*1/4,function(){$(this).css("background-color","#ffffff").fadeIn(1)})},fa.Metronome.prototype.chirp=function(){this.beat+=1,this.beat>this.numBeatsPerMeasure?(this.beat=1,1!=this.silent&&(music21.MIDI.noteOn(0,96,100,0),music21.MIDI.noteOff(0,96,.1)),1==this.flash&&this._silentFlash("#0000f0")):(1!=this.silent&&(music21.MIDI.noteOn(0,84,70,0),music21.MIDI.noteOff(0,84,.1)),1==this.flash&&this._silentFlash("#ff0000"));var a=this;this.chirpTimeout=setTimeout(function(){a.chirp()},6e4/this.tempo)},fa.Metronome.prototype.stopChirp=function(){void 0!=this.chirpTimeout&&(clearTimeout(this.chirpTimeout),this.chirpTimeout=void 0)},fa.Metronome.prototype.tempoRanges=[0,40,60,72,120,144,240,999],fa.Metronome.prototype.tempoIncreases=[0,1,2,3,4,6,8,15,100],fa.Metronome.prototype.increaseSpeed=function(a){void 0===a&&(a=1);for(var b=0;b<a;b++){t=this.tempo;for(var c=0;c<this.tempoRanges.length;c++){var d=this.tempoRanges[c],e=this.tempoIncreases[c];if(t<d){t+=e,t=e*Math.round(t/e);break}}this.tempo=t}return this.tempo},fa.Metronome.prototype.decreaseSpeed=function(a){void 0===a&&(a=1);for(var b=0;b<a;b++){t=this.tempo,trL=this.tempoRanges.length;for(var c=1;c<=trL;c++){var d=this.tempoRanges[trL-c],e=this.tempoIncreases[trL-c+1];if(t>d){t-=e,t=e*Math.floor(t/e);break}}this.tempo=t}},fa.Metronome.prototype.addDiv=function(a){var b=void 0;b=void 0!==a&&void 0!==a.jquery?a:void 0!==a?$(a):$("body");var c=this,d=$('<span class="tempoHolder">'+this.tempo.toString()+"</span>").css({"font-size":"24px","padding-left":"10px","padding-right":"10px"}),e=$('<div class="metronomeRendered"></div>');e.append(d);var f=$("<button>start</button>");f.on("click",function(){c.chirp()});var g=$("<button>stop</button>");g.on("click",function(){c.stopChirp()}),e.prepend(g),e.prepend(f);var h=$("<button>up</button>");h.on("click",function(){c.increaseSpeed(),$(this).prevAll(".tempoHolder").html(c.tempo.toString())});var i=$("<button>down</button>");i.on("click",function(){c.decreaseSpeed(),$(this).prevAll(".tempoHolder").html(c.tempo.toString())}),e.append(h),e.append(i);var j=$('<span class="metroFlash">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>');return j.css("margin-left","40px").css("height","40px"),e.append(j),b.append(e),this.$metronomeDiv=e,e};var ga={},ha=function(a){function b(a){k(this,b);var c=o(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return c.type=a,c.style="normal",c}return m(b,a),b}(q.ProtoM21Object);ga.Tie=ha;var ia={};ia.regularExpressions={REST:/r/,OCTAVE2:/([A-G])[A-G]+/,OCTAVE3:/([A-G])/,OCTAVE5:/([a-g])(\'+)/,OCTAVE4:/([a-g])/,EDSHARP:/\((\#+)\)/,EDFLAT:/\((\-+)\)/,EDNAT:/\(n\)/,SHARP:/^[A-Ga-g]+\'*(\#+)/,FLAT:/^[A-Ga-g]+\'*(\-+)/,NAT:/^[A-Ga-g]+\'*n/,TYPE:/(\d+)/,TIE:/.\~/,PRECTIE:/\~/,ID_EL:/\=([A-Za-z0-9]*)/,LYRIC:/\_(.*)/,DOT:/\.+/,TIMESIG:/(\d+)\/(\d+)/,TRIP:/trip\{/,QUAD:/quad\{/,ENDBRAC:/\}$/},ia.TinyNotation=function(a){a=a.trim();for(var b=a.split(" "),c=new ca.Part,d=new ca.Measure,e=4,f=1,g={lastNoteTied:!1,inTrip:!1,inQuad:!1,endTupletAfterNote:!1},h=ia.regularExpressions,i=0;i<b.length;i++){d.duration.quarterLength>=e&&(c.append(d),d=new ca.Measure);var j=b[i],k=void 0,l=void 0;if((l=h.TRIP.exec(j))&&(j=j.slice(5),g.inTrip=!0),(l=h.QUAD.exec(j))&&(j=j.slice(5),g.inQuad=!0),(l=h.ENDBRAC.exec(j))&&(j=j.slice(0,-1),g.endTupletAfterNote=!0),l=h.TIMESIG.exec(j)){var m=new aa.TimeSignature;m.numerator=parseInt(l[1]),m.denominator=parseInt(l[2]),d.timeSignature=m,e=m.barDuration.quarterLength}else if(h.REST.exec(j)?k=new L.Rest(f):(l=h.OCTAVE2.exec(j))?(k=new L.Note(l[1],f),k.pitch.octave=4-l[0].length):(l=h.OCTAVE3.exec(j))?(k=new L.Note(l[1],f),k.pitch.octave=3):(l=h.OCTAVE5.exec(j))?(k=new L.Note(l[1].toUpperCase(),f),k.pitch.octave=3+l[0].length):(l=h.OCTAVE4.exec(j))&&(k=new L.Note(l[1].toUpperCase(),f),k.pitch.octave=4),void 0!=k){if(h.TIE.exec(j)?(k.tie=new ga.Tie("start"),g.lastNoteTied&&(k.tie.type="continue"),g.lastNoteTied=!0):g.lastNoteTied&&(k.tie=new ga.Tie("stop"),g.lastNoteTied=!1),h.SHARP.exec(j)?k.pitch.accidental=new H.Accidental("sharp"):h.FLAT.exec(j)?k.pitch.accidental=new H.Accidental("flat"):h.NAT.exec(j)&&(k.pitch.accidental=new H.Accidental("natural"),k.pitch.accidental.displayType="always"),l=h.TYPE.exec(j)){var n=parseInt(l[0]);k.duration.quarterLength=4/n}if(l=h.DOT.exec(j)){var o=l[0].length,p=1+(1-Math.pow(.5,o));k.duration.quarterLength=p*k.duration.quarterLength}f=k.duration.quarterLength,g.inTrip&&k.duration.appendTuplet(new r.Tuplet(3,2,k.duration.quarterLength)),g.inQuad&&k.duration.appendTuplet(new r.Tuplet(4,3,k.duration.quarterLength)),g.endTupletAfterNote&&(g.inTrip=!1,g.inQuad=!1,g.endTupletAfterNote=!1),d.append(k)}}if(c.length>0){c.append(d);var q=N.bestClef(c);return c.clef=q,c}return d.clef=N.bestClef(d),d},ia.renderNotationDivs=function(a,b){void 0==a&&(a=".music21.tinyNotation");var c=[];void 0==b?c=$(a):(void 0==b.jquery&&(b=$(b)),c=b.find(a));for(var d=0;d<c.length;d++){var e=c[d],f=$(e),g=void 0;if(void 0!==f.attr("tinynotationcontents")?g=f.attr("tinynotationcontents"):void 0!=e.textContent&&(g=e.textContent,g=g.replace(/s+/g," ")),void 0!=String.prototype.trim&&void 0!=g&&(g=g.trim()),g){var h=ia.TinyNotation(g);f.hasClass("noPlayback")&&(h.renderOptions.events.click=void 0);var i=h.createCanvas();f.attr("tinynotationcontents",g),f.empty(),f.data("stream",h),f.append(i)}}};var ja={};ja.selectedOutputPort=void 0,ja.selectedInputPort=void 0,ja.access=void 0,ja.$selectDiv=void 0,ja.jazzDownloadUrl="http://jazz-soft.net/download/Jazz-Plugin/",ja.storedPlugin=void 0,ja.selectedJazzInterface=void 0,ja.callBacks={raw:function(a,b,c,d){return new X.Event(a,b,c,d)},general:[X.sendToMIDIjs,X.quantizeLastNote],sendOutChord:function(a){}},ja.jazzMidiInArrived=function(a,b,c,d){var e={timestamp:a,data:[b,c,d]};return ja.midiInArrived(e)},ja.midiInArrived=function(d){t=d.timeStamp,a=d.data[0],b=d.data[1],c=d.data[2];var e=ja.callBacks.raw(t,a,b,c);if(ja.callBacks.general instanceof Array)ja.callBacks.general.forEach(function(a,b,c){a(e)});else if(void 0!==ja.callBacks.general)return ja.callBacks.general(e)},ja.createPlugin=function(a,b){if(ja.storedPlugin&&1!=b)return ja.storedPlugin;"undefined"==typeof a&&(a=e("body")[0]);var c=document.createElement("object");return c.classid="CLSID:1ACE1618-1C7D-4561-AEE1-34842AA85E90",c.isJazz||(c.type="audio/x-jazz"),c.style.visibility="hidden",c.style.width="0px",c.style.height="0px",a.appendChild(c),c.isJazz?(ja.storedPlugin=c,c):(a.removeChild(c),void console.error("Cannot use jazz plugin; install at "+ja.jazzDownloadUrl))},ja.createJazzSelector=function(a,b){params={},i.merge(params,b);var c=ja.createPlugin();if(void 0!==c){a.change(function(){var a=e("#midiInSelect option:selected").text();"None selected"!=a?ja.selectedJazzInterface=c.MidiInOpen(a,ja.jazzMidiInArrived):c.MidiInClose(),music21.debug&&console.log("current input changed to: "+ja.selectedInterface)});var d=c.MidiInList(),f=e("<option value='None'>None selected</option>");a.append(f);for(var g=!1,h=[],j=0;j<d.length;j++){var k=e("<option value='"+d[j]+"'>"+d[j]+"</option>");d[j]==ja.selectedJazzInterface&&(k.attr("selected",!0),g=!0),h.push(k),a.append(k)}0==g&&d.length>0?(a.val(d[0]),h[0].attr("selected",!0),ja.selectedJazzInterface=c.MidiInOpen(d[0],ja.jazzMidiInArrived),g=!0):f.attr("selected",!0),void 0!==params.onsuccess&&params.onsuccess(),g===!0&&void 0!==params.oninputsuccess?params.oninputsuccess():g===!1&&void 0!==params.oninputempty&&params.oninputempty()}},ja.selectionChanged=function(){var a=ja.$select.val();if(a!=ja.selectedInputPort){var b=ja.access.onstatechange;return ja.access.onstatechange=function(){},music21.debug&&console.log("current input changed to: "+a),ja.selectedInputPort=a,ja.access.inputs.forEach(function(b){b.name==a?b.onmidimessage=ja.midiInArrived:b.close()}),ja.access.onstatechange=b,!1}},ja.createSelector=function(a,b){var c={autoUpdate:!0,existingMidiSelect:!1};i.merge(c,b),"undefined"==typeof a&&(a=e("body")),void 0==a.jquery&&(a=e(a));var d=void 0,f=a.find("select#midiInSelect");return f.length>0?(d=f[0],c.existingMidiSelect=!0):(d=e("<select>").attr("id","midiInSelect"),a.append(d)),ja.$select=d,void 0===navigator.requestMIDIAccess?ja.createJazzSelector(d,c):(c.existingMidiSelect!==!0&&d.change(ja.selectionChanged),navigator.requestMIDIAccess().then(function(a){ja.access=a,ja.populateSelect(),c.autoUpdate&&(a.onstatechange=ja.populateSelect),ja.$select.change(),void 0!==c.onsuccess&&c.onsuccess(),"None"!==ja.selectedInputPort&&void 0!==c.oninputsuccess?c.oninputsuccess():"None"===ja.selectedInputPort&&void 0!==c.oninputempty&&c.oninputempty()},function(b){a.html(b.message)})),X.clearOldChords(),d},ja.populateSelect=function(){var a=ja.access.inputs;ja.$select.empty();var b=e("<option value='None'>None selected</option>");ja.$select.append(b);var c=[],d=[],f=0;a.forEach(function(a){var b=e("<option value='"+a.name+"'>"+a.name+"</option>");c.push(b),d.push(a.name),ja.$select.append(b),f++}),c.length>0?(ja.$select.val(d[0]),c[0].attr("selected",!0)):b.attr("selected",!0),ja.$select.change()};var ka={};ka.RhythmChooser=function(a,b){this.stream=a,this.canvasDiv=b,this.values=["whole","half","quarter","eighth","16th","dot","undo"],this.stream.hasSubStreams()?this.measureMode=!0:this.measureMode=!1,this.tieActive=!1,this.autoAddMeasure=!0,this.buttonHandlers={undo:function(a){return this.stream.length>0?this.stream.pop():void 0},dot:function(a){if(this.stream.length>0){var b=this.stream.pop();return b.duration.dots+=1,this.stream.append(b),b}},tie:function(a){if(this.stream.length>0){var b=this.stream.get(-1);b.tie=new ga.Tie("start"),this.tieActive=!0}},default:function(a){var b=new L.Note("B4");return b.stemDirection="up",0===a.indexOf("rest_")&&(b=new L.Rest,a=a.slice("rest_".length)),b.duration.type=a,this.tieActive&&(b.tie=new ga.Tie("stop"),this.tieActive=!1),this.stream.append(b),b}},this.measureButtonHandlers={undo:function(a){if(this.stream.length>0){var b=this.stream.get(-1),c=b.pop();return 0===b.length&&this.stream.length>1&&this.stream.pop(),c}},dot:function(a){if(this.stream.length>0){var b=this.stream.get(-1),c=b.pop();return c.duration.dots+=1,b.append(c),c}},addMeasure:function(a){var b=this.stream.get(-1),c=new ca.Measure;c.renderOptions.staffLines=b.renderOptions.staffLines,c.renderOptions.measureIndex=b.renderOptions.measureIndex+1,c.renderOptions.rightBarline="end",b.renderOptions.rightBarline="single",c.autoBeam=b.autoBeam,this.stream.append(c)},tie:function(a){var b=this.stream.get(-1),c=void 0;if(b.length>0)c=b.get(-1);else{var d=this.stream.get(-2);d&&(c=d.get(-1))}if(void 0!==c){var e="start";void 0!==c.tie&&(e="continue"),c.tie=new ga.Tie(e),this.tieActive=!0}},default:function(a){var b=new L.Note("B4");b.stemDirection="up",0===a.indexOf("rest_")&&(b=new L.Rest,a=a.slice("rest_".length)),b.duration.type=a,this.tieActive&&(b.tie=new ga.Tie("stop"),this.tieActive=!1);var c=this.stream.get(-1);return this.autoAddMeasure&&c.duration.quarterLength>=this.stream.timeSignature.barDuration.quarterLength&&(this.measureButtonHandlers.addMeasure.apply(this,[a]),c=this.stream.get(-1)),c.append(b),b}}},ka.RhythmChooser.prototype.valueMappings={whole:"&#xEB9B;&#xE1D2;",half:"&#xEB9B;&#xE1D3;",quarter:"&#xEB9B;&#xE1D5;",eighth:"&#xEB9B;&#xE1D7;","16th":"&#xEB9B;&#xE1D9;","32nd":"&#xEB9B;&#xE1DB;",addMeasure:'<span style="position: relative; top: -20px">&#xE031</span>',dot:"&#xEB9B;&#xE1E7;",undo:"&#x232B;",tie:'<span style="position: relative; top: -20px;">&#xE1FD</span>',rest_whole:"&#xE4F4;",rest_half:"&#xE4F5;",rest_quarter:"&#xE4E5;",rest_eighth:"&#xE4E6;",rest_16th:"&#xE4E7;",rest_32nd:"&#xE4E8;"},ka.RhythmChooser.prototype.styles={undo:"font-family: serif; font-size: 30pt; top: -2px;"},ka.RhythmChooser.prototype.addDiv=function(a){var b=a;void 0!==a&&void 0===a.jquery&&(b=e(a));for(var c=e('<div class="rhythmButtonDiv"/>'),d=0;d<this.values.length;d++){var f=this.values[d],g=this.valueMappings[f],h=e('<button class="btButton" m21Type="'+f+'">'+g+"</button>");void 0!==this.styles[f]&&h.attr("style",this.styles[f]),h.click(function(a){this.handleButton(a)}.bind(this,f)),c.append(h)}return void 0!==a&&b.append(c),c},ka.RhythmChooser.prototype.handleButton=function(a){var b=this.buttonHandlers;this.measureMode&&(b=this.measureButtonHandlers);var c=b[a];void 0===c&&(c=b.default),c.apply(this,[a]);var d=this.stream;d.isClassOrSubclass("Part")&&void 0!==d.activeSite&&(d=d.activeSite),void 0!==this.canvasDiv&&d.replaceCanvas(this.canvasDiv)};var la={};la.common=i,la.prebase=q,la.base=s,la.articulations=u,la.audioSearch=I,la.beam=K,la.chord=M,la.clef=N,la.duration=r,la.expressions=P,la.fromPython=S,la.instrument=T,la.interval=U,la.key=W,la.keyboard=Y,la.layout=da,la.meter=aa,la.miditools=X,la.note=L,la.pitch=H,la.renderOptions=Z,la.roman=ea,la.stream=ca,la.streamInteraction=ba,la.tempo=fa,la.tie=ga,la.tinyNotation=ia,la.vfShow=_,la.webmidi=ja,la.widgets=ka,d.music21=la,Object.defineProperty(d,"__esModule",{value:!0})});
//# sourceMappingURL=music21.min.js.map