/**
 * music21j 0.9.0 built on  * 2017-09-14.
 * Copyright (c) 2013-2016 Michael Scott Cuthbert and cuthbertLab
 * BSD License, see LICENSE
 *
 * http://github.com/cuthbertLab/music21j
 */

!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b(require("jquery"),require("vexflow"),require("MIDI"),require("jsonpickle"),require("eventjs")):"function"==typeof define&&define.amd?define(["jquery","vexflow","MIDI","jsonpickle","eventjs"],b):a.music21=b(a.$,a.Vex,a.MIDI,a.jsonpickle,a.eventjs)}(this,function(a,b,c,d,e){"use strict";function f(a){return a.replace(/-([a-z])/g,function(a){return a[1].toUpperCase()})}function g(b,c,d,e,g){var h=a(c).children(d);if(h){var i=h.contents().eq(0).text();void 0!==i&&""!==i&&(void 0!==g&&(i=g(i)),void 0===e&&(e=f(d)),b[e]=i)}}var h=c.default,i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},j=(function(){function a(a){this.value=a}function b(b){function c(a,b){return new Promise(function(c,e){var h={key:a,arg:b,resolve:c,reject:e,next:null};g?g=g.next=h:(f=g=h,d(a,b))})}function d(c,f){try{var g=b[c](f),h=g.value;h instanceof a?Promise.resolve(h.value).then(function(a){d("next",a)},function(a){d("throw",a)}):e(g.done?"return":"normal",g.value)}catch(a){e("throw",a)}}function e(a,b){switch(a){case"return":f.resolve({value:b,done:!0});break;case"throw":f.reject(b);break;default:f.resolve({value:b,done:!1})}f=f.next,f?d(f.key,f.arg):g=null}var f,g;this._invoke=c,"function"!=typeof b.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(b.prototype[Symbol.asyncIterator]=function(){return this}),b.prototype.next=function(a){return this._invoke("next",a)},b.prototype.throw=function(a){return this._invoke("throw",a)},b.prototype.return=function(a){return this._invoke("return",a)}}(),function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}),k=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),l=function(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)},m=function(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b},n=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!b||c.length!==b);d=!0);}catch(a){e=!0,f=a}finally{try{!d&&h.return&&h.return()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)},p=function(a){function b(a){j(this,b);var c=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return c.name=c.constructor.name,c.message=a,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(c,c.constructor):c.stack=new Error(a).stack,c}return l(b,a),b}(Error),q=function(a){function b(){return j(this,b),m(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return l(b,a),b}(p),r=function(a){function b(){return j(this,b),m(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return l(b,a),b}(q),s=Object.freeze({Music21Exception:q,StreamException:r}),t=!1,u={};u.merge=function a(b,c){if(void 0===c||null===c)return b;for(var d in c)if({}.hasOwnProperty.call(c,d))try{c[d].constructor===Object?b[d]=a(b[d],c[d]):b[d]=c[d]}catch(a){b[d]=c[d]}return b},u.mixin=function(a,b){for(var c=Object.getPrototypeOf(a),d=Object.getPrototypeOf(b);c;){for(var e in Object.keys(c))({}).hasOwnProperty.call(c,e)&&(e in d||(d[e]=c[e]));c=Object.getPrototypeOf(c)}},u.statisticalMode=function(a){if(0===a.length)return null;for(var b={},c=a[0],d=1,e=0;e<a.length;e++){var f=a[e];null==b[f]&&(b[f]=0),b[f]+=1,b[f]>d&&(c=f,d=b[f])}return c},u.makeSVGright=function(a,b){void 0===a&&(a="svg"),void 0===b&&(b={});var c=document.createElementNS("http://www.w3.org/2000/svg",a);for(var d in b)({}).hasOwnProperty.call(b,d)&&c.setAttribute(d,b[d]);return c},u.ordinalAbbreviation=function(a,b){var c="",d=a%100;if(11===d||12===d||13===d)c="th";else{var e=a%10;c=1===e?"st":2===e?"nd":3===e?"rd":"th"}return"st"!==c&&b&&(c+="s"),c},u.rationalize=function(a,b,c){b=b||.001,c=c||50;for(var d=2;d<c;d++)if(Math.abs(a*d-Math.round(a*d))<b){var e=Math.round(a*d),f=d;return{numerator:e,denominator:f}}},u.stripPx=function(a){if("string"==typeof a){var b=a.indexOf("px");return a=a.slice(0,b),parseInt(a)}return a},u.urlParam=function(a){a=a.replace(/[[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null==c?"":decodeURIComponent(c[1].replace(/\+/g," "))},u.jQueryEventCopy=function(b,c,d){c=c.jquery?c:a(c),d=d.jquery?d:a(d);var e=c[0].events||a.data(c[0],"events")||a._data(c[0],"events");if(c.length&&d.length&&e)return d.each(function(){for(var c in e)if({}.hasOwnProperty.call(e,c))for(var d in e[c])({}).hasOwnProperty.call(e[c],d)&&a.event.add(b,c,e[c][d],e[c][d].data)})},u.setWindowVisibilityWatcher=function(a){function b(b){var d="visible",e="hidden",f={focus:d,focusin:d,pageshow:d,blur:e,focusout:e,pagehide:e};b=b||window.event;var g="";g=b.type in f?f[b.type]:this[c]?"hidden":"visible",a(g,b)}var c="hidden";c in document?document.addEventListener("visibilitychange",b):"mozHidden"in document?(c="mozHidden",document.addEventListener("mozvisibilitychange",b)):"webkitHidden"in document?(c="webkitHidden",document.addEventListener("webkitvisibilitychange",b)):"msHidden"in document?(c="msHidden",document.addEventListener("msvisibilitychange",b)):"onfocusin"in document&&(document.onfocusin=document.onfocusout=b),window.onpageshow=window.onpagehide=window.onfocus=window.onblur=b,b({type:"visible"===document.visibilityState?"focus":"blur"})},u.urls={css:"/css",webResources:"/webResources",midiPlayer:"/webResources/midiPlayer",soundfontUrl:"/src/ext/soundfonts/FluidR3_GM/"};var v={},w=function(){function a(){j(this,a),this.classes=["ProtoM21Object"],this.isProtoM21Object=!0,this.isMusic21Object=!1,this._cloneCallbacks={}}return k(a,[{key:"clone",value:function(){var a=new this.constructor;for(var b in this)if(!1!=={}.hasOwnProperty.call(this,b))if(b in this._cloneCallbacks)!0===this._cloneCallbacks[b]?a[b]=this[b]:!1===this._cloneCallbacks[b]?a[b]=void 0:this._cloneCallbacks[b](b,a,this);else if(void 0!==Object.getOwnPropertyDescriptor(this,b).get||void 0!==Object.getOwnPropertyDescriptor(this,b).set);else if("function"==typeof this[b]);else if("object"===i(this[b])&&null!==this[b]&&this[b].isProtoM21Object)a[b]=this[b].clone();else try{a[b]=this[b]}catch(a){if(!(a instanceof TypeError))throw a;console.log("typeError:",a,b)}return a}},{key:"isClassOrSubclass",value:function(a){a instanceof Array==!1&&(a=[a]);for(var b=0;b<a.length;b++)if(-1!==this.classes.indexOf(a[b]))return!0;return!1}}]),a}();v.ProtoM21Object=w;var x={};x.typeFromNumDict={1:"whole",2:"half",4:"quarter",8:"eighth",16:"16th",32:"32nd",64:"64th",128:"128th",256:"256th",512:"512th",1024:"1024th",0:"zero",.5:"breve",.25:"longa",.125:"maxima",.0625:"duplex-maxima"},x.quarterTypeIndex=6,x.ordinalTypeFromNum=["duplex-maxima","maxima","longa","breve","whole","half","quarter","eighth","16th","32nd","64th","128th","256th","512th","1024th"],x.vexflowDurationArray=[void 0,void 0,void 0,void 0,"w","h","q","8","16","32",void 0,void 0,void 0,void 0,void 0];var y=function(a){function b(a){j(this,b);var c=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return c.classes.push("Duration"),c._quarterLength=1,c._dots=0,c._durationNumber=void 0,c._type="quarter",c._tuplets=[],"string"==typeof a?c.type=a:c.quarterLength=a,c._cloneCallbacks._tuplets=c.cloneCallbacksTupletFunction,c}return l(b,a),k(b,[{key:"cloneCallbacksTupletFunction",value:function(a,b,c){for(var d=[],e=0;e<c[a].length;e++){var f=c[a][e].clone();d.push(f)}b[a]=d}},{key:"_findDots",value:function(a){if(0===a)return 0;for(var b=x.ordinalTypeFromNum.indexOf(this._type),c=Math.pow(2,x.quarterTypeIndex-b),d=0;d<=4;d++){var e=(Math.pow(2,d)-1)/Math.pow(2,d),f=1+e;if(Math.abs(c*f-a)<1e-4)return d}return t&&console.log("no dots available for ql; probably a tuplet",a),0}},{key:"updateQlFromFeatures",value:function(){var a=x.ordinalTypeFromNum.indexOf(this._type),b=Math.pow(2,x.quarterTypeIndex-a),c=1+(Math.pow(2,this._dots)-1)/Math.pow(2,this._dots),d=b*c,e=d;this._tuplets.forEach(function(a){e*=a.tupletMultiplier()}),this._quarterLength=e}},{key:"updateFeaturesFromQl",value:function(){var a=this._quarterLength,b=Math.floor(Math.log(a+1e-5)/Math.log(2)),c=x.quarterTypeIndex-b;this._type=x.ordinalTypeFromNum[c],this._dots=this._findDots(a);var d=Math.pow(2,x.quarterTypeIndex-c),e=1+(Math.pow(2,this._dots)-1)/Math.pow(2,this._dots),f=d*e;if(f!==a&&0!==a){c-=1,this._type=x.ordinalTypeFromNum[c],f*=2;var g=a/f,h=u.rationalize(g);if(void 0===h);else{var i=new x.Tuplet(h.denominator,h.numerator,new x.Duration(f));this.appendTuplet(i,!0)}}}},{key:"appendTuplet",value:function(a,b){a.frozen=!0,this._tuplets.push(a),!0!==b&&this.updateQlFromFeatures()}},{key:"dots",get:function(){return this._dots},set:function(a){this._dots=a,this.updateQlFromFeatures()}},{key:"quarterLength",get:function(){return this._quarterLength},set:function(a){void 0===a&&(a=1),this._quarterLength=a,this.updateFeaturesFromQl()}},{key:"type",get:function(){return this._type},set:function(a){if(-1===x.ordinalTypeFromNum.indexOf(a))throw console.log("invalid type "+a),new q("invalid type "+a);this._type=a,this.updateQlFromFeatures()}},{key:"tuplets",get:function(){return this._tuplets}},{key:"vexflowDuration",get:function(){var a=x.ordinalTypeFromNum.indexOf(this.type),b=x.vexflowDurationArray[a];if(this.dots>0)for(var c=0;c<this.dots;c++)b+="d";return b}}]),b}(v.ProtoM21Object);x.Duration=y;var z=function(a){function b(a,c,d,e){j(this,b);var f=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.classes.push("Tuplet"),f.numberNotesActual=a||3,f.numberNotesNormal=c||2,f.durationActual=d||new x.Duration(.5),"number"==typeof f.durationActual&&(f.durationActual=new x.Duration(f.durationActual)),f.durationNormal=e||f.durationActual,f.frozen=!1,f.type=void 0,f.bracket=!0,f.placement="above",f.tupletActualShow="number",f.tupletNormalShow=void 0,f}return l(b,a),k(b,[{key:"setDurationType",value:function(a){if(!0===this.frozen)throw new q("A frozen tuplet (or one attached to a duration) is immutable");return this.durationActual=new x.Duration(a),this.durationNormal=this.durationActual,this.durationActual}},{key:"setRatio",value:function(a,b){if(!0===this.frozen)throw new q("A frozen tuplet (or one attached to a duration) is immutable");this.numberNotesActual=a||3,this.numberNotesNormal=b||2}},{key:"totalTupletLength",value:function(){return this.numberNotesNormal*this.durationNormal.quarterLength}},{key:"tupletMultiplier",value:function(){var a=this.durationActual.quarterLength;return this.totalTupletLength()/(this.numberNotesActual*a)}},{key:"fullName",get:function(){var a=this.numberNotesActual,b=this.numberNotesNormal;if(3===a&&2===b)return"Triplet";if(5===a&&(4===b||2===b))return"Quintuplet";if(6===a&&4===b)return"Sextuplet";var c=u.ordinalAbbreviation(b,!0);return"Tuplet of "+a.toString()+"/"+b.toString()+c}}]),b}(v.ProtoM21Object);x.Tuplet=z;var A={},B=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("Music21Object"),a.classSortOrder=20,a._priority=0,a.offset=null,a.activeSite=void 0,a.isMusic21Object=!0,a.isStream=!1,a._duration=new x.Duration,a.groups=[],a._cloneCallbacks.activeSite=function(a,b,c){b[a]=void 0},a}return l(b,a),k(b,[{key:"getOffsetBySite",value:function(a){if(void 0===a)return this.offset;for(var b=0;b<a.length;b++)if(a._elements[b]===this)return a._elementOffsets[b]}},{key:"priority",get:function(){return this._priority},set:function(a){this._priority=a}},{key:"duration",get:function(){return this._duration},set:function(a){"object"===(void 0===a?"undefined":i(a))?this._duration=a:"number"==typeof a?this._duration.quarterLength=a:"string"==typeof a&&(this._duration.type=a)}},{key:"quarterLength",get:function(){return this.duration.quarterLength},set:function(a){this.duration.quarterLength=a}}]),b}(v.ProtoM21Object);A.Music21Object=B;var C={},D=function(a){function c(){j(this,c);var a=m(this,(c.__proto__||Object.getPrototypeOf(c)).call(this));return a.classes.push("Articulation"),a.name=void 0,a.placement="above",a.vexflowModifier=void 0,a.setPosition=void 0,a.dynamicScale=1,a.lengthScale=1,a}return l(c,a),k(c,[{key:"vexflow",value:function(){var a=new b.Flow.Articulation(this.vexflowModifier);return this.setPosition&&a.setPosition(this.setPosition),a}}]),c}(v.ProtoM21Object);C.Articulation=D;var E=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("LengthArticulation"),a}return l(b,a),b}(D);C.LengthArticulation=E;var F=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("DynamicArticulation"),a}return l(b,a),b}(D);C.DynamicArticulation=F;var G=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("PitchArticulation"),a}return l(b,a),b}(D);C.PitchArticulation=G;var H=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("TimbreArticulation"),a}return l(b,a),b}(D);C.TimbreArticulation=H;var I=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("Accent"),a.name="accent",a.vexflowModifier="a>",a.dynamicScale=1.5,a}return l(b,a),b}(F);C.Accent=I;var J=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("StrongAccent"),a.name="strong accent",a.vexflowModifier="a^",a.dynamicScale=2,a}return l(b,a),b}(I);C.StrongAccent=J;var K=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("Staccato"),a.name="staccato",a.vexflowModifier="a.",a}return l(b,a),b}(E);C.Staccato=K;var L=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("Staccatissimo"),a.name="staccatissimo",a.vexflowModifier="av",a}return l(b,a),b}(K);C.Staccatissimo=L;var M=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("Spiccato"),a.name="spiccato",a.vexflowModifier=void 0,a}return l(b,a),b}(K);C.Spiccato=M;var N=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return u.mixin(E,a),a.classes.push("Marcato"),a.name="marcato",a.vexflowModifier="a^",a.dynamicScale=1.7,a}return l(b,a),b}(F);C.Marcato=N;var O=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("Tenuto"),a.name="tenuto",a.vexflowModifier="a-",a}return l(b,a),b}(E);C.Tenuto=O;var P={};P.fftSize=2048,P.AudioContextCaller=window.AudioContext||window.webkitAudioContext,P._audioContext=null,P.animationFrameCallbackId=null,Object.defineProperties(P,{audioContext:{get:function(){return null!==P._audioContext?P._audioContext:(void 0!==h&&void 0!==h.WebAudio&&void 0!==h.WebAudio.getContext()?window.globalAudioContext=h.WebAudio.getContext():void 0===window.globalAudioContext&&(window.globalAudioContext=new P.AudioContextCaller),P._audioContext=window.globalAudioContext,P._audioContext)},set:function(a){P._audioContext=a}}}),P.getUserMedia=function(a,b,c){void 0===c&&(c=function(){alert("navigator.getUserMedia either not defined (Safari, IE) or denied.")}),void 0===b&&(b=function(a){P.userMediaStarted(a)});var d=navigator;d.getUserMedia=d.getUserMedia||d.webkitGetUserMedia||d.mozGetUserMedia||d.msGetUserMedia,void 0===d.getUserMedia&&c(),void 0===a&&(a={audio:{mandatory:{},optional:[]}}),d.getUserMedia(a,b,c)},P.sampleBuffer=null,P.currentAnalyser=null,P.userMediaStarted=function(a){P.sampleBuffer=new Float32Array(P.fftSize/2);var b=P.audioContext.createMediaStreamSource(a),c=P.audioContext.createAnalyser();c.fftSize=P.fftSize,b.connect(c),P.currentAnalyser=c,P.animateLoop()},P.minFrequency=55,P.maxFrequency=1050,P.animateLoop=function(a){P.currentAnalyser.getFloatTimeDomainData(P.sampleBuffer);var b=P.autoCorrelate(P.sampleBuffer,P.audioContext.sampleRate,P.minFrequency,P.maxFrequency);-1!==P.sampleCallback(b)&&(P.animationFrameCallbackId=window.requestAnimationFrame(P.animateLoop))},P.pitchSmoothingSize=40,P.lastPitchClassesDetected=[],P.lastPitchesDetected=[],P.lastCentsDeviationsDetected=[],P.smoothPitchExtraction=function(a){if(-1===a)P.lastPitchClassesDetected.shift(),P.lastPitchesDetected.shift(),P.lastCentsDeviationsDetected.shift();else{var b=P.midiNumDiffFromFrequency(a),c=n(b,2),d=c[0],e=c[1];P.lastPitchClassesDetected.length>P.pitchSmoothingSize&&(P.lastPitchClassesDetected.shift(),P.lastPitchesDetected.shift(),P.lastCentsDeviationsDetected.shift()),P.lastPitchClassesDetected.push(d%12),P.lastPitchesDetected.push(d),P.lastCentsDeviationsDetected.push(e)}var f=u.statisticalMode(P.lastPitchClassesDetected);if(null===f)return[-1,0];for(var g=[],h=[],i=0;i<P.lastPitchClassesDetected.length;i++)P.lastPitchClassesDetected[i]===f&&(g.push(P.lastPitchesDetected[i]),h.push(P.lastCentsDeviationsDetected[i]));for(var j=u.statisticalMode(g),k=0,l=0,m=0;m<h.length;m++){var o=Math.pow(m,2)+1;l+=o*h[m],k+=o}return[j,Math.floor(l/k)]},P.sampleCallback=function(a){var b=P.smoothPitchExtraction(a),c=n(b,2);c[0],c[1]},P.autoCorrelate=function(a,b,c,d){var e=a.length,f=Math.floor(e/2);void 0===c&&(c=0),void 0===d&&(d=b);for(var g=-1,h=0,i=0,j=!1,k=new Array(f),l=0;l<e;l++){var m=a[l];i+=m*m}if((i=Math.sqrt(i/e))<.01)return-1;for(var n=1,o=0;o<f;o++){var p=0,q=b/o;if(q<c)break;if(!(q>d)){for(var r=0;r<f;r++)p+=Math.abs(a[r]-a[r+o]);if(p=1-p/f,k[o]=p,p>.9&&p>n)j=!0,p>h&&(h=p,g=o);else if(j){var s=(k[g+1]-k[g-1])/k[g];return b/(g+8*s)}n=p}}return h>.01?b/g:-1},P.midiNumDiffFromFrequency=function(a){var b=Math.log(a/440)/Math.log(2)*12+69,c=Math.round(b);return[c,Math.round(100*(b-c))]};var Q=function(){function a(b){j(this,a);var c=b||{};this.bufferLen=c.bufferLen||4096,this.config=c,this.recording=!1,this.currCallback=void 0,this.audioContext=P.audioContext,this.frequencyCanvasInfo={id:"frequencyAnalyser",width:void 0,height:void 0,canvasContext:void 0,animationFrameID:void 0},this.waveformCanvasInfo={id:"waveformCanvas",width:void 0,height:void 0,canvasContext:void 0},this.analyserNode=void 0}return k(a,[{key:"initAudio",value:function(){var a=this;this.polyfillNavigator(),navigator.getUserMedia({audio:{mandatory:{googEchoCancellation:"false",googAutoGainControl:"false",googNoiseSuppression:"false",googHighpassFilter:"false"},optional:[]}},function(b){return a.audioStreamConnected(b)},function(a){console.log("Error getting audio -- try on google Chrome?"),console.log(a)})}},{key:"audioStreamConnected",value:function(a){var b=this.audioContext.createGain();this.audioContext.createMediaStreamSource(a).connect(b);var c=this.audioContext.createAnalyser();c.fftSize=2048,this.analyserNode=c,b.connect(c),this.connectSource(b);var d=this.audioContext.createGain();d.gain.value=0,b.connect(d),d.connect(this.audioContext.destination)}},{key:"connectSource",value:function(a){var b=this;this.context=a.context,this.setNode();var c=new Blob(["(",R,")()"],{type:"application/javascript"}),d=URL.createObjectURL(c);this.worker=new Worker(d),this.worker.onmessage=function(a){var c=a.data;b.currCallback(c)},URL.revokeObjectURL(d),this.worker.postMessage({command:"init",config:{sampleRate:this.context.sampleRate}}),this.node.onaudioprocess=function(a){b.recording&&b.worker.postMessage({command:"record",buffer:[a.inputBuffer.getChannelData(0),a.inputBuffer.getChannelData(1)]})},a.connect(this.node),this.node.connect(this.context.destination)}},{key:"setNode",value:function(){return this.context.createScriptProcessor?this.node=this.context.createScriptProcessor(this.bufferLen,2,2):this.node=this.context.createJavaScriptNode(this.bufferLen,2,2),this.node}},{key:"configure",value:function(a){for(var b in a)Object.hasOwnProperty.call(a,b)&&(this.config[b]=a[b])}},{key:"record",value:function(){this.recording=!0}},{key:"stop",value:function(){this.recording=!1}},{key:"clear",value:function(){this.worker.postMessage({command:"clear"})}},{key:"getBuffers",value:function(a){this.currCallback=a||this.config.callback,this.worker.postMessage({command:"getBuffers"})}},{key:"exportWAV",value:function(a,b,c){var d=this,e="exportWAV";!0===c&&(e="exportMonoWAV"),this.currCallback=a||this.config.callback,b=b||this.config.type||"audio/wav",this.currCallback||(this.currCallback=function(a){d.setupDownload(a,"myRecording"+Date.now().toString()+".wav")}),this.worker.postMessage({command:e,type:b})}},{key:"exportMonoWAV",value:function(a,b){this.exportWAV(a,b,!0)}},{key:"setupDownload",value:function(a,b,c){c=c||"save";var d=(window.URL||window.webkitURL).createObjectURL(a),e=document.getElementById(c);e.href=d,e.download=b||"output.wav"}},{key:"polyfillNavigator",value:function(){navigator.getUserMedia||(navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia)}},{key:"updateAnalysers",value:function(a){var b=this;if(!this.frequencyCanvasInfo.canvasContext){var c=document.getElementById(this.frequencyCanvasInfo.id);if(!c)return;this.frequencyCanvasInfo.width=c.width,this.frequencyCanvasInfo.height=c.height,this.frequencyCanvasInfo.canvasContext=c.getContext("2d")}var d=Math.round(this.frequencyCanvasInfo.width/3),e=new Uint8Array(this.analyserNode.frequencyBinCount);this.analyserNode.getByteFrequencyData(e);var f=this.frequencyCanvasInfo.canvasContext;f.clearRect(0,0,this.frequencyCanvasInfo.width,this.frequencyCanvasInfo.height),f.fillStyle="#F6D565",f.lineCap="round";for(var g=this.analyserNode.frequencyBinCount/d,h=0;h<d;++h){for(var i=0,j=Math.floor(h*g),k=0;k<g;k++)i+=e[j+k];i=i*(this.frequencyCanvasInfo.height/256)/g,f.fillStyle="hsl( "+Math.round(360*h/d)+", 100%, 50%)",f.fillRect(3*h,this.frequencyCanvasInfo.height,1,-1*i)}this.frequencyCanvasInfo.animationFrameID=window.requestAnimationFrame(function(a){return b.updateAnalysers(a)})}},{key:"drawWaveformCanvas",value:function(a){var b=a[0];if(!this.waveformCanvasInfo.context){var c=document.getElementById(this.waveformCanvasInfo.id);if(!c)return;this.waveformCanvasInfo.width=c.width,this.waveformCanvasInfo.height=c.height,this.waveformCanvasInfo.context=c.getContext("2d")}var d=this.waveformCanvasInfo.context,e=Math.ceil(b.length/this.waveformCanvasInfo.width),f=this.waveformCanvasInfo.height/2;d.fillStyle="silver",d.clearRect(0,0,this.waveformCanvasInfo.width,this.waveformCanvasInfo.height);for(var g=0;g<this.waveformCanvasInfo.width;g++){for(var h=1,i=-1,j=0;j<e;j++){var k=b[g*e+j];k<h&&(h=k),k>i&&(i=k)}d.fillRect(g,(1+h)*f,1,Math.max(1,(i-h)*f))}}},{key:"playBuffers",value:function(a){for(var b=a[0].length,c=this.context.createBuffer(2,b,this.context.sampleRate),d=0;d<2;d++)for(var e=c.getChannelData(d),f=0;f<b;f++)e[f]=a[d][f];var g=this.context.createBufferSource();return g.buffer=c,g.connect(this.context.destination),g.start(),g}}]),a}(),R="function recorderWorkerJs() {\n    /**\n     *\n     *   Rewritten from Matt Diamond's recorderWorker -- MIT License\n     */\n    RecorderWorker = function RecorderWorker(parentContext) {\n            this.parent = parentContext;\n            this.recLength = 0;\n            this.recBuffersL = [];\n            this.recBuffersR = [];\n            this.sampleRate = undefined;\n    };\n    RecorderWorker.prototype.onmessage = function onmessage(e) {\n            switch (e.data.command) {\n            case 'init':\n                this.init(e.data.config);\n                break;\n            case 'record':\n                this.record(e.data.buffer);\n                break;\n            case 'exportWAV':\n                this.exportWAV(e.data.type);\n                break;\n            case 'exportMonoWAV':\n                this.exportMonoWAV(e.data.type);\n                break;\n            case 'getBuffers':\n                this.getBuffers();\n                break;\n            case 'clear':\n                this.clear();\n                break;\n            default:\n                break;\n            }\n   };\n   RecorderWorker.prototype.postMessage = function postMessage(msg) {\n            this.parent.postMessage(msg);\n   };\n\n   RecorderWorker.prototype.init = function init(config) {\n            this.sampleRate = config.sampleRate;\n   };\n\n   RecorderWorker.prototype.record = function record(inputBuffer) {\n            var inputBufferL = inputBuffer[0];\n            var inputBufferR = inputBuffer[1];\n            this.recBuffersL.push(inputBufferL);\n            this.recBuffersR.push(inputBufferR);\n            this.recLength += inputBufferL.length;\n   };\n\n   RecorderWorker.prototype.exportWAV = function exportWAV(type) {\n            var bufferL = this.mergeBuffers(this.recBuffersL);\n            var bufferR = this.mergeBuffers(this.recBuffersR);\n            var interleaved = this.interleave(bufferL, bufferR);\n            var dataview = this.encodeWAV(interleaved);\n            var audioBlob = new Blob([dataview], { 'type': type });\n\n            this.postMessage(audioBlob);\n   };\n\n   RecorderWorker.prototype.exportMonoWAV = function exportMonoWAV(type) {\n            var bufferL = this.mergeBuffers(this.recBuffersL);\n            var dataview = this.encodeWAV(bufferL);\n            var audioBlob = new Blob([dataview], { 'type': type });\n\n            this.postMessage(audioBlob);\n   };\n\n   RecorderWorker.prototype.mergeBuffers = function mergeBuffers(recBuffers) {\n            var result = new Float32Array(this.recLength);\n            var offset = 0;\n            for (var i = 0; i < recBuffers.length; i++) {\n                result.set(recBuffers[i], offset);\n                offset += recBuffers[i].length;\n            }\n            return result;\n    };\n\n    RecorderWorker.prototype.getBuffers = function getBuffers() {\n            var buffers = [];\n            buffers.push(this.mergeBuffers(this.recBuffersL));\n            buffers.push(this.mergeBuffers(this.recBuffersR));\n            this.postMessage(buffers);\n        };\n\n    RecorderWorker.prototype.clear = function clear() {\n            this.recLength = 0;\n            this.recBuffersL = [];\n            this.recBuffersR = [];\n        }\n\n    RecorderWorker.prototype.interleave = function interleave(inputL, inputR) {\n            var combinedLength = inputL.length + inputR.length;\n            var result = new Float32Array(combinedLength);\n\n            var index = 0;\n            var inputIndex = 0;\n\n            while (index < combinedLength) {\n                result[index++] = inputL[inputIndex];\n                result[index++] = inputR[inputIndex];\n                inputIndex++;\n            }\n            return result;\n        }\n    RecorderWorker.prototype.encodeWAV = function encodeWAV(samples, mono) {\n            var buffer = new ArrayBuffer(44 + (samples.length * 2));\n            var view = new DataView(buffer);\n\n            /* RIFF identifier */\n            writeString(view, 0, 'RIFF');\n\n            /* file length */\n            view.setUint32(4, 32 + samples.length * 2, true);\n\n            /* RIFF type */\n            writeString(view, 8, 'WAVE');\n\n            /* format chunk identifier */\n            writeString(view, 12, 'fmt ');\n\n            /* format chunk length */\n            view.setUint32(16, 16, true);\n\n            /* sample format (raw) */\n            view.setUint16(20, 1, true);\n\n            /* channel count */\n            view.setUint16(22, mono ? 1 : 2, true);\n\n            /* sample rate */\n            view.setUint32(24, this.sampleRate, true);\n\n            /* byte rate (sample rate * block align) */\n            view.setUint32(28, this.sampleRate * 4, true);\n\n            /* block align (channel count * bytes per sample) */\n            view.setUint16(32, 4, true);\n\n            /* bits per sample */\n            view.setUint16(34, 16, true);\n\n            /* data chunk identifier */\n            writeString(view, 36, 'data');\n\n            /* data chunk length */\n            view.setUint32(40, samples.length * 2, true);\n\n            floatTo16BitPCM(view, 44, samples);\n\n            return view;\n        }\n\n    function floatTo16BitPCM(output, offset, input) {\n        for (var i = 0; i < input.length; i++, offset += 2) {\n            var s = Math.max(-1, Math.min(1, input[i]));\n            output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);\n        }\n    }\n\n    function writeString(view, offset, string) {\n        for (var i = 0; i < string.length; i++) {\n            view.setUint8(offset + i, string.charCodeAt(i));\n        }\n    }\n\n    var recordWorker = new RecorderWorker(this);\n    this.onmessage = (function mainOnMessage(e) { recordWorker.onmessage(e) }).bind(this);\n}",S={Recorder:Q},T={};T.validBeamTypes={start:!0,stop:!0,continue:!0,partial:!0};var U=function(a){function b(a,c){j(this,b);var d=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return d.classes.push("Beam"),d.type=a,d.direction=c,d.independentAngle=void 0,d.number=void 0,d}return l(b,a),b}(v.ProtoM21Object);T.Beam=U;var V=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("Beams"),a.beamsList=[],a.feathered=!1,a}return l(b,a),k(b,[{key:"append",value:function(a,b){var c=new T.Beam(a,b);return c.number=this.beamsList.length+1,this.beamsList.push(c),c}},{key:"fill",value:function(a,b){this.beamsList=[];var c=1;if(1===a||"8th"===a||a===x.typeFromNumDict[8])c=1;else if(2===a||a===x.typeFromNumDict[16])c=2;else if(3===a||a===x.typeFromNumDict[32])c=3;else if(4===a||a===x.typeFromNumDict[64])c=4;else if(5===a||a===x.typeFromNumDict[128])c=5;else{if(6!==a&&a!==x.typeFromNumDict[256])throw new q("cannot fill beams for level "+a);c=6}for(var d=1;d<=c;d++){var e=new T.Beam;e.number=d,this.beamsList.push(e)}return void 0!==b&&this.setAll(b),this}},{key:"getByNumber",value:function(a){if(!this.getNumbers().includes(a))throw new q("beam number error: "+a);var b=!0,c=!1,d=void 0;try{for(var e,f=this.beamsList[Symbol.iterator]();!(b=(e=f.next()).done);b=!0){var g=e.value;if(g.number===a)return g}}catch(a){c=!0,d=a}finally{try{!b&&f.return&&f.return()}finally{if(c)throw d}}}},{key:"getNumbers",value:function(){var a=[],b=!0,c=!1,d=void 0;try{for(var e,f=this.beamsList[Symbol.iterator]();!(b=(e=f.next()).done);b=!0){var g=e.value;a.push(g.number)}}catch(a){c=!0,d=a}finally{try{!b&&f.return&&f.return()}finally{if(c)throw d}}}},{key:"getTypeByNumber",value:function(a){var b=this.getByNumber(a);return void 0===b.direction?b.type:b.type+"-"+b.direction}},{key:"getTypes",value:function(){for(var a=[],b=0;b<this.length;b++)a.push(this.beamsList[b].type);return a}},{key:"setAll",value:function(a,b){if(void 0===T.validBeamTypes[a])throw new q("invalid beam type: "+a);for(var c=0;c<this.length;c++){var d=this.beamsList[c];d.type=a,d.direction=b}return this}},{key:"setByNumber",value:function(a,b,c){if(void 0===c){var d=b.split("-");b=d[0],c=d[1]}
if(void 0===T.validBeamTypes[b])throw new q("invalid beam type: "+b);for(var e=0;e<this.length;e++)this.beamsList[e].number===a&&(this.beamsList[e].type=b,this.beamsList[e].direction=c);return this}},{key:"length",get:function(){return this.beamsList.length}}]),b}(v.ProtoM21Object);T.Beams=V;var W={},X=function(a){function b(a){j(this,b);var c=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return c.classes.push("Accidental"),c._name="",c._alter=0,c._modifier="",c._unicodeModifier="",c.displayType="normal",c.displayStatus=void 0,c.set(a),c}return l(b,a),k(b,[{key:"set",value:function(a){void 0!==a&&void 0!==a.toLowerCase&&(a=a.toLowerCase()),"natural"===a||"n"===a||0===a||void 0===a?(this._name="natural",this._alter=0,this._modifier="",this._unicodeModifier="♮"):"sharp"===a||"#"===a||1===a?(this._name="sharp",this._alter=1,this._modifier="#",this._unicodeModifier="♯"):"flat"===a||"-"===a||-1===a?(this._name="flat",this._alter=-1,this._modifier="-",this._unicodeModifier="♭"):"double-flat"===a||"--"===a||-2===a?(this._name="double-flat",this._alter=-2,this._modifier="--",this._unicodeModifier="&#x1d12b;"):"double-sharp"===a||"##"===a||2===a?(this._name="double-sharp",this._alter=2,this._modifier="##",this._unicodeModifier="&#x1d12a;"):"triple-flat"===a||"---"===a||-3===a?(this._name="triple-flat",this._alter=-3,this._modifier="---",this._unicodeModifier="♭&#x1d12b;"):"triple-sharp"!==a&&"###"!==a&&3!==a||(this._name="triple-sharp",this._alter=3,this._modifier="###",this._unicodeModifier="&#x1d12a;")}},{key:"name",get:function(){return this._name},set:function(a){this.init(a)}},{key:"alter",get:function(){return this._alter},set:function(a){this.init(a)}},{key:"modifier",get:function(){return this._modifier},set:function(a){this.init(a)}},{key:"vexflowModifier",get:function(){var a=this.modifier;if(""===a)return"n";if("#"===a)return"#";if("-"===a)return"b";if("##"===a)return"##";if("--"===a)return"bb";if("###"===a)return"###";if("---"===a)return"bbb";throw new q("Vexflow does not support: "+a)}},{key:"unicodeModifier",get:function(){return this._unicodeModifier}}]),b}(v.ProtoM21Object);W.Accidental=X,W.nameToMidi={C:0,D:2,E:4,F:5,G:7,A:9,B:11},W.nameToSteps={C:0,D:1,E:2,F:3,G:4,A:5,B:6},W.stepsToName=["C","D","E","F","G","A","B"],W.midiToName=["C","C#","D","E-","E","F","F#","G","A-","A","B-","B"];var Y=function(a){function b(a){j(this,b);var c=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return c.classes.push("Pitch"),void 0===a&&(a="C"),c._step="C",c._octave=4,c._accidental=void 0,"number"==typeof a?(a<12&&(a+=60),c.ps=a):a.match(/\d+/)?c.nameWithOctave=a:c.name=a,c}return l(b,a),k(b,[{key:"vexflowName",value:function(a){var b=this;if(void 0!==a)try{b=a.convertPitchToTreble(this)}catch(b){console.log(b,a)}var c="n";return void 0!==this.accidental&&(c=this.accidental.vexflowModifier),b.step+c+"/"+b.octave}},{key:"step",get:function(){return this._step},set:function(a){this._step=a}},{key:"octave",get:function(){return this._octave},set:function(a){this._octave=a}},{key:"accidental",get:function(){return this._accidental},set:function(a){"object"!==(void 0===a?"undefined":i(a))&&void 0!==a&&(a=new W.Accidental(a)),this._accidental=a}},{key:"name",get:function(){return void 0===this.accidental?this.step:this.step+this.accidental.modifier},set:function(a){this.step=a.slice(0,1).toUpperCase();var b=a.slice(1);this.accidental=b||void 0}},{key:"nameWithOctave",get:function(){return this.name+this.octave.toString()},set:function(a){var b=a.match(/\d+/);void 0!==b?(a=a.replace(/\d+/,""),this.octave=parseInt(b),this.name=a):this.name=a}},{key:"diatonicNoteNum",get:function(){return 7*this.octave+W.nameToSteps[this.step]+1},set:function(a){a-=1,this.octave=Math.floor(a/7),this.step=W.stepsToName[a%7]}},{key:"frequency",get:function(){return 440*Math.pow(2,(this.ps-69)/12)}},{key:"midi",get:function(){return Math.floor(this.ps)}},{key:"ps",get:function(){var a=0;return void 0!==this.accidental&&(a=parseInt(this.accidental.alter)),12*(this.octave+1)+W.nameToMidi[this.step]+a},set:function(a){this.name=W.midiToName[a%12],this.octave=Math.floor(a/12)-1}}]),b}(v.ProtoM21Object);W.Pitch=Y;var Z={};Z.noteheadTypeNames=["arrow down","arrow up","back slashed","circle dot","circle-x","cluster","cross","diamond","do","fa","inverted triangle","la","left triangle","mi","none","normal","re","rectangle","slash","slashed","so","square","ti","triangle","x"],Z.stemDirectionNames=["double","down","noStem","none","unspecified","up"];var $=function(a){function b(a,c,d,e,f){j(this,b);var g=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return g.classes.push("Lyric"),g.lyricConnector="-",g.text=a,g._number=c||1,g.syllabic=d,g.applyRaw=e||!1,g.setTextAndSyllabic(g.text,g.applyRaw),g._identifier=f,g}return l(b,a),k(b,[{key:"setTextAndSyllabic",value:function(a,b){return void 0===a?(this.text=void 0,this):(b||0!==a.indexOf(this.lyricConnector)||a.slice(-1)!==this.lyricConnector?b||0!==a.indexOf(this.lyricConnector)?b||a.slice(-1)!==this.lyricConnector?(this.text=a,void 0===this.syllabic&&(this.syllabic="single")):(this.text=a.slice(0,-1),this.syllabic="begin"):(this.text=a.slice(1),this.syllabic="end"):(this.text=a.slice(1,-1),this.syllabic="middle"),this)}},{key:"identifier",get:function(){return this._identifier||this._number},set:function(a){this._identifier=a}},{key:"number",get:function(){return this._number},set:function(a){this._number=a}},{key:"rawText",get:function(){return"begin"===this.syllabic?this.text+this.lyricConnector:"middle"===this.syllabic?this.lyricConnector+this.text+this.lyricConnector:"end"===this.syllabic?this.lyricConnector+this.text:this.text},set:function(a){this.setTextAndSyllabic(a,!1)}}]),b}(v.ProtoM21Object);Z.Lyric=$;var _=function(a){function b(a){j(this,b);var c=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return c.classes.push("GeneralNote"),c.isChord=!1,void 0!==a&&(c.duration.quarterLength=a),c.volume=60,c.activeVexflowNote=void 0,c.expressions=[],c.articulations=[],c.lyrics=[],c.tie=void 0,c}return l(b,a),k(b,[{key:"addLyric",value:function(a,b,c,d){if(c=c||!1,void 0===b){var e=this.lyrics.length+1,f=new Z.Lyric(a,e,void 0,c,d);this.lyrics.push(f)}else{for(var g=!1,h=0;h<this.lyrics.length;h++){var i=this.lyrics[h];if(i.number===b){i.text=a,g=!0;break}}if(!1===g){var j=new Z.Lyric(a,b,void 0,c,d);this.lyrics.push(j)}}}},{key:"setStemDirectionFromClef",value:function(a){}},{key:"vexflowAccidentalsAndDisplay",value:function(a,b){if(this.duration.dots>0)for(var c=0;c<this.duration.dots;c++)a.addDotToAll();if(t&&console.log(this.stemDirection),"noStem"===this.stemDirection)a.hasStem=function(){return!1};else{var d=5;if(b.stave&&(d=Math.floor(b.stave.options.spacing_between_lines_px/2)),void 0!==b.clef&&void 0!==this.pitch){var e=b.clef.lowestLine+4,f=Math.abs(this.pitch.diatonicNoteNum-e),g=f-7;if(g>0&&void 0!==a.getStemLength){var h=g*d+a.getStemLength();a.setStemLength(h)}}}}},{key:"playMidi",value:function(a,b,d){if(void 0===a&&(a=120),void 0===d){var e=void 0;void 0!==this.activeSite&&(e=this.activeSite.instrument),d={instrument:e}}var f=this.midiVolume,g=0;void 0!==d&&void 0!==d.instrument&&(g=d.instrument.midiChannel);var h=6e4/a;h=60*this.duration.quarterLength*1e3/a;var i=void 0;if(this.isClassOrSubclass("Note")){i=this.pitch.midi;var j=h/1e3;void 0!==b&&b.isClassOrSubclass("Note")?b.pitch.midi!==this.pitch.midi?j+=15/a:void 0===this.tie||"start"!==this.tie.type&&"continue"!==this.tie.type||(j+=60*b.duration.quarterLength/a):void 0===b&&(j+=60/a),void 0!==this.tie&&"start"!==this.tie.type||(c.noteOn(g,i,f,0),c.noteOff(g,i,j))}else if(this.isClassOrSubclass("Chord"))for(var k=0;k<this._notes.length;k++)i=this._notes[k].pitch.midi,c.noteOn(g,i,f,0),c.noteOff(g,i,h/1e3);return h}},{key:"lyric",get:function(){return this.lyrics.length>0?this.lyrics[0].text:void 0},set:function(a){this.lyrics=[],void 0!==a&&!1!==a&&this.lyrics.push(new Z.Lyric(a))}},{key:"midiVolume",get:function(){var a=this.volume;return void 0===a&&(a=60),void 0!==this.articulations&&this.articulations.forEach(function(b){a*=b.dynamicScale,a>127?a=127:isNaN(a)&&(a=60)}),a=Math.floor(a)}}]),b}(A.Music21Object);Z.GeneralNote=_;var aa=function(a){function b(a){j(this,b);var c=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return c.classes.push("NotRest"),c.notehead="normal",c.noteheadFill="default",c.noteheadColor=void 0,c.noteheadParenthesis=!1,c.volume=void 0,c.beams=new T.Beams,c.stemDirection=void 0,c}return l(b,a),b}(_);Z.NotRest=aa;var ba=function(a){function c(a,b){j(this,c);var d=m(this,(c.__proto__||Object.getPrototypeOf(c)).call(this,b));return d.classes.push("Note"),d.isNote=!0,d.isRest=!1,void 0!==a&&void 0!==a.isClassOrSubclass&&!0===a.isClassOrSubclass("Pitch")?d.pitch=a:d.pitch=new W.Pitch(a),d}return l(c,a),k(c,[{key:"setStemDirectionFromClef",value:function(a){if(void 0===a)return this;var b=a.lowestLine+4,c=this.pitch.diatonicNoteNum-b;return this.stemDirection=c>=0?"down":"up",this}},{key:"vexflowNote",value:function(a){var c={};u.merge(c,a);var d=c.clef;if(void 0!==this.activeSite&&void 0!==this.activeSite.renderOptions.stemDirection&&Z.stemDirectionNames.includes(this.activeSite.renderOptions.stemDirection)?this.stemDirection=this.activeSite.renderOptions.stemDirection:void 0===this.stemDirection&&void 0!==a.clef&&this.setStemDirectionFromClef(a.clef),void 0!==this.duration){var e=this.duration.vexflowDuration;if(void 0!==e){var f=this.pitch.vexflowName(d),g="down"===this.stemDirection?b.Flow.StaveNote.STEM_DOWN:b.Flow.StaveNote.STEM_UP,h=new b.Flow.StaveNote({keys:[f],duration:e,stem_direction:g});if(this.vexflowAccidentalsAndDisplay(h,c),void 0!==this.pitch.accidental&&("n"!==this.pitch.accidental.vexflowModifier&&!1!==this.pitch.accidental.displayStatus?h.addAccidental(0,new b.Flow.Accidental(this.pitch.accidental.vexflowModifier)):"always"!==this.pitch.accidental.displayType&&!0!==this.pitch.accidental.displayStatus||h.addAccidental(0,new b.Flow.Accidental(this.pitch.accidental.vexflowModifier))),void 0!==this.articulations[0])for(var i=0;i<this.articulations.length;i++){var j=this.articulations[i];h.addArticulation(0,j.vexflow())}if(void 0!==this.expressions[0])for(var k=0;k<this.expressions.length;k++){var l=this.expressions[k];h.addArticulation(0,l.vexflow())}return void 0!==this.noteheadColor&&h.setKeyStyle(0,{fillStyle:this.noteheadColor}),this.activeVexflowNote=h,h}}}},{key:"name",get:function(){return this.pitch.name},set:function(a){this.pitch.name=a}},{key:"nameWithOctave",get:function(){return this.pitch.nameWithOctave},set:function(a){this.pitch.nameWithOctave=a}},{key:"step",get:function(){return this.pitch.step},set:function(a){this.pitch.step=a}},{key:"octave",get:function(){return this.pitch.octave},set:function(a){this.pitch.octave=a}}]),c}(aa);Z.Note=ba;var ca=function(a){function c(a){j(this,c);var b=m(this,(c.__proto__||Object.getPrototypeOf(c)).call(this,a));return b.classes.push("Rest"),b.isNote=!1,b.isRest=!0,b.name="rest",b.lineShift=void 0,b}return l(c,a),k(c,[{key:"vexflowNote",value:function(a){var c="b/4";if("whole"===this.duration.type&&void 0!==this.activeSite&&1!==this.activeSite.renderOptions.staffLines&&(c="d/5"),void 0!==this.lineShift){var d=new W.Pitch("B4"),e=this.lineShift;"whole"===this.duration.type&&(e+=2),d.diatonicNoteNum+=e,c=d.vexflowName(void 0)}var f=new b.Flow.StaveNote({keys:[c],duration:this.duration.vexflowDuration+"r"});if(this.duration.dots>0)for(var g=0;g<this.duration.dots;g++)f.addDotToAll();return this.activeVexflowNote=f,f}}]),c}(_);Z.Rest=ca;var da={},ea=function(a){function c(a){j(this,c);var b=m(this,(c.__proto__||Object.getPrototypeOf(c)).call(this));return void 0===a&&(a=[]),b.classes.push("Chord"),b.isChord=!0,b.isNote=!1,b.isRest=!1,b._notes=[],a.forEach(b.add,b),b}return l(c,a),k(c,[{key:"setStemDirectionFromClef",value:function(a){if(void 0===a)return this;for(var b=a.lowestLine+4,c=0,d=this.pitches,e=0;e<this.pitches.length;e++){var f=d[e],g=f.diatonicNoteNum-b;Math.abs(g)>=Math.abs(c)&&(c=g)}return this.stemDirection=c>=0?"down":"up",this}},{key:"add",value:function(a,b){if(void 0===b&&(b=!0),"string"==typeof a)a=new Z.Note(a);else if(a.isClassOrSubclass("Pitch")){var c=a,d=new Z.Note;d.pitch=c,a=d}return this._notes.push(a),!0===b&&this._notes.sort(function(a,b){return a.pitch.ps-b.pitch.ps}),this}},{key:"removeDuplicatePitches",value:function(){for(var a=[],b=[],c=this.pitches,d=0;d<c.length;d++){var e=c[d];-1===a.indexOf(e.step)&&(a.push(e.step),b.push(e))}return new da.Chord(b)}},{key:"root",value:function(){var a=this.removeDuplicatePitches(),b=a.pitches;if(0===b.length)throw new q("No notes in Chord!");if(1===b.length)return this.pitches[0];for(var c=[],d=[3,5,7,2,4,6],e=0;e<b.length;e++){for(var f=b[e],g=[],h=0;h<d.length;h++){void 0!==a.getChordStep(d[h],f)?g.push(!0):g.push(!1)}for(var i=!1,j=0;j<b.length-1;j++)!1===g[j]&&(i=!0);if(!1===i)return c.push(e),a.pitches[e]}return a.pitches[0]}},{key:"semitonesFromChordStep",value:function(a,b){void 0===b&&(b=this.root());var c=this.getChordStep(a,b);if(void 0!==c){var d=(c.ps-b.ps)%12;return d<0&&(d+=12),d}}},{key:"bass",value:function(){for(var a=void 0,b=this.pitches,c=0;c<b.length;c++){var d=b[c];void 0===a?a=d:d.ps<a.ps&&(a=d)}return a}},{key:"cardinality",value:function(){return this.removeDuplicatePitches().pitches.length}},{key:"isMajorTriad",value:function(){if(3!==this.cardinality())return!1;var a=this.semitonesFromChordStep(3),b=this.semitonesFromChordStep(5);return 4===a&&7===b}},{key:"isMinorTriad",value:function(){if(3!==this.cardinality())return!1;var a=this.semitonesFromChordStep(3),b=this.semitonesFromChordStep(5);return 3===a&&7===b}},{key:"canBeTonic",value:function(){return!(!this.isMajorTriad()&&!this.isMinorTriad())}},{key:"inversion",value:function(){for(var a=this.bass(),b=this.root(),c=[1,6,4,2,7,5,3],d=0;d<c.length;d++){var e=this.getChordStep(c[d],a);if(void 0!==e&&e.name===b.name)return d}}},{key:"vexflowNote",value:function(a){for(var c=a.clef,d=[],e=0;e<this._notes.length;e++)d.push(this._notes[e].pitch.vexflowName(c));var f=new b.Flow.StaveNote({keys:d,duration:this.duration.vexflowDuration});this.vexflowAccidentalsAndDisplay(f,a);for(var g=0;g<this._notes.length;g++){var h=this._notes[g];void 0!==h.pitch.accidental&&("n"!==h.pitch.accidental.vexflowModifier&&!1!==h.pitch.accidental.displayStatus?f.addAccidental(g,new b.Flow.Accidental(h.pitch.accidental.vexflowModifier)):"always"!==h.pitch.accidental.displayType&&!0!==h.pitch.accidental.displayStatus||f.addAccidental(g,new b.Flow.Accidental(h.pitch.accidental.vexflowModifier)))}return this.activeVexflowNote=f,f}},{key:"getChordStep",value:function(a,b){void 0===b&&(b=this.root()),a>=8&&(a%=7);for(var c=this.pitches,d=b.diatonicNoteNum,e=0;e<c.length;e++){var f=c[e],g=(f.diatonicNoteNum-d+1)%7;if(g<=0&&(g+=7),g===a)return f}}},{key:"length",get:function(){return this._notes.length}},{key:"pitches",get:function(){for(var a=[],b=0;b<this._notes.length;b++)a.push(this._notes[b].pitch);return a},set:function(a){this._notes=[];for(var b=0;b<a.length;b++){var c=void 0;if("string"==typeof a[b])c=new Z.Note(a[b]);else if(a[b].isClassOrSubclass("Pitch"))c=new Z.Note,c.pitch=a[b];else{if(!a[b].isClassOrSubclass("Note"))throw console.warn("bad pitch",a[b]),new q("Cannot add pitch from "+a[b]);c=a[b]}this._notes.push(c)}}}]),c}(Z.NotRest);da.Chord=ea,da.chordDefinitions={major:["M3","m3"],minor:["m3","M3"],diminished:["m3","m3"],augmented:["M3","M3"],"major-seventh":["M3","m3","M3"],"dominant-seventh":["M3","m3","m3"],"minor-seventh":["m3","M3","m3"],"diminished-seventh":["m3","m3","m3"],"half-diminished-seventh":["m3","m3","M3"]};var fa={};fa.lowestLines={treble:31,soprano:29,"mezzo-soprano":27,alto:25,tenor:23,bass:19,percussion:31};var ga=function(a){function b(a,c){j(this,b);var d=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return d.classes.push("Clef"),void 0!==a?(a=a.toLowerCase(),d.name=a,d.lowestLine=fa.lowestLines[a],d.lowestLineTrebleOffset=fa.lowestLines.treble-d.lowestLine):(d.name=void 0,d.lowestLine=fa.lowestLines.treble,d.lowestLineTrebleOffset=0),void 0===c?d.octaveChange=0:(d.octaveChange=c,d.lowestLine+=7*c,d.lowestLineTrebleOffset-=7*c),d}return l(b,a),k(b,[{key:"convertPitchToTreble",value:function(a){if(void 0===this.lowestLine)return console.log("no first line defined for clef",this.name,this),a;var b=this.lowestLineTrebleOffset,c=new W.Pitch(a.step);return c.octave=a.octave,c.diatonicNoteNum+=b,c.accidental=a.accidental,c}}]),b}(A.Music21Object);fa.Clef=ga;var ha=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"treble"));return a.classes.push("TrebleClef"),a}return l(b,a),b}(ga);fa.TrebleClef=ha;var ia=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"treble",-1));return a.classes.push("Treble8vbClef"),a}return l(b,a),b}(ga);fa.Treble8vbClef=ia;var ja=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"treble",1));return a.classes.push("Treble8vaClef"),a}return l(b,a),b}(ga);fa.Treble8vaClef=ja;var ka=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"bass"));return a.classes.push("BassClef"),a}return l(b,a),b}(ga);fa.BassClef=ka;var la=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"alto"));return a.classes.push("AltoClef"),a}return l(b,a),b}(ga);fa.AltoClef=la;var ma=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"tenor"));return a.classes.push("TenorClef"),a}return l(b,a),b}(ga);fa.TenorClef=ma;var na=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"soprano"));return a.classes.push("SopranoClef"),a}return l(b,a),b}(ga);fa.SopranoClef=na;var oa=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"mezzo-soprano"));return a.classes.push("MezzoSopranoClef"),a}return l(b,a),b}(ga);fa.MezzoSopranoClef=oa;var pa=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,"percussion"));return a.classes.push("PercussionClef"),a}return l(b,a),b}(ga);fa.PercussionClef=pa,fa.bestClef=function(a){for(var b=a.flat,c=0,d=0,e=0;e<b.length;e++){var f=b.get(e);if(void 0!==f.pitch)c+=1,d+=f.pitch.diatonicNoteNum;else if(void 0!==f.pitches)for(var g=0;g<f.pitches.length;g++)c+=1,d+=f.pitches[g].diatonicNoteNum}var h=void 0;return h=0===c?29:d/c,h>28?new fa.TrebleClef:new fa.BassClef},fa.clefFromString=function(a,b){void 0===b&&(b=0);var c=a.trim(),d=void 0,e=void 0;if("percussion"===c.toLowerCase())return new fa.PercussionClef(a,b);2===c.length?(d=c[0].toUpperCase(),e=c[1]):1===c.length&&(d=c[0].toUpperCase(),e="G"===d?2:"F"===d?4:"C"===d?3:0);var f=function(a,b){return a.length===b.length&&a.every(function(a,c){return a===b[c]})},g=[d,e,b];return f(g,["G",2,0])?new fa.TrebleClef:f(g,["G",2,-1])?new fa.Treble8vbClef:f(g,["G",2,1])?new fa.Treble8vaClef:f(g,["F",4,0])?new fa.BassClef:f(g,["F",4,-1])?new fa.Bass8vbClef:f(g,["C",3,0])?new fa.AltoClef:f(g,["C",4,0])?new fa.TenorClef:new fa.Clef(c,b)};var qa={};qa.shortNames=["pppppp","ppppp","pppp","ppp","pp","p","mp","mf","f","fp","sf","ff","fff","ffff","fffff","ffffff"],qa.longNames={ppp:["pianississimo"],pp:["pianissimo"],p:["piano"],mp:["mezzopiano"],mf:["mezzoforte"],f:["forte"],fp:["fortepiano"],sf:["sforzando"],ff:["fortissimo"],fff:["fortississimo"]},qa.englishNames={ppp:["extremely soft"],pp:["very soft"],p:["soft"],mp:["moderately soft"],mf:["moderately loud"],f:["loud"],ff:["very loud"],fff:["extremely loud"]},qa.dynamicStrToScalar={None:[.5],n:[0],pppp:[.1],ppp:[.15],pp:[.25],p:[.35],mp:[.45],mf:[.55],f:[.7],fp:[.75],sf:[.85],ff:[.85],fff:[.9],ffff:[.95]};var ra=function(a){function b(a){j(this,b);var c=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return c.classes.push("Dynamic"),c._value=void 0,c._volumeScalar=void 0,c.longName=void 0,c.englishName=void 0,c.value=a,c}return l(b,a),k(b,[{key:"value",get:function(){return this._value},set:function(a){"string"!=typeof a?(this._volumeScalar=a,this._value=a<=0?"n":a<.11?"pppp":a<.16?"ppp":a<.26?"pp":a<.36?"p":a<.5?"mp":a<.65?"mf":a<.8?"f":a<.9?"ff":"fff"):(this._value=a,this._volumeScalar=void 0),this._value in qa.longNames?this.longName=qa.longNames[this._value][0]:this.longName=void 0,this._value in qa.englishNames?this.englishName=qa.englishNames[this._value][0]:this.englishName=void 0}},{key:"volumeScalar",get:function(){return void 0!==this._volumeScalar?this._volumeScalar:this._value in qa.dynamicStrToScalar?qa.dynamicStrToScalar[this._value][0]:void 0},set:function(a){"number"==typeof a&&a<=1&&a>=0&&(this._volumeScalar=a)}}]),b}(A.Music21Object);qa.Dynamic=ra;var sa={},ta=function(a){function c(){j(this,c);var a=m(this,(c.__proto__||Object.getPrototypeOf(c)).call(this));return a.classes.push("Expression"),a.name="expression",a.vexflowModifier="",a.setPosition=void 0,a}return l(c,a),k(c,[{key:"vexflow",value:function(){var a=new b.Flow.Articulation(this.vexflowModifier);return this.setPosition&&a.setPosition(this.setPosition),a}}]),c}(A.Music21Object);sa.Expression=ta;var ua=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("Fermata"),a.name="fermata",a.vexflowModifier="a@a",a.setPosition=3,a}return l(b,a),b}(ta);sa.Fermata=ua;var va=d,wa=va.unpickler,xa={},ya=function(){function a(){var b=this;j(this,a),this.debug=!0,this.knownUnparsables=["music21.spanner.Line","music21.instrument.Instrument","music21.layout.StaffGroup","music21.layout.StaffLayout","music21.layout.SystemLayout","music21.layout.PageLayout","music21.expressions.TextExpression","music21.bar.Barline","music21.tempo.MetronomeMark","music21.metadata.Metadata"],this.handlers={"music21.duration.Duration":{post_restore:function(a){return a.quarterLength=a._qtrLength,a}},"music21.meter.TimeSignature":{post_restore:function(a){return a._numerator=a.displaySequence._numerator,a._denominator=a.displaySequence._denominator,a}},"music21.stream.Part":{post_restore:function(a){return b.currentPart=a,b.lastClef=void 0,b.lastKeySignature=void 0,b.lastTimeSignature=void 0,b.streamPostRestore(a),a}},"music21.stream.Score":{post_restore:this.streamPostRestore.bind(this)},"music21.stream.Stream":{post_restore:this.streamPostRestore.bind(this)},"music21.stream.Measure":{post_restore:this.streamPostRestore.bind(this)},"music21.stream.Voice":{post_restore:this.streamPostRestore.bind(this)}},this.currentPart=void 0,this.lastClef=void 0,this.lastKeySignature=void 0,this.lastTimeSignature=void 0}return k(a,[{key:"streamPostRestore",value:function(a){var b=a._storedElementOffsetTuples;a._clef=this.lastClef,a._keySignature=this.lastKeySignature,a._timeSignature=this.lastTimeSignature;for(var c=0;c<b.length;c++){var d=b[c][0];d.offset=b[c][1];var e=d.classes;void 0===e&&(console.warn("M21object without classes: ",d),console.warn("Javascript classes are: ",d._py_class),e=[]);var f=this.currentPart;void 0===f&&(f=a);for(var g=!0,h=!1,i=0;i<e.length;i++){for(var j=e[i],k=0;k<this.knownUnparsables.length;k++){-1!==this.knownUnparsables[k].indexOf(j)&&(g=!1)}"TimeSignature"===j?(a._timeSignature=d,this.lastTimeSignature=d,void 0!==f&&void 0===f.timeSignature&&(f.timeSignature=d),g=!1):"Clef"===j?(a._clef=d,this.lastClef=d,void 0!==f&&void 0===f.clef&&(f.clef=d),g=!1):"KeySignature"===j?(a._keySignature=d,this.lastKeySignature=d,void 0!==f&&void 0===f.keySignature&&(f.keySignature=d),g=!1):"Part"===j&&(g=!1,h=!0)}g?a.append(d):h&&a.insert(0,d)}return a}},{key:"run",value:function(a){return wa.decode(a,this.handlers).stream}}]),a}();xa.Converter=ya;var za={},Aa=function(a){function b(a){j(this,b);var c=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return c.classSortOrder=-25,c.partId=void 0,c.partName=void 0,c.partAbbreviation=void 0,c.instrumentId=void 0,c.instrumentName=void 0,c.instrumentAbbreviation=void 0,c.midiProgram=void 0,c._midiChannel=void 0,c.lowestNote=void 0,c.highestNote=void 0,c.transpostion=void 0,c.inGMPercMap=!1,c.soundfontFn=void 0,void 0!==a&&za.find(a),c}return l(b,a),k(b,[{key:"autoAssignMidiChannel",value:function(a){void 0===a&&(a=za.usedChannels);var b=0;this.inGMPercMap&&(b=10);for(var c=b;c<za.maxMidi;c++)if(!(c%16==10&&!0!==this.inGMPercMap||void 0!==a[c]&&a[c]!==this.midiProgram))return a[c]=this.midiProgram,this.midiChannel=c,c}},{key:"oggSounfont",get:function(){return this.soundfontFn+"-ogg.js"}},{key:"mp3Soundfont",get:function(){return this.soundfontFn+"-mp3.js"}},{key:"midiChannel",get:function(){return void 0===this._midiChannel&&this.autoAssignMidiChannel(),this._midiChannel},set:function(a){this._midiChannel=a}}]),b}(A.Music21Object);za.Instrument=Aa,za.usedChannels=[],za.maxMidi=16,za.info=[{fn:"acoustic_grand_piano",name:"Acoustic Grand Piano",midiNumber:0},{fn:"bright_acoustic_piano",name:"Bright Acoustic Piano",midiNumber:1},{fn:"electric_grand_piano",name:"Electric Grand Piano",midiNumber:2},{fn:"honkytonk_piano",name:"Honky-tonk Piano",midiNumber:3},{fn:"electric_piano_1",name:"Electric Piano 1",midiNumber:4},{fn:"electric_piano_2",name:"Electric Piano 2",midiNumber:5},{fn:"harpsichord",name:"Harpsichord",midiNumber:6},{fn:"clavinet",name:"Clavinet",midiNumber:7},{fn:"celesta",name:"Celesta",midiNumber:8},{fn:"glockenspiel",name:"Glockenspiel",midiNumber:9},{fn:"music_box",name:"Music Box",midiNumber:10},{fn:"vibraphone",name:"Vibraphone",midiNumber:11},{fn:"marimba",name:"Marimba",midiNumber:12},{fn:"xylophone",name:"Xylophone",midiNumber:13},{fn:"tubular_bells",name:"Tubular Bells",midiNumber:14},{fn:"dulcimer",name:"Dulcimer",midiNumber:15},{fn:"drawbar_organ",name:"Drawbar Organ",midiNumber:16},{fn:"percussive_organ",name:"Percussive Organ",midiNumber:17},{fn:"rock_organ",name:"Rock Organ",midiNumber:18},{fn:"church_organ",name:"Church Organ",midiNumber:19},{fn:"reed_organ",name:"Reed Organ",midiNumber:20},{fn:"accordion",name:"Accordion",midiNumber:21},{fn:"harmonica",name:"Harmonica",midiNumber:22},{fn:"tango_accordion",name:"Tango Accordion",midiNumber:23},{fn:"acoustic_guitar_nylon",name:"Acoustic Guitar (nylon)",midiNumber:24},{fn:"acoustic_guitar_steel",name:"Acoustic Guitar (steel)",midiNumber:25},{fn:"electric_guitar_jazz",name:"Electric Guitar (jazz)",midiNumber:26},{fn:"electric_guitar_clean",name:"Electric Guitar (clean)",midiNumber:27},{fn:"electric_guitar_muted",name:"Electric Guitar (muted)",midiNumber:28},{fn:"overdriven_guitar",name:"Overdriven Guitar",midiNumber:29},{fn:"distortion_guitar",name:"Distortion Guitar",midiNumber:30},{fn:"guitar_harmonics",name:"Guitar Harmonics",midiNumber:31},{fn:"acoustic_bass",name:"Acoustic Bass",midiNumber:32},{fn:"electric_bass_finger",name:"Electric Bass (finger)",midiNumber:33},{fn:"electric_bass_pick",name:"Electric Bass (pick)",midiNumber:34},{fn:"fretless_bass",name:"Fretless Bass",midiNumber:35},{fn:"slap_bass_1",name:"Slap Bass 1",midiNumber:36},{fn:"slap_bass_2",name:"Slap Bass 2",midiNumber:37},{fn:"synth_bass_1",name:"Synth Bass 1",midiNumber:38},{fn:"synth_bass_2",name:"Synth Bass 2",midiNumber:39},{fn:"violin",name:"Violin",midiNumber:40},{fn:"viola",name:"Viola",midiNumber:41},{fn:"cello",name:"Cello",midiNumber:42},{fn:"contrabass",name:"Contrabass",midiNumber:43},{fn:"tremolo_strings",name:"Tremolo Strings",midiNumber:44},{fn:"pizzicato_strings",name:"Pizzicato Strings",midiNumber:45},{fn:"orchestral_harp",name:"Orchestral Harp",midiNumber:46},{fn:"timpani",name:"Timpani",midiNumber:47},{fn:"string_ensemble_1",name:"String Ensemble 1",midiNumber:48},{fn:"string_ensemble_2",name:"String Ensemble 2",midiNumber:49},{fn:"synth_strings_1",name:"Synth Strings 1",midiNumber:50},{fn:"synth_strings_2",name:"Synth Strings 2",midiNumber:51},{fn:"choir_aahs",name:"Choir Aahs",midiNumber:52},{fn:"voice_oohs",name:"Voice Oohs",midiNumber:53},{fn:"synth_choir",name:"Synth Choir",midiNumber:54},{fn:"orchestra_hit",name:"Orchestra Hit",midiNumber:55},{fn:"trumpet",name:"Trumpet",midiNumber:56},{fn:"trombone",name:"Trombone",midiNumber:57},{fn:"tuba",name:"Tuba",midiNumber:58},{fn:"muted_trumpet",name:"Muted Trumpet",midiNumber:59},{fn:"french_horn",name:"French Horn",midiNumber:60},{fn:"brass_section",name:"Brass Section",midiNumber:61},{fn:"synth_brass_1",name:"Synth Brass 1",midiNumber:62},{fn:"synth_brass_2",name:"Synth Brass 2",midiNumber:63},{fn:"soprano_sax",name:"Soprano Sax",midiNumber:64},{fn:"alto_sax",name:"Alto Sax",midiNumber:65},{fn:"tenor_sax",name:"Tenor Sax",midiNumber:66},{fn:"baritone_sax",name:"Baritone Sax",midiNumber:67},{fn:"oboe",name:"Oboe",midiNumber:68},{fn:"english_horn",name:"English Horn",midiNumber:69},{fn:"bassoon",name:"Bassoon",midiNumber:70},{fn:"clarinet",name:"Clarinet",midiNumber:71},{fn:"piccolo",name:"Piccolo",midiNumber:72},{fn:"flute",name:"Flute",midiNumber:73},{fn:"recorder",name:"Recorder",midiNumber:74},{fn:"pan_flute",name:"Pan Flute",midiNumber:75},{fn:"blown_bottle",name:"Blown bottle",midiNumber:76},{fn:"shakuhachi",name:"Shakuhachi",midiNumber:77},{fn:"whistle",name:"Whistle",midiNumber:78},{fn:"ocarina",name:"Ocarina",midiNumber:79},{fn:"lead_1_square",name:"Lead 1 (square)",midiNumber:80},{fn:"lead_2_sawtooth",name:"Lead 2 (sawtooth)",midiNumber:81},{fn:"lead_3_calliope",name:"Lead 3 (calliope)",midiNumber:82},{fn:"lead_4_chiff",name:"Lead 4 chiff",midiNumber:83},{fn:"lead_5_charang",name:"Lead 5 (charang)",midiNumber:84},{fn:"lead_6_voice",name:"Lead 6 (voice)",midiNumber:85},{fn:"lead_7_fifths",name:"Lead 7 (fifths)",midiNumber:86},{fn:"lead_8_bass__lead",name:"Lead 8 (bass + lead)",midiNumber:87},{fn:"pad_1_new_age",name:"Pad 1 (new age)",midiNumber:88},{fn:"pad_2_warm",name:"Pad 2 (warm)",midiNumber:89},{fn:"pad_3_polysynth",name:"Pad 3 (polysynth)",midiNumber:90},{fn:"pad_4_choir",name:"Pad 4 (choir)",midiNumber:91},{fn:"pad_5_bowed",name:"Pad 5 (bowed)",midiNumber:92},{fn:"pad_6_metallic",name:"Pad 6 (metallic)",midiNumber:93},{fn:"pad_7_halo",name:"Pad 7 (halo)",midiNumber:94},{fn:"pad_8_sweep",name:"Pad 8 (sweep)",midiNumber:95},{fn:"fx_1_rain",name:"FX 1 (rain)",midiNumber:96},{fn:"fx_2_soundtrack",name:"FX 2 (soundtrack)",midiNumber:97},{fn:"fx_3_crystal",name:"FX 3 (crystal)",midiNumber:98},{fn:"fx_4_atmosphere",name:"FX 4 (atmosphere)",midiNumber:99},{fn:"fx_5_brightness",name:"FX 5 (brightness)",midiNumber:100},{fn:"fx_6_goblins",name:"FX 6 (goblins)",midiNumber:101},{fn:"fx_7_echoes",name:"FX 7 (echoes)",midiNumber:102},{fn:"fx_8_scifi",name:"FX 8 (sci-fi)",midiNumber:103},{fn:"sitar",name:"Sitar",midiNumber:104},{fn:"banjo",name:"Banjo",midiNumber:105},{fn:"shamisen",name:"Shamisen",midiNumber:106},{fn:"koto",name:"Koto",midiNumber:107},{fn:"kalimba",name:"Kalimba",midiNumber:108},{fn:"bagpipe",name:"Bagpipe",midiNumber:109},{fn:"fiddle",name:"Fiddle",midiNumber:110},{fn:"shanai",name:"Shanai",midiNumber:111},{fn:"tinkle_bell",name:"Tinkle Bell",midiNumber:112},{fn:"agogo",name:"Agogo",midiNumber:113},{fn:"steel_drums",name:"Steel Drums",midiNumber:114},{fn:"woodblock",name:"Woodblock",midiNumber:115},{fn:"taiko_drum",name:"Taiko Drum",midiNumber:116},{fn:"melodic_tom",name:"Melodic Tom",midiNumber:117},{fn:"synth_drum",name:"Synth Drum",midiNumber:118},{fn:"reverse_cymbal",name:"Reverse Cymbal",midiNumber:119},{fn:"guitar_fret_noise",name:"Guitar Fret Noise",midiNumber:120},{fn:"breath_noise",name:"Breath Noise",midiNumber:121},{fn:"seashore",name:"Seashore",midiNumber:122},{fn:"bird_tweet",name:"Bird Tweet",midiNumber:123},{fn:"telephone_ring",name:"Telephone Ring",midiNumber:124},{fn:"helicopter",name:"Helicopter",midiNumber:125},{fn:"applause",name:"Applause",midiNumber:126},{fn:"gunshot",name:"Gunshot",midiNumber:127}],za.find=function(a,b){void 0===b&&(b=new za.Instrument);for(var c=0;c<za.info.length;c++){var d=za.info[c];if(d.fn===a||d.name===a)return b.soundfontFn=d.fn,
b.instrumentName=d.name,b.midiProgram=d.midiNumber,b}};var Ba={};Ba.IntervalDirections={DESCENDING:-1,OBLIQUE:0,ASCENDING:1},Ba.IntervalDirectionTerms=["Descending","Oblique","Ascending"],Ba.MusicOrdinals=[void 0,"Unison","Second","Third","Fourth","Fifth","Sixth","Seventh","Octave","Ninth","Tenth","Eleventh","Twelfth","Thirteenth","Fourteenth","Double Octave"];var Ca=function(a){function b(a){j(this,b);var c=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));c.classes.push("GenericInterval"),void 0===a&&(a=1),c.value=a,c.directed=c.value,c.undirected=Math.abs(c.value),1===c.directed?c.direction=Ba.IntervalDirections.OBLIQUE:c.directed<0?c.direction=Ba.IntervalDirections.DESCENDING:c.directed>1&&(c.direction=Ba.IntervalDirections.ASCENDING),c.undirected>2?c.isSkip=!0:c.isSkip=!1,2===c.undirected?c.isDiatonicStep=!0:c.isDiatonicStep=!1,c.isStep=c.isDiatonicStep,1===c.undirected?c.isUnison=!0:c.isUnison=!1;var d=c.undirected%7,e=parseInt(c.undirected/7);return 0===d&&(e-=1,d=7),c.simpleUndirected=d,c.undirectedOctaves=e,c.semiSimpleUndirected=1===d&&e>=1?8:c.simpleUndirected,c.direction===Ba.IntervalDirections.DESCENDING?(c.octaves=-1*e,c.simpleDirected=1!==d?-1*d:1,c.semiSimpleDirected=-1*c.semiSimpleUndirected):(c.octaves=e,c.simpleDirected=d,c.semiSimpleDirected=c.semiSimpleUndirected),1===c.simpleUndirected||4===c.simpleUndirected||5===c.simpleUndirected?c.perfectable=!0:c.perfectable=!1,c.undirected<Ba.MusicOrdinals.length?c.niceName=Ba.MusicOrdinals[c.undirected]:c.niceName=c.undirected.toString(),c.simpleNiceName=Ba.MusicOrdinals[c.simpleUndirected],c.semiSimpleNiceName=Ba.MusicOrdinals[c.semiSimpleUndirected],1===Math.abs(c.directed)?c.staffDistance=0:c.directed>1?c.staffDistance=c.directed-1:c.directed<-1&&(c.staffDistance=c.directed+1),c.mod7inversion=9-c.semiSimpleUndirected,c.direction===Ba.IntervalDirections.DESCENDING?c.mod7=c.mod7inversion:c.mod7=c.simpleDirected,c}return l(b,a),k(b,[{key:"complement",value:function(){return new Ba.GenericInterval(this.mod7inversion)}},{key:"reverse",value:function(){return 1===this.undirected?new Ba.GenericInterval(1):new Ba.GenericInterval(this.undirected*(-1*this.direction))}},{key:"getDiatonic",value:function(a){return new Ba.DiatonicInterval(a,this)}},{key:"transposePitch",value:function(a){var b=new W.Pitch;b.step=a.step,b.octave=a.octave;var c=a.diatonicNoteNum,d=this.staffDistance,e=c+d,f=Ba.IntervalConvertDiatonicNumberToStep(e);return b.step=f[0],b.octave=f[1],void 0!==a.accidental&&(b.accidental=new W.Accidental(a.accidental.name)),b}}]),b}(v.ProtoM21Object);Ba.GenericInterval=Ca,Ba.IntervalSpecifiersEnum={PERFECT:1,MAJOR:2,MINOR:3,AUGMENTED:4,DIMINISHED:5,DBLAUG:6,DBLDIM:7,TRPAUG:8,TRPDIM:9,QUADAUG:10,QUADDIM:11},Ba.IntervalNiceSpecNames=["ERROR","Perfect","Major","Minor","Augmented","Diminished","Doubly-Augmented","Doubly-Diminished","Triply-Augmented","Triply-Diminished","Quadruply-Augmented","Quadruply-Diminished"],Ba.IntervalPrefixSpecs=[void 0,"P","M","m","A","d","AA","dd","AAA","ddd","AAAA","dddd"],Ba.IntervalOrderedPerfSpecs=["dddd","ddd","dd","d","P","A","AA","AAA","AAAA"],Ba.IntervalPerfSpecifiers=[Ba.IntervalSpecifiersEnum.QUADDMIN,Ba.IntervalSpecifiersEnum.TRPDIM,Ba.IntervalSpecifiersEnum.DBLDIM,Ba.IntervalSpecifiersEnum.DIMINISHED,Ba.IntervalSpecifiersEnum.PERFECT,Ba.IntervalSpecifiersEnum.AUGMENTED,Ba.IntervalSpecifiersEnum.DBLAUG,Ba.IntervalSpecifiersEnum.TRPAUG,Ba.IntervalSpecifiersEnum.QUADAUG],Ba.IntervalPerfOffset=4,Ba.IntervalOrderedImperfSpecs=["dddd","ddd","dd","d","m","M","A","AA","AAA","AAAA"],Ba.IntervalSpecifiers=[Ba.IntervalSpecifiersEnum.QUADDMIN,Ba.IntervalSpecifiersEnum.TRPDIM,Ba.IntervalSpecifiersEnum.DBLDIM,Ba.IntervalSpecifiersEnum.DIMINISHED,Ba.IntervalSpecifiersEnum.MINOR,Ba.IntervalSpecifiersEnum.MAJOR,Ba.IntervalSpecifiersEnum.AUGMENTED,Ba.IntervalSpecifiersEnum.DBLAUG,Ba.IntervalSpecifiersEnum.TRPAUG,Ba.IntervalSpecifiersEnum.QUADAUG],Ba.IntervalMajOffset=5,Ba.IntervalSemitonesGeneric={1:0,2:2,3:4,4:5,5:7,6:9,7:11},Ba.IntervalAdjustPerfect={P:0,A:1,AA:2,AAA:3,AAAA:4,d:-1,dd:-2,ddd:-3,dddd:-4},Ba.IntervalAdjustImperf={M:0,m:-1,A:1,AA:2,AAA:3,AAAA:4,d:-2,dd:-3,ddd:-4,dddd:-5};var Da=function(a){function b(a,c){j(this,b);var d=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));d.classes.push("DiatonicInterval"),void 0===a&&(a="P"),void 0===c?c=new Ba.GenericInterval(1):"number"==typeof c&&(c=new Ba.GenericInterval(c)),d.name="",d.specifier="number"==typeof a?a:Ba.IntervalPrefixSpecs.indexOf(a),d.generic=c,1!==c.undirected||a===Ba.IntervalSpecifiersEnum.PERFECT?d.direction=c.direction:Ba.IntervalPerfSpecifiers.indexOf(a)<=Ba.IntervalPerfSpecifiers.indexOf(Ba.IntervalSpecifiersEnum.DIMINISHED)?d.direction=Ba.IntervalDirections.DESCENDING:d.direction=Ba.IntervalDirections.ASCENDING;var e=Ba.IntervalDirectionTerms[d.direction+1];return d.name=Ba.IntervalPrefixSpecs[d.specifier]+c.undirected.toString(),d.niceName=Ba.IntervalNiceSpecNames[d.specifier]+" "+c.niceName,d.simpleName=Ba.IntervalPrefixSpecs[d.specifier]+c.simpleUndirected.toString(),d.simpleNiceName=Ba.IntervalNiceSpecNames[d.specifier]+" "+c.simpleNiceName,d.semiSimpleName=Ba.IntervalPrefixSpecs[d.specifier]+c.semiSimpleUndirected.toString(),d.semiSimpleNiceName=Ba.IntervalNiceSpecNames[d.specifier]+" "+c.semiSimpleNiceName,d.directedName=Ba.IntervalPrefixSpecs[d.specifier]+c.directed.toString(),d.directedNiceName=e+" "+d.niceName,d.directedSimpleName=Ba.IntervalPrefixSpecs[d.specifier]+c.simpleDirected.toString(),d.directedSimpleNiceName=e+" "+d.simpleNiceName,d.directedSemiSimpleName=Ba.IntervalPrefixSpecs[d.specifier]+c.semiSimpleDirected.toString(),d.directedSemiSimpleNiceName=e+" "+d.semiSimpleNameName,d.specificName=Ba.IntervalNiceSpecNames[d.specifier],d.perfectable=c.perfectable,d.isDiatonicStep=c.isDiatonicStep,d.isStep=c.isStep,d.perfectable?(d.orderedSpecifierIndex=Ba.IntervalOrderedPerfSpecs.indexOf(Ba.IntervalPrefixSpecs[d.specifier]),d.invertedOrderedSpecIndex=Ba.IntervalOrderedPerfSpecs.length-1-d.orderedSpecifierIndex,d.invertedOrderedSpecifier=Ba.IntervalOrderedPerfSpecs[d.invertedOrderedSpecIndex]):(d.orderedSpecifierIndex=Ba.IntervalOrderedImperfSpecs.indexOf(Ba.IntervalPrefixSpecs[d.specifier]),d.invertedOrderedSpecIndex=Ba.IntervalOrderedImperfSpecs.length-1-d.orderedSpecifierIndex,d.invertedOrderedSpecifier=Ba.IntervalOrderedImperfSpecs[d.invertedOrderedSpecIndex]),d.mod7inversion=d.invertedOrderedSpecifier+c.mod7inversion.toString(),d}return l(b,a),k(b,[{key:"getChromatic",value:function(){var a=Math.floor(Math.abs(this.generic.staffDistance)/7),b=Ba.IntervalSemitonesGeneric[this.generic.simpleUndirected],c=Ba.IntervalPrefixSpecs[this.specifier],d=0;d=this.generic.perfectable?Ba.IntervalAdjustPerfect[c]:Ba.IntervalAdjustImperf[c];var e=12*a+b+d;return this.generic.direction===Ba.IntervalDirections.DESCENDING&&(e*=-1),t&&(console.log("DiatonicInterval.getChromatic -- octaveOffset: "+a),console.log("DiatonicInterval.getChromatic -- semitonesStart: "+b),console.log("DiatonicInterval.getChromatic -- specName: "+c),console.log("DiatonicInterval.getChromatic -- semitonesAdjust: "+d),console.log("DiatonicInterval.getChromatic -- semitones: "+e)),new Ba.ChromaticInterval(e)}}]),b}(v.ProtoM21Object);Ba.DiatonicInterval=Da;var Ea=function(a){function b(a){j(this,b);var c=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return c.classes.push("ChromaticInterval"),c.semitones=a,c.cents=Math.round(100*a,5),c.directed=a,c.undirected=Math.abs(a),0===c.directed?c.direction=Ba.IntervalDirections.OBLIQUE:c.directed===c.undirected?c.direction=Ba.IntervalDirections.ASCENDING:c.direction=Ba.IntervalDirections.DESCENDING,c.mod12=c.semitones%12,c.simpleUndirected=c.undirected%12,c.direction===Ba.IntervalDirections.DESCENDING?c.simpleDirected=-1*c.simpleUndirected:c.simpleDirected=c.simpleUndirected,c.intervalClass=c.mod12,c.mod12>6&&(c.intervalClass=12-c.mod12),1===c.undirected?c.isChromaticStep=!0:c.isChromaticStep=!1,c}return l(b,a),k(b,[{key:"reverse",value:function(){return new Ba.ChromaticInterval(this.undirected*(-1*this.direction))}},{key:"transposePitch",value:function(a){var b=!1;void 0===a.octave&&(b=!0);var c=a.ps,d=new W.Pitch;return d.ps=c+this.semitones,b&&(d.octave=void 0),d}}]),b}(v.ProtoM21Object);Ba.ChromaticInterval=Ea,Ba.IntervalStepNames=["C","D","E","F","G","A","B"],Ba.IntervalConvertDiatonicNumberToStep=function(a){var b=void 0,c=void 0;return 0===a?["B",-1]:(a>0?(c=Math.floor((a-1)/7),b=a-1-7*c):(c=Math.floor(a/7),b=a-1-7*(c+1)),[Ba.IntervalStepNames[b],c])};var Fa=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));a.classes.push("Interval");for(var c=arguments.length,d=Array(c),e=0;e<c;e++)d[e]=arguments[e];if(1===d.length){var f=d[0];if("string"==typeof f){var g=f.slice(0,1),h=parseInt(f.slice(1)),i=new Ba.GenericInterval(h),k=new Ba.DiatonicInterval(g,i);a.diatonic=k,a.chromatic=a.diatonic.getChromatic()}else void 0!==f.specifier?(a.diatonic=f,a.chromatic=a.diatonic.getChromatic()):console.error("cant parse string arguments to Interval yet")}else if(2===d.length)if(void 0===d[0].pitch&&void 0===d[0].diatonicNoteNum)a.diatonic=d[0],a.chromatic=d[1];else{var l=d[0],n=d[1],o=Ba.notesToGeneric(l,n),p=Ba.notesToChromatic(l,n);a.diatonic=Ba.intervalsToDiatonic(o,p),a.chromatic=p}return a.reinit(),a}return l(b,a),k(b,[{key:"reinit",value:function(){this.direction=this.chromatic.direction,this.specifier=this.diatonic.specifier,this.diatonicType=this.diatonic.specifier,this.generic=this.diatonic.generic,this.name=this.diatonic.name,this.niceName=this.diatonic.niceName,this.simpleName=this.diatonic.simpleName,this.simpleNiceName=this.diatonic.simpleNiceName,this.semiSimpleName=this.diatonic.semiSimpleName,this.semiSimpleNiceName=this.diatonic.semiSimpleNiceName,this.directedName=this.diatonic.directedName,this.directedNiceName=this.diatonic.directedNiceName,this.directedSimpleName=this.diatonic.directedSimpleName,this.directedSimpleNiceName=this.diatonic.directedSimpleNiceName,this.isDiatonicStep=this.diatonic.isDiatonicStep,this.isChromaticStep=this.chromatic.isChromaticStep,this.semitones=this.chromatic.semitones,this.intervalClass=this.chromatic.intervalClass,this.cents=this.chromatic.cents,this.isStep=this.isChromaticStep||this.isDiatonicStep}},{key:"isConsonant",value:function(){return-1!==["P5","m3","M3","m6","M6","P1"].indexOf(this.simpleName)}},{key:"transposePitch",value:function(a){var b=this.diatonic.generic.transposePitch(a);b.accidental=void 0;var c=this.chromatic.semitones-parseInt(b.ps-a.ps);return 0!==c&&(b.accidental=new W.Accidental(c)),t&&(console.log("Interval.transposePitch -- new step "+b.step),console.log("Interval.transposePitch -- new octave "+b.octave),console.log("Interval.transposePitch -- fixing halfsteps for "+c)),b}},{key:"complement",get:function(){return new Ba.Interval(this.diatonic.mod7inversion)}}]),b}(v.ProtoM21Object);Ba.Interval=Fa,Ba.notesToGeneric=function(a,b){var c=a;void 0!==a.pitch&&(c=a.pitch);var d=b;void 0!==b.pitch&&(d=b.pitch);var e=d.diatonicNoteNum-c.diatonicNoteNum,f=Ba.convertStaffDistanceToInterval(e);return new Ba.GenericInterval(f)},Ba.convertStaffDistanceToInterval=function(a){return 0===a?1:a>0?a+1:a-1},Ba.notesToChromatic=function(a,b){var c=a;void 0!==a.pitch&&(c=a.pitch);var d=b;return void 0!==b.pitch&&(d=b.pitch),new Ba.ChromaticInterval(d.ps-c.ps)},Ba.intervalsToDiatonic=function(a,b){var c=Ba._getSpecifierFromGenericChromatic(a,b);return new Ba.DiatonicInterval(c,a)},Ba._getSpecifierFromGenericChromatic=function(a,b){var c=[void 0,0,2,4,5,7,9,11],d=c[a.simpleUndirected]+12*a.undirectedOctaves,e=0;e=a.direction!==b.direction&&a.direction!==Ba.IntervalDirections.OBLIQUE&&b.direction!==Ba.IntervalDirections.OBLIQUE?-1*b.undirected:1===a.undirected?b.directed:b.undirected;var f=Math.round(e);return a.perfectable?Ba.IntervalPerfSpecifiers[Ba.IntervalPerfOffset+f-d]:Ba.IntervalSpecifiers[Ba.IntervalMajOffset+f-d]};var Ga={};Ga.SimpleDiatonicScale=function(a,b){if(void 0===a)a=new W.Pitch("C4");else if(!(a instanceof W.Pitch))throw new q("Cannot make a scale not from a music21.pitch.Pitch object: "+a);void 0===b&&(b=["M","M","m","M","M","M","m"]);for(var c=new Ba.GenericInterval(2),d=[a],e=a,f=0;f<b.length;f++){var g=new Ba.DiatonicInterval(b[f],c),h=new Ba.Interval(g),i=h.transposePitch(e);t&&console.log("ScaleSimpleMajor -- adding pitch: "+i.name),d.push(i),e=i}return d},Ga.ScaleSimpleMajor=function(a){var b=["M","M","m","M","M","M","m"];return new Ga.SimpleDiatonicScale(a,b)},Ga.ScaleSimpleMinor=function(a,b){var c=["M","m","M","M","m","M","M"];return"string"==typeof b&&(b=b.replace(/\s/g,"-")),"harmonic"===b||"harmonic-minor"===b?(c[5]="A",c[6]="m"):"melodic"!==b&&"melodic-ascending"!==b&&"melodic-minor"!==b&&"melodic-minor-ascending"!==b||(c[4]="M",c[6]="m"),new Ga.SimpleDiatonicScale(a,c)};var Ha={};Ha.modeSharpsAlter={major:0,minor:-3,dorian:-2,phrygian:-4,lydian:1,mixolydian:-1,locrian:-5};var Ia=function(a){function b(a){j(this,b);var c=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return c.classes.push("KeySignature"),c._sharps=a||0,c._alteredPitchesCache=void 0,c.flatMapping=["C","F","B-","E-","A-","D-","G-","C-","F-","B--","E--","A--","D--"],c.sharpMapping=["C","G","D","A","E","B","F#","C#","G#","D#","A#","E#","B#"],c}return l(b,a),k(b,[{key:"majorName",value:function(){return this.sharps>=0?this.sharpMapping[this.sharps]:this.flatMapping[Math.abs(this.sharps)]}},{key:"minorName",value:function(){var a=this.sharps+3;return a>=0?this.sharpMapping[a]:this.flatMapping[Math.abs(a)]}},{key:"vexflow",value:function(){return console.log("calling deprecated function KeySignature.vexflow"),this.majorName().replace(/-/g,"b")}},{key:"accidentalByStep",value:function(a){for(var b=this.alteredPitches,c=0;c<b.length;c++)if(b[c].step===a){if(void 0===b[c].accidental)return;return new W.Accidental(b[c].accidental.alter)}}},{key:"transposePitchFromC",value:function(a){var b=void 0,c=void 0;if(0===this.sharps)return new W.Pitch(a.nameWithOctave);this.sharps<0?(c=Math.abs(this.sharps),b=new Ba.Interval("P4")):(c=this.sharps,b=new Ba.Interval("P5"));for(var d=a,e=0;e<c;e++)d=b.transposePitch(d),e%2==1&&(d.octave-=1);return d}},{key:"sharps",get:function(){return this._sharps},set:function(a){this._alteredPitchesCache=[],this._sharps=a}},{key:"width",get:function(){return 0===this.sharps?0:12*Math.abs(this.sharps)+6}},{key:"alteredPitches",get:function(){if(void 0!==this._alteredPitchesCache)return this._alteredPitchesCache;var a="P5",b="B";this.sharps<0&&(a="P4",b="F");for(var c=new Ba.Interval(a),d=[],e=new W.Pitch(b),f=0;f<Math.abs(this.sharps);f++)e=c.transposePitch(e),e.octave=4,d.push(e);return this._alteredPitchesCache=d,d}}]),b}(A.Music21Object);Ha.KeySignature=Ia;var Ja=function(a){function b(a,c){if(j(this,b),void 0===a&&(a="C"),void 0===c){c=a===a.toLowerCase()?"minor":"major"}var d="A-- E-- B-- F- C- G- D- A- E- B- F C G D A E B F# C# G# D# A# E# B#".split(" "),e=d.indexOf(a.toUpperCase());if(-1===e)throw new q("Cannot find the key for "+a);var f=Ha.modeSharpsAlter[c]||0,g=e+f-11;t&&console.log("Found sharps "+g+" for key: "+a);var h=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,g));return h.tonic=a,h.mode=c,h}return l(b,a),k(b,[{key:"getScale",value:function(a){void 0===a&&(a=this.mode);var b=new W.Pitch(this.tonic);return"major"===a?Ga.ScaleSimpleMajor(b):Ga.ScaleSimpleMinor(b,a)}}]),b}(Ia);Ha.Key=Ja;var Ka={};Ka.transposeOctave=0;var La=function(){function a(b,c,d,e){j(this,a),this.timing=b,this.data1=c,this.data2=d,this.data3=e,this.midiCommand=c>>4,this.noteOff=8===this.midiCommand,this.noteOn=9===this.midiCommand,this.midiNote=void 0,(this.noteOn||this.noteOff)&&(this.midiNote=this.data2+12*Ka.transposeOctave,this.velocity=this.data3)}return k(a,[{key:"sendToMIDIjs",value:function(){void 0!==c?this.noteOn?c.noteOn(0,this.midiNote,this.velocity,0):this.noteOff&&c.noteOff(0,this.midiNote,0):console.warn("could not playback note because no MIDIout defined")}},{key:"music21Note",value:function(){var a=new Z.Note;return a.pitch.ps=this.midiNote,a}}]),a}();Ka.Event=La,Ka.maxDelay=100,Ka.heldChordTime=0,Ka.heldChordNotes=void 0,Ka.timeOfLastNote=Date.now(),Ka._baseTempo=60,Ka.metronome=void 0,Object.defineProperties(Ka,{tempo:{enumerable:!0,get:function(){return void 0===this.metronome?this._baseTempo:this.metronome.tempo},set:function(a){void 0===this.metronome?this._baseTempo=a:this.metronome.tempo=a}}}),Ka.clearOldChords=function(){var a=Date.now();Ka.heldChordTime+Ka.maxDelay<a&&(Ka.heldChordTime=a,void 0!==Ka.heldChordNotes&&(Ka.sendOutChord(Ka.heldChordNotes),Ka.heldChordNotes=void 0)),setTimeout(Ka.clearOldChords,Ka.maxDelay)},Ka.makeChords=function(a){if(a.noteOn){var b=a.music21Note();if(void 0===Ka.heldChordNotes)Ka.heldChordNotes=[b];else{for(var c=0;c<Ka.heldChordNotes.length;c++){if(Ka.heldChordNotes[c].pitch.ps===b.pitch.ps)return}Ka.heldChordNotes.push(b)}}},Ka.lastElement=void 0,Ka.sendOutChord=function(a){var b=void 0;if(a.length>1)b=new da.Chord(a);else{if(1!==a.length)return;b=a[0]}return b.stemDirection="noStem",Ka.quantizeLastNote(),Ka.lastElement=b,void 0!==Ka.callBacks.sendOutChord&&Ka.callBacks.sendOutChord(b),b},Ka.callBacks={raw:function(a,b,c,d){return new Ka.Event(a,b,c,d)},general:[Ka.sendToMIDIjs,Ka.quantizeLastNote],sendOutChord:function(a){}},Ka.quantizeLastNote=function(a){if(void 0!==a||void 0!==(a=this.lastElement)){a.stemDirection=void 0;var b=Date.now(),c=b-this.timeOfLastNote;this.timeOfLastNote=b;var d=6e4/this.tempo,e=c/d,f=Math.round(4*e)/4;return f>=4?f=4:f>=3?f=3:f>2?f=2:1.25===f?f=1:.75===f?f=.5:0===f&&(f=.125),a.duration.quarterLength=f,a}},Ka.sendToMIDIjs=function(a){a.sendToMIDIjs()},Ka.loadedSoundfonts={},Ka.postLoadCallback=function(b,d){t&&(console.log("soundfont loaded about to execute callback."),console.log("first playing two notes very softly -- seems to flush the buffer.")),a(".loadingSoundfont").remove();var e="undefined"!=typeof InstallTrigger,f="HTML Audio Tag"===c.technology,g=za.find(b);if(void 0!==g&&(c.programChange(g.midiChannel,g.midiProgram),t&&console.log(b+" ("+g.midiProgram+") loaded on ",g.midiChannel),!1===e&&!1===f)){var h=g.midiChannel;c.noteOn(h,36,1,0),c.noteOff(h,36,1,.1),c.noteOn(h,48,1,.2),c.noteOff(h,48,1,.3),c.noteOn(h,60,1,.3),c.noteOff(h,60,1,.4)}void 0!==d&&d(g),Ka.loadedSoundfonts[b]=!0},Ka.loadSoundfont=function(b,d){if(!0===Ka.loadedSoundfonts[b]){if(void 0!==d){var e=za.find(b);d(e)}}else if("loading"===Ka.loadedSoundfonts[b]){!function a(){if(!0===Ka.loadedSoundfonts[b]){if(t&&console.log("other process has finished loading; calling callback"),void 0!==d){var c=za.find(b);d(c)}}else t&&console.log("waiting for other process load"),setTimeout(a,100)}()}else Ka.loadedSoundfonts[b]="loading",t&&console.log("waiting for document ready"),a(document).ready(function(){t&&console.log("document ready, waiting to load soundfont"),a(document.body).append(a("<div class='loadingSoundfont'><b>Loading MIDI Instrument</b>: audio will begin when this message disappears.</div>")),c.loadPlugin({soundfontUrl:u.urls.soundfontUrl,instrument:b,onsuccess:Ka.postLoadCallback.bind(c,b,d)})})};var Ma=function(){function b(){j(this,b),this.player=new c.Players.PlayInstance,this.speed=1,this.$playDiv=void 0}return k(b,[{key:"addPlayer",value:function(b){var c=b;void 0===b&&(b=document.body),void 0===b.jquery&&(c=a(b));var d=a('<div class="midiPlayer">'),e=a('<div class="positionControls">'),f=a('<input type="image" src="'+this.playPng()+'" align="absmiddle" value="play" class="playPause">'),g=a('<input type="image" src="'+this.stopPng()+'" align="absmiddle" value="stop" class="stopButton">');f.on("click",this.pausePlayStop.bind(this)),g.on("click",this.stopButton.bind(this)),e.append(f),e.append(g),d.append(e);var h=a('<div class="timeControls">'),i=a('<span class="timePlayed">0:00</span>'),j=a('<span class="capsule"><span class="cursor"></span></span>'),k=a('<span class="timeRemaining">-0:00</span>');return h.append(i),h.append(j),h.append(k),d.append(h),c.append(d),this.$playDiv=d,d}},{key:"stopButton",value:function(){this.pausePlayStop("yes")}},{key:"playPng",value:function(){return u.urls.midiPlayer+"/play.png"}},{key:"pausePng",value:function(){return u.urls.midiPlayer+"/pause.png"}},{key:"stopPng",value:function(){return u.urls.midiPlayer+"/stop.png"}},{key:"pausePlayStop",value:function(a){var b=void 0;b=void 0===this.$playDiv?{src:"doesnt matter"}:this.$playDiv.find(".playPause")[0],"yes"===a?(this.player.stop(),b.src=this.playPng()):this.player.playing||"pause"===a?(b.src=this.playPng(),this.player.pause(!0)):(b.src=this.pausePng(),this.player.resume())}},{key:"base64Load",value:function(a){var b=this.player;b.timeWarp=this.speed;var c=this;Ka.loadSoundfont("acoustic_grand_piano",function(){b.loadFile(a,function(){c.fileLoaded()},void 0,function(a){console.log(a)})})}},{key:"songFinished",value:function(){this.pausePlayStop("yes")}},{key:"fileLoaded",value:function(){this.updatePlaying()}},{key:"startAndUpdate",value:function(){this.player.start(),this.updatePlaying()}},{key:"updatePlaying",value:function(){function a(a){var b=a/60>>0,c=String(a-60*b>>0);return 1===c.length&&(c="0"+c),b+":"+c}var b=this,c=this,d=this.player;if(void 0!==this.$playDiv){var f=this.$playDiv,g=f.find(".timePlayed")[0],h=f.find(".timeRemaining")[0],i=f.find(".cursor")[0],j=f.find(".capsule");e.add(j[0],"drag",function(a,c){e.cancel(a);var d=b.player;d.currentTime=c.x/420*d.endTime,d.currentTime<0&&(d.currentTime=0),d.currentTime>d.endTime&&(d.currentTime=d.endTime),"down"===c.state?b.pausePlayStop("pause"):"up"===c.state&&b.pausePlayStop("play")}),d.setAnimation(function(b){var d=b.now/b.end,e=b.now>>0,f=b.end>>0;e===f&&c.songFinished(),i.style.width=100*d+"%",g.innerHTML=a(e),h.innerHTML="-"+a(f-e)})}}}]),b}();Ka.MidiPlayer=Ma;var Na={},Oa=function(){function a(){j(this,a),this.classes=["Key"],this.callbacks=[],this.scaleFactor=1,this.parent=void 0,this.id=0,this.width=23,this.height=120,this.pitchObj=void 0,this.svgObj=void 0,this.noteNameSvgObj=void 0,this.keyStyle="",this.keyClass=""}return k(a,[{key:"makeKey",value:function(a){var b={style:this.keyStyle,x:a,y:0,class:"keyboardkey "+this.keyClass,id:this.id,width:this.width*this.scaleFactor,height:this.height*this.scaleFactor,rx:3,ry:3},c=u.makeSVGright("rect",b);for(var d in this.callbacks)({}).hasOwnProperty.call(this.callbacks,d)&&c.addEventListener(d,this.callbacks[d],!1);return this.svgObj=c,c}},{key:"addCircle",value:function(a){if(void 0!==this.svgObj&&void 0!==this.parent&&void 0!==this.parent.svgObj){void 0===a&&(a="red");var b=parseInt(this.svgObj.getAttribute("x")),c=b+this.parent.scaleFactor*this.width/2,d={stroke:a,"stroke-width":3,fill:"none",cx:c,cy:(this.height-10)*this.parent.scaleFactor,class:"keyboardkeyannotation",r:this.width*this.parent.scaleFactor/4},e=u.makeSVGright("circle",d);return this.parent.svgObj.appendChild(e),e}}},{key:"addNoteName",value:function(a){if(void 0===this.svgObj||void 0===this.parent||void 0===this.parent.svgObj)return this;if(0===this.id&&void 0===this.pitchObj)return this;if(void 0===this.pitchObj&&(this.pitchObj=new W.Pitch,this.pitchObj.ps=this.id),void 0!==this.pitchObj.accidental&&0!==this.pitchObj.accidental.alter)return this;var b=parseInt(this.svgObj.getAttribute("x")),c=this.pitchObj.name,d=14;!0===a&&(c=this.pitchObj.nameWithOctave,d=12,b-=2),d=Math.floor(d*parent.scaleFactor);var e="white";"whitekey"===this.keyClass&&(e="black");var f={fill:e,x:b+this.parent.scaleFactor*(this.width/2-5),y:this.parent.scaleFactor*(this.height-20),class:"keyboardkeyname","font-size":d},g=u.makeSVGright("text",f),h=document.createTextNode(c);return g.appendChild(h),this.noteNameSvgObj=g,this.parent.svgObj.appendChild(g),this}},{key:"removeNoteName",value:function(){void 0!==this.svgObj&&void 0!==this.parent&&void 0!==this.parent.svgObj&&void 0!==this.noteNameSvgObj&&(this.noteNameSvgObj.parentNode===this.parent.svgObj&&this.parent.svgObj.removeChild(this.noteNameSvgObj),this.noteNameSvgObj=void 0)}}]),a}();Na.Key=Oa;var Pa=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("WhiteKey"),a.width=23,a.height=120,a.keyStyle="fill:#fffff6;stroke:black",a.keyClass="whitekey",a}return l(b,a),b}(Oa);Na.WhiteKey=Pa;var Qa=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("BlackKey"),a.width=13,a.height=80,a.keyStyle="fill:black;stroke:black",a.keyClass="blackkey",a}return l(b,a),b}(Oa);Na.BlackKey=Qa;var Ra=function(){function b(){j(this,b),this.whiteKeyWidth=23,this._defaultWhiteKeyWidth=23,this._defaultBlackKeyWidth=13,this.scaleFactor=1,this.height=120,this.keyObjects={},this.svgObj=void 0,this.markC=!0,this.showNames=!1,this.showOctaves=!1,this.startPitch="C3",this.endPitch="C5",this._startDNN=void 0,this._endDNN=void 0,this.hideable=!1,this.scrollable=!1,this.callbacks={click:this.clickhandler},this.sharpOffsets={0:14.3333,1:18.6666,3:13.25,4:16.25,5:19.75}}return k(b,[{key:"redrawSVG",value:function(){if(void 0!==this.svgObj){var a=this.svgObj,b=a.parentNode;this.keyObjects={};var c=this.createSVG();return b.replaceChild(c,a),c}}},{key:"appendKeyboard",value:function(a){void 0===a?a=document.body:void 0!==a.jquery&&(a=a[0]);var b=this.createSVG();return this.scrollable&&(b=this.wrapScrollable(b)[0]),this.hideable?this.appendHideableKeyboard(a,b):a.appendChild(b),this}},{key:"clickhandler",value:function(a){var b=a.id,d=this.keyObjects[b];if(void 0!==d){var e=d.keyStyle,f="#c0c000";"whitekey"===d.keyClass&&(f="yellow"),a.setAttribute("style","fill:"+f+";stroke:black"),Ka.loadSoundfont("acoustic_grand_piano",function(a){c.noteOn(a.midiChannel,b,100,0),c.noteOff(a.midiChannel,b,500)}),setTimeout(function(){a.setAttribute("style",e)},500)}}},{key:"createSVG",value:function(){if(void 0===this._startDNN)if("string"==typeof this.startPitch){var a=new W.Pitch(this.startPitch);this._startDNN=a.diatonicNoteNum}else this._startDNN=this.startPitch;if(void 0===this._endDNN)if("string"==typeof this.endPitch){var b=new W.Pitch(this.endPitch);this._endDNN=b.diatonicNoteNum}else this._endDNN=this.endPitch;for(var c=(this._startDNN-1)%7,d=1+this._endDNN-this._startDNN,e=this.whiteKeyWidth*this.scaleFactor*d,f=120*this.scaleFactor,g=f.toString()+"px",h=u.makeSVGright("svg",{"xml:space":"preserve",height:g,width:e.toString()+"px",class:"keyboardSVG"}),i=new W.Pitch("C4"),j=[],k=this,l=0;l<d;l++){i.diatonicNoteNum=this._startDNN+l;var m=new Na.WhiteKey;m.id=i.midi,m.parent=this,this.keyObjects[i.midi]=m,m.scaleFactor=this.scaleFactor,m.width=this.whiteKeyWidth,m.callbacks.click=function(){k.clickhandler(this)};var n=m.makeKey(this.whiteKeyWidth*this.scaleFactor*l);if(h.appendChild(n),(0===c||1===c||3===c||4===c||5===c)&&l!==d-1){var o=new Na.BlackKey;o.id=i.midi+1,this.keyObjects[i.midi+1]=o,o.parent=this,o.scaleFactor=this.scaleFactor,o.width=this._defaultBlackKeyWidth*this.whiteKeyWidth/this._defaultWhiteKeyWidth,o.callbacks.click=function(){k.clickhandler(this)};var p=this.sharpOffsets[c];p*=this.whiteKeyWidth/this._defaultWhiteKeyWidth*this.scaleFactor;var q=o.makeKey(this.whiteKeyWidth*this.scaleFactor*l+p);j.push(q)}c+=1,c%=7}for(var r=0;r<j.length;r++)h.appendChild(j[r]);return this.svgObj=h,this.markC&&this.markMiddleC(),this.showNames&&this.markNoteNames(this.showOctaves),h}},{key:"markMiddleC",value:function(a){var b=this.keyObjects[60];void 0!==b&&b.addCircle("red")}},{key:"markNoteNames",value:function(a){this.removeNoteNames();for(var b in this.keyObjects)if({}.hasOwnProperty.call(this.keyObjects,b)){var c=this.keyObjects[b];c.addNoteName(a)}}},{key:"removeNoteNames",value:function(){for(var a in this.keyObjects)if({}.hasOwnProperty.call(this.keyObjects,a)){var b=this.keyObjects[a];b.removeNoteName()}}},{key:"wrapScrollable",value:function(b){var c=this,d=a("<div class='keyboardScrollableWrapper'></div>").css({display:"inline-block"}),e=a("<button class='keyboardOctaveDown'>&lt;&lt;</button>").css({"font-size":Math.floor(15*this.scaleFactor).toString()+"px"}).bind("click",function(){Ka.transposeOctave-=1,c._startDNN-=7,c._endDNN-=7,c.redrawSVG()}),f=a("<button class='keyboardOctaveUp'>&gt;&gt;</button>").css({"font-size":Math.floor(15*this.scaleFactor).toString()+"px"}).bind("click",function(){Ka.transposeOctave+=1,c._startDNN+=7,c._endDNN+=7,c.redrawSVG()}),g=a("<div style='display:inline-block; vertical-align: middle' class='keyboardScrollableInnerDiv'></div>");return g[0].appendChild(b),d.append(e),d.append(g),d.append(f),d}},{key:"appendHideableKeyboard",value:function(b,c){var d=a("<div class='keyboardHideableContainer'/>"),e=a("<div class='keyboardToggleInside'>↥</div>").css({display:"inline-block","padding-top":"40px","font-size":"40px"}),f=a("<div class='keyboardToggleOutside'/>").css({display:"inline-block","vertical-align":"top",background:"white"});f.append(e),f.data("defaultDisplay",d.find(".keyboardSVG").css("display")),f.data("state","down"),f.click(Na.triggerToggleShow);var g=a("<div class='keyboardExplain'>Show keyboard</div>").css({display:"none","background-color":"white",padding:"10px 10px 10px 10px","font-size":"12pt"});return f.append(g),d.append(f),d[0].appendChild(c),a(b).append(d),d}}]),b}();Na.triggerToggleShow=function(b){var c=a(this),d=c.data("state"),e=c.parent(),f=e.find(".keyboardScrollableWrapper");0===f.length&&(f=e.find(".keyboardSVG"));var g=c.find(".keyboardToggleInside"),h=e.find(".keyboardExplain");if("up"===d){g.text("↥"),g.css("padding-top","40px"),h.css("display","none");var i=c.data("defaultDisplay");void 0===i&&(i="inline"),f.css("display",i),c.data("state","down")}else f.css("display","none"),h.css("display","inline-block"),g.text("↧"),g.css("padding-top","10px"),c.data("state","up")},Na.jazzHighlight=function(a){if(void 0!==a)if(a.noteOn){var b=a.midiNote;if(void 0!==this.keyObjects[b]){var c=this.keyObjects[b],d=c.svgObj,e="",f=(a.velocity+25)/127;if(f>1&&(f=1),"whitekey"===c.keyClass){var g=f.toString();e="rgba(255, 255, 0, "+g+")"}else{var h=Math.floor(255*f).toString();e="rgb("+h+","+h+",0)"}d.setAttribute("style","fill:"+e+";stroke:black")}}else if(a.noteOff){var i=a.midiNote;if(void 0!==this.keyObjects[i]){var j=this.keyObjects[i],k=j.svgObj;k.setAttribute("style",j.keyStyle)}}},Na.Keyboard=Ra;var Sa={},Ta=function(a){function c(a){j(this,c);var b=m(this,(c.__proto__||Object.getPrototypeOf(c)).call(this));return b.classes.push("TimeSignature"),b._numerator=4,b._denominator=4,b.beatGroups=[],"string"==typeof a&&(b.ratioString=a),b}return l(c,a),k(c,[{key:"computeBeatGroups",value:function(){var a=[],b=this.numerator,c=this.denominator;if(c<8&&b>=5){var d=8/c;c=8,b*=d}if(c>=8){for(;b>=5;)a.push([3,c]),b-=3;4===b?(a.push([2,c]),a.push([2,c])):b>0&&a.push([b,c])}else 2===c?a.push([1,2]):c<=1?a.push([1,1]):a.push([2,8]);return a}},{key:"vexflowBeatGroups",value:function(){var a=void 0;a=this.beatGroups.length>0?this.beatGroups:this.computeBeatGroups();for(var c=[],d=0;d<a.length;d++){var e=a[d];c.push(new b.Flow.Fraction(e[0],e[1]))}return c}},{key:"numerator",get:function(){return this._numerator},set:function(a){this._numerator=a}},{key:"denominator",get:function(){return this._denominator},set:function(a){this._denominator=a}},{key:"ratioString",get:function(){return this.numerator.toString()+"/"+this.denominator.toString()},set:function(a){var b=a.split("/");this.numerator=parseInt(b[0]),this.denominator=parseInt(b[1])}},{key:"barDuration",get:function(){var a=4*this._numerator/this._denominator;return new x.Duration(a)}}]),c}(A.Music21Object);Sa.TimeSignature=Ta;var Ua={},Va=function a(){j(this,a);var b={displayClef:!0,displayTimeSignature:!0,displayKeySignature:!0,scaleFactor:{x:.7,y:.7},top:0,left:void 0,width:void 0,overriddenWidth:void 0,height:void 0,naiveHeight:120,systemIndex:0,partIndex:0,measureIndex:0,systemMeasureIndex:0,systemPadding:void 0,naiveSystemPadding:40,stemDirection:void 0,maxSystemWidth:void 0,rightBarline:void 0,
staffLines:5,staffConnectors:["single","brace"],staffPadding:60,events:{click:"play",dblclick:void 0},startNewSystem:!1,startNewPage:!1,showMeasureNumber:void 0};u.merge(this,b)};Ua.RenderOptions=Va;var Wa={},Xa=function(){function b(a,c){j(this,b),this.pixelMapper=new Wa.PixelMapper(a),this.stream=a,this.canvas=c,this.tempo=a.tempo,this.lastX=0,this.lastNoteIndex=-1,this.barDOM=void 0,this.svgDOM=void 0,this.canvasParent=void 0,this.lastTimeout=void 0,this.startTime=(new Date).getTime(),this.previousSystemIndex=0,this.eachSystemHeight=120,this.timingMS=50,this.savedRenderOptionClick=void 0,this.scrollScore=function(){var a=(new Date).getTime()-this.startTime,b=a/1e3*this.tempo/60,c=this.pixelMapper,d=c.getSystemIndexAtOffset(b);d>this.previousSystemIndex&&(this.lastX=-100,this.previousSystemIndex=d,this.barDOM.setAttribute("y",d*this.eachSystemHeight));var e=c.getXAtOffset(b);(e=Math.floor(e))>this.lastX&&(this.barDOM.setAttribute("x",e),this.lastX=e);for(var f=0;f<c.allMaps.length;f++){var g=c.allMaps[f].offset;if(!(f<=this.lastNoteIndex)&&!(Math.abs(b-g)>.1)){for(var h=c.allMaps[f].elements,i=0;i<h.length;i++){var j=h[i];void 0!==j&&void 0!==j.playMidi&&j.playMidi(this.tempo)}this.lastNoteIndex=f}}var k=void 0;if(e<c.maxX||d<c.maxSystemIndex)k=setTimeout(this.scrollScore,this.timingMS),this.lastTimeout=k;else{this.stopPlaying(void 0)}}.bind(this)}return k(b,[{key:"createScrollBar",value:function(){var b=this.canvas,c=u.makeSVGright("svg",{height:b.height.toString()+"px",width:b.width.toString()+"px",style:"position:absolute; top: 0px; left: 0px;"}),d=this.stream.renderOptions.scaleFactor.y,e=b.height/(d*(this.pixelMapper.maxSystemIndex+1)),f=u.makeSVGright("rect",{width:10,height:e-6,x:this.pixelMapper.startX,y:3,style:"fill: rgba(255, 255, 20, .5);stroke:white"});f.setAttribute("transform","scale("+d+")"),c.appendChild(f);var g=a(b).parent()[0];return g.appendChild(c),this.barDOM=f,this.svgDOM=c,this.canvasParent=g,this.eachSystemHeight=e,f}},{key:"startPlaying",value:function(){this.createScrollBar(),this.savedRenderOptionClick=this.stream.renderOptions.events.click,this.stream.renderOptions.events.click=function(a){this.stopPlaying(a)}.bind(this),this.stream.setRenderInteraction(this.canvasParent),this.scrollScore()}},{key:"stopPlaying",value:function(a){this.stream.renderOptions.events.click=this.savedRenderOptionClick,this.barDOM.setAttribute("style","display:none"),this.canvasParent.removeChild(this.svgDOM),void 0!==this.lastTimeout&&clearTimeout(this.lastTimeout),this.stream.setRenderInteraction(this.canvasParent),void 0!==a&&a.stopPropagation()}}]),b}();Wa.ScrollPlayer=Xa;var Ya=function(){function a(b){j(this,a),this.allMaps=[],this.stream=b,this.notesAndRests=this.stream.flat.notesAndRests,this.pixelScaling=b.renderOptions.scaleFactor.x,this.processStream(b)}return k(a,[{key:"processStream",value:function(){for(var a=this.notesAndRests,b=0;b<a.length;b++){var c=a.get(b);this.addNoteToMap(c)}var d=a.get(-1).activeVexflowNote.stave,e=d.x+d.width,f=a.get(-1).duration.quarterLength+a.get(-1).offset,g=new Wa.PixelMap(this,f);return g.elements=[void 0],g.x=e,g.systemIndex=this.allMaps[this.allMaps.length-1].systemIndex,this.allMaps.push(g),this.allMaps}},{key:"addNoteToMap",value:function(a){var b=a.offset,c=this.findMapForExactOffset(b);if(void 0!==c)return c.elements.push(a),c;var d=new Wa.PixelMap(this,b);return d.elements=[a],this.allMaps.push(d),d}},{key:"findMapForExactOffset",value:function(a){for(var b=this.allMaps.length-1;b>=0;b-=1)if(this.allMaps[b].offset===a)return this.allMaps[b]}},{key:"getPixelMapsAroundOffset",value:function(a){for(var b=void 0,c=void 0,d=0;d<this.allMaps.length;d++){var e=this.allMaps[d];if(e.offset<=a&&(b=e),e.offset>=a){c=e;break}}if(void 0===b&&void 0===c){var f=this.allMaps[this.allMaps.length-1];b=f,c=f}else void 0===b?b=c:void 0===c&&(c=b);return[b,c]}},{key:"getXAtOffset",value:function(a){var b=this.getPixelMapsAroundOffset(a),c=b[0],d=b[1],e=this.pixelScaling,f=a-c.offset,g=d.offset-c.offset,h=d.x-c.x;if(d.systemIndex!==c.systemIndex){var i=c.elements[0].activeVexflowNote.stave;h=(i.x+i.width)*e-c.x}var j=0;j=0!==g?h/g:0;var k=f*j;return(c.x+k)/e}},{key:"getSystemIndexAtOffset",value:function(a){return this.getPixelMapsAroundOffset(a)[0].systemIndex}},{key:"startX",get:function(){return this.allMaps[0].x}},{key:"maxX",get:function(){return this.allMaps[this.allMaps.length-1].x}},{key:"maxSystemIndex",get:function(){return this.allMaps[this.allMaps.length-1].systemIndex}}]),a}();Wa.PixelMapper=Ya;var Za=function(){function a(b,c){j(this,a),this.pixelScaling=b.pixelScaling,this.elements=[],this.offset=c,this._x=void 0,this._systemIndex=void 0}return k(a,[{key:"x",get:function(){return void 0!==this._x?this._x:0===this.elements.length?0:this.elements[0].x*this.pixelScaling},set:function(a){this._x=a}},{key:"systemIndex",get:function(){return void 0!==this._systemIndex?this._systemIndex:0===this.elements.length?0:this.elements[0].systemIndex},set:function(a){this._systemIndex=a}}]),a}();Wa.PixelMap=Za;var $a=function a(b){j(this,a),this.stream=b,this.activeElementHierarchy=[void 0]};Wa.CursorSelect=$a;var _a=(function(){function b(a){var c=this;j(this,b),this.stream=a,this.changedCallbackFunction=void 0,this.canvasChangerFunction=function(a){var b=a.currentTarget,d=c.findNoteForClick(b,a),e=n(d,2),f=e[0],g=e[1];return void 0===g?void(t&&console.log("No note found")):c.noteChanged(f,g,b)}}k(b,[{key:"noteChanged",value:function(a,b,c){var d=b,e=new W.Pitch("C");return e.diatonicNoteNum=a,e.accidental=d.pitch.accidental,d.pitch=e,d.stemDirection=void 0,this.activeNote=d,this.redrawCanvas(c),void 0!==this.changedCallbackFunction?this.changedCallbackFunction({foundNote:d,canvas:c}):void 0}},{key:"findNoteForClick",value:function(a,b,c,d){if(void 0===c||void 0===d){var e=this.getScaledXYforCanvas(a,b),f=n(e,2);c=f[0],d=f[1]}return[this.diatonicNoteNumFromScaledY(d),this.noteElementFromScaledX(c)]}},{key:"diatonicNoteNumFromScaledY",value:function(a){var b=this.stream.recursiveGetStoredVexflowStave(),c=b.options.spacing_between_lines_px,d=b.options.space_above_staff_ln,e=2*a/c,f=2*(b.options.num_lines-1+d)-e;return this.stream.clef.lowestLine+Math.round(f)}},{key:"noteElementFromScaledX",value:function(a,b,c){var d=this.stream,e=void 0;void 0===b&&(b=10);for(var f=0;f<d.length;f++){var g=d.get(f);if(a>g.x-b&&a<g.x+g.width+b){e=g;break}}return e}},{key:"getScaledXYforCanvas",value:function(a,b){var c=this.getUnscaledXYforCanvas(a,b),d=n(c,2),e=d[0],f=d[1],g=this.stream.renderOptions.scaleFactor,h=f/g.y;return[e/g.x,h]}},{key:"getUnscaledXYforCanvas",value:function(b,c){var d=null;d=void 0===b?{left:0,top:0}:a(b).offset();var e=void 0,f=void 0;return void 0!==c.pageX&&void 0!==c.pageY?(e=c.pageX,f=c.pageY):(e=c.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,f=c.clientY+document.body.scrollTop+document.documentElement.scrollTop),[e-d.left,f-d.top]}},{key:"editableAccidentalCanvas",value:function(b,c){var d=a("<div/>").css("text-align","left").css("position","relative"),e=this.getAccidentalToolbar();return d.append(e),d.append(a("<br clear='all'/>")),this.stream.renderOptions.events.click=this.canvasChangerFunction,this.stream.appendNewCanvas(d,b,c),d}},{key:"getAccidentalToolbar",value:function(b,c,d){var e=this;void 0===b&&(b=-1),void 0===c&&(c=1),b=Math.round(b),c=Math.round(c);for(var f=function(b,c){var f=d;if(void 0===f){for(var g=a(c.target).parent();void 0!==g&&(void 0===f||void 0===f[0]);)f=g.find("canvas"),g=g.parent();if(void 0===f[0])return void console.log("Could not find a canvas...")}if(void 0!==e.activeNote){e.activeNote.pitch.accidental=new W.Accidental(b),e.redrawCanvas(f[0]),void 0!==e.changedCallbackFunction&&e.changedCallbackFunction({canvas:f[0]})}},g=a("<div/>").attr("class","accidentalToolbar scoreToolbar"),h=b;h<=c;h++)!function(b){var c=new W.Accidental(b);g.append(a("<button>"+c.unicodeModifier+"</button>").click(function(a){return f(b,a)}))}(h);return g}}])}(),{}),ab=function(){function a(){j(this,a),this.voices=[],this.streams=[],this.textVoices=[]}return k(a,[{key:"allTickables",value:function(){var a=[];return a.push.apply(a,o(this.voices)),a.push.apply(a,o(this.textVoices)),a}},{key:"tickablesByStave",value:function(){var a=[],b=[],c=!0,d=!1,e=void 0;try{for(var f,g=this.allTickables()[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=f.value,i=b.indexOf(h.stave),j=void 0;-1===i?(b.push(h.stave),j=[],a.push(j)):j=a[i],j.push(h)}}catch(a){d=!0,e=a}finally{try{!c&&g.return&&g.return()}finally{if(d)throw e}}return a}}]),a}();_a.RenderStack=ab;var bb=function(){function c(b,d,e){j(this,c),this.stream=b,this.canvas=void 0,this.$canvas=void 0,this.$where=void 0,this.activeFormatter=void 0,this._vfRenderer=void 0,this._ctx=void 0,this.beamGroups=[],this.stacks=[],this.ties=[],this.systemBreakOffsets=[],this.vfTuplets=[],void 0!==e&&(void 0!==e.jquery?this.$where=e:this.$where=a(e)),void 0!==d&&(void 0!==d.jquery?(this.$canvas=d,this.canvas=d[0]):(this.canvas=d,this.$canvas=a(d)))}return k(c,[{key:"render",value:function(a){void 0===a&&(a=this.stream);var b=!1,c=!1,d=a.hasSubStreams();a.isClassOrSubclass("Score")?b=!0:d&&a.get(0).hasSubStreams()?b=!0:d&&(c=!0),b?this.prepareScorelike(a):c?this.preparePartlike(a):this.prepareArrivedFlat(a),this.formatMeasureStacks(),this.drawTies(),this.drawMeasureStacks(),this.drawBeamGroups(),this.drawTuplets()}},{key:"prepareScorelike",value:function(a){for(var b=0;b<a.length;b++){var c=a.get(b);this.preparePartlike(c)}this.addStaffConnectors(a)}},{key:"preparePartlike",value:function(a){this.systemBreakOffsets=[];for(var b=0;b<a.length;b++){var c=a.get(b);c.renderOptions.startNewSystem&&this.systemBreakOffsets.push(c.offset),b===a.length-1&&(c.renderOptions.rightBarline="end"),void 0===this.stacks[b]&&(this.stacks[b]=new _a.RenderStack),this.prepareMeasure(c,this.stacks[b])}this.prepareTies(a)}},{key:"prepareArrivedFlat",value:function(a){var b=new _a.RenderStack;this.prepareMeasure(a,b),this.stacks[0]=b,this.prepareTies(a)}},{key:"prepareMeasure",value:function(a,b){if(void 0===a.hasVoices||!1===a.hasVoices())this.prepareFlat(a,b);else for(var c=void 0,d=a.renderOptions,e=0;e<a.length;e++){var f=a.get(e);c=this.prepareFlat(f,b,c,d)}return b}},{key:"prepareFlat",value:function(a,b,c,d){a.makeAccidentals();var e=void 0;e=void 0!==c?c:this.renderStave(a,d),a.activeVFStave=e;var f=this.getVoice(a,e);return b.voices.push(f),b.streams.push(a),a.hasLyrics()&&b.textVoices.push(this.getLyricVoice(a,e)),e}},{key:"renderStave",value:function(a,b){void 0===a&&(a=this.stream);var c=this.ctx,d=this.newStave(a,b);return this.setClefEtc(a,d,b),d.setContext(c),d.draw(),d}},{key:"drawMeasureStacks",value:function(){for(var a=this.ctx,b=0;b<this.stacks.length;b++)for(var c=this.stacks[b].allTickables(),d=0;d<c.length;d++){var e=c[d];e.draw(a)}}},{key:"drawTuplets",value:function(){var a=this.ctx;this.vfTuplets.forEach(function(b){b.setContext(a).draw()})}},{key:"drawTies",value:function(){for(var a=this.ctx,b=0;b<this.ties.length;b++)this.ties[b].setContext(a).draw()}},{key:"prepareTies",value:function(a){for(var c=a.flat.notesAndRests,d=0;d<c.length-1;d++){var e=c.get(d);if(void 0!==e.tie&&"stop"!==e.tie.type){for(var f=c.get(d+1),g=!0,h=0;h<this.systemBreakOffsets.length;h++){var i=this.systemBreakOffsets[h];if(e.offset<i&&f.offset>=i){g=!1;break}}if(g){var j=new b.Flow.StaveTie({first_note:e.activeVexflowNote,last_note:f.activeVexflowNote,first_indices:[0],last_indices:[0]});this.ties.push(j)}else{var k=new b.Flow.StaveTie({first_note:e.activeVexflowNote,first_indices:[0]});this.ties.push(k);var l=new b.Flow.StaveTie({last_note:f.activeVexflowNote,first_indices:[0]});this.ties.push(l)}}}}},{key:"getVoice",value:function(a,b){void 0===a&&(a=this.stream);var c=this.vexflowNotes(a,b),d=this.vexflowVoice(a);return d.setStave(b),d.addTickables(c),d}},{key:"getLyricVoice",value:function(a,b){var c=this.vexflowVoice(a),d=this.vexflowLyrics(a,b);return c.setStave(b),c.addTickables(d),c}},{key:"formatMeasureStacks",value:function(){for(var a=0;a<this.stacks.length;a++)for(var b=this.stacks[a],c=b.voices,d=b.streams,e=this.formatVoiceGroup(b),f=0;f<d.length;f++){var g=d[f],h=c[f];this.applyFormatterInformationToNotes(h.stave,g,e)}}},{key:"formatVoiceGroup",value:function(a,c){var d=a.allTickables(),e=a.voices,f=a.streams;void 0===c&&(c=f[0].autoBeam);var g=new b.Flow.Formatter;if(0===e.length)return g;for(var h=0,i=0;i<d.length;i++)d[i].stave.getNoteStartX()>h&&(h=d[i].stave.getNoteStartX());for(var j=0;j<d.length;j++)d[j].stave.setNoteStartX(h);var k=e[0].stave,l=a.tickablesByStave(),m=!0,n=!1,p=void 0;try{for(var q,r=l[Symbol.iterator]();!(m=(q=r.next()).done);m=!0){var s=q.value;g.joinVoices(s)}}catch(a){n=!0,p=a}finally{try{!m&&r.return&&r.return()}finally{if(n)throw p}}if(g.formatToStave(d,k),c)for(var t=0;t<e.length;t++){var u,v=e[t],w=[new b.Flow.Fraction(2,8)];void 0!==f[t]&&void 0!==f[t].timeSignature&&(w=f[t].timeSignature.vexflowBeatGroups(b));var x=b.Flow.Beam.applyAndGetBeams(v,void 0,w);(u=this.beamGroups).push.apply(u,o(x))}return g}},{key:"drawBeamGroups",value:function(){for(var a=this.ctx,b=0;b<this.beamGroups.length;b++)this.beamGroups[b].setContext(a).draw()}},{key:"newStave",value:function(a,c){void 0===a&&(a=this.stream),void 0===c&&(c=a.renderOptions);var d=c.width;void 0===d&&(d=a.estimateStaffLength()+c.staffPadding);var e=c.top;void 0===e&&(e=0);var f=c.left;return void 0===f&&(f=10),t&&console.log("creating new stave: left:"+f+" top: "+e+" width: "+d),new b.Flow.Stave(f,e,d)}},{key:"setClefEtc",value:function(a,c,d){if(void 0===d&&(d=a.renderOptions),this.setStafflines(a,c),d.showMeasureNumber&&c.setMeasure(d.measureIndex+1),d.displayClef){var e=void 0;1===a.clef.octaveChange?e="8va":-1===a.clef.octaveChange&&(e="8vb"),c.addClef(a.clef.name,"default",e)}if(void 0!==a.keySignature&&d.displayKeySignature&&c.addKeySignature(a.keySignature.vexflow()),void 0!==a.timeSignature&&d.displayTimeSignature&&c.addTimeSignature(a.timeSignature.numerator.toString()+"/"+a.timeSignature.denominator.toString()),void 0!==d.rightBarline){var f=d.rightBarline,g={single:"SINGLE",double:"DOUBLE",end:"END"},h=g[f];void 0!==h&&c.setEndBarType(b.Flow.Barline.type[h])}}},{key:"setStafflines",value:function(a,b){var c=a.renderOptions;5!==c.staffLines&&(0===c.staffLines?b.setNumLines(0):1===c.staffLines?b.options.line_config=[{visible:!1},{visible:!1},{visible:!0},{visible:!1},{visible:!1}]:2===c.staffLines?b.options.line_config=[{visible:!1},{visible:!1},{visible:!0},{visible:!0},{visible:!1}]:3===c.staffLines?b.options.line_config=[{visible:!1},{visible:!0},{visible:!0},{visible:!0},{visible:!1}]:b.setNumLines(c.staffLines))}},{key:"vexflowNotes",value:function(a,c){void 0===a&&(a=this.stream);for(var d=[],e=[],f=void 0,g=0,h=[],i={clef:a.clef,stave:c},j=0;j<a.length;j++){var k=a.get(j);if(k.isClassOrSubclass("GeneralNote")&&void 0!==k.duration){var l=k.vexflowNote(i);if(void 0===l&&console.error("Cannot create a vexflowNote from: ",k),void 0!==c&&l.setStave(c),d.push(l),k.duration.tuplets.length>0){var m=k.duration.tuplets[0];if(void 0===f&&(f=m),h.push(l),(g+=k.duration.quarterLength)>=f.totalTupletLength()||Math.abs(g-f.totalTupletLength())<.001){var n={num_notes:f.numberNotesActual,notes_occupied:f.numberNotesNormal},o=new b.Flow.Tuplet(h,n);"ratio"===f.tupletNormalShow&&o.setRatioed(!0),e.push(o),g=0,f=void 0,h=[]}}}}if(void 0!==f&&console.warn("incomplete tuplet found in stream: ",a),e.length>0){var p;(p=this.vfTuplets).push.apply(p,e)}return d}},{key:"vexflowLyrics",value:function(a,c){var d=function(a,d,e){return new b.Flow.TextNote({text:a,font:d,duration:e}).setLine(11).setStave(c).setJustification(b.Flow.TextNote.Justification.LEFT)};void 0===a&&(a=this.stream);for(var e={family:"Serif",size:12,weight:""},f=[],g=0;g<a.length;g++){var h=a.get(g),i=h.lyrics,j=void 0,k=h.duration.vexflowDuration,l=!1;if(0===i.length)j="";else if(j=i[0].text,void 0===j&&(j=""),"middle"===i[0].syllabic||"begin"===i[0].syllabic){l=" "+i[0].lyricConnector;var m=h.duration.quarterLength/2;k=new x.Duration(m).vexflowDuration}var n=d(j,e,k);if(f.push(n),!1!==l){var o=d(l,e,k);f.push(o)}}return f}},{key:"vexflowVoice",value:function(a){var c=a.duration.quarterLength,d=Math.round(c/(1/256)),e=1024;d%512==0?(e=2,d/=512):d%256==0?(e=4,d/=256):d%128==0?(e=8,d/=128):d%64==0?(e=16,d/=64):d%32==0?(e=32,d/=32):d%16==0?(e=64,d/=16):d%8==0?(e=128,d/=8):d%4==0?(e=256,d/=4):d%2==0&&(e=512,d/=2),t&&console.log("New voice, num_beats: "+d.toString()+" beat_value: "+e.toString());var f=new b.Flow.Voice({num_beats:d,beat_value:e,resolution:b.Flow.RESOLUTION});return f.setMode(b.Flow.Voice.Mode.SOFT),f}},{key:"staffConnectorsMap",value:function(a){return{brace:b.Flow.StaveConnector.type.BRACE,single:b.Flow.StaveConnector.type.SINGLE,double:b.Flow.StaveConnector.type.DOUBLE,bracket:b.Flow.StaveConnector.type.BRACKET}[a]}},{key:"addStaffConnectors",value:function(a){if(void 0===a&&(a=this.stream),!(a.length<2))for(var c=a.get(0),d=a.get(-1),e=c.length,f=0;f<e;f++){var g=c.get(f),h=d.get(f);if(g.renderOptions.startNewSystem)for(var i=g.activeVFStave,j=h.activeVFStave,k=0;k<a.renderOptions.staffConnectors.length;k++){var l=new b.Flow.StaveConnector(i,j),m=a.renderOptions.staffConnectors[k],n=this.staffConnectorsMap(m);l.setType(n),l.setContext(this.ctx),l.draw()}}}},{key:"removeFormatterInformation",value:function(a,b){a.storedVexflowStave=void 0;for(var c=0;c<a.length;c++){var d=a.get(c);d.x=void 0,d.y=void 0,d.width=void 0,d.systemIndex=void 0,d.activeVexflowNote=void 0,b&&d.isClassOrSubclass("Stream")&&this.removeFormatterInformation(d,b)}}},{key:"applyFormatterInformationToNotes",value:function(a,b,c){void 0===b&&(b=this.stream);var d=0;void 0!==a&&(d=a.start_x+a.glyph_start_x,t&&(console.log("noteOffsetLeft: "+d+" ; stave.start_x: "+a.start_x),console.log("Bottom y: "+a.getBottomY())));for(var e=0,f=0;f<b.length;f++){var g=b.get(f);if(g.isClassOrSubclass("GeneralNote")){var h=g.activeVexflowNote;if(void 0===h)continue;var i=parseInt(h.ticks),j=c.tickContexts.map[String(e)];if(e+=i,g.x=h.getAbsoluteX(),g.systemIndex=b.renderOptions.systemIndex,void 0===j)continue;g.width=j.width,void 0!==g.pitch&&(g.y=a.getBottomY()-(b.clef.lowestLine-g.pitch.diatonicNoteNum)*a.options.spacing_between_lines_px)}}if(t)for(var k=0;k<b.length;k++){var l=b.get(k);void 0!==l.pitch&&console.log(l.pitch.diatonicNoteNum+" "+l.x+" "+(l.x+l.width))}b.storedVexflowStave=a}},{key:"vfRenderer",get:function(){return void 0!==this._vfRenderer?this._vfRenderer:(this._vfRenderer=new b.Flow.Renderer(this.canvas,b.Flow.Renderer.Backends.CANVAS),this._vfRenderer)},set:function(a){this._vfRenderer=a}},{key:"ctx",get:function(){return void 0!==this._ctx?this._ctx:(this._ctx=this.vfRenderer.getContext(),this.stream&&this.stream.renderOptions&&this._ctx.scale(this.stream.renderOptions.scaleFactor.x,this.stream.renderOptions.scaleFactor.y),this._ctx)},set:function(a){this._ctx=a}}]),c}();_a.Renderer=bb;var cb={},db=function(b){function d(){j(this,d);var a=m(this,(d.__proto__||Object.getPrototypeOf(d)).call(this));return a.classes.push("Stream"),a.isStream=!0,a._duration=void 0,a._elements=[],a._elementOffsets=[],a._clef=void 0,a.displayClef=void 0,a._keySignature=void 0,a._timeSignature=void 0,a._instrument=void 0,a._autoBeam=void 0,a.activeVFStave=void 0,a.renderOptions=new Ua.RenderOptions,a._tempo=void 0,a.staffLines=5,a._stopPlaying=!1,a._allowMultipleSimultaneousPlays=!0,a.changedCallbackFunction=void 0,a.canvasChangerFunction=function(b){var c=b.currentTarget,d=a.findNoteForClick(c,b),e=n(d,2),f=e[0],g=e[1];return void 0===g?void(t&&console.log("No note found")):a.noteChanged(f,g,c)},a}return l(d,b),k(d,[{key:"clone",value:function(a){var b=Object.create(this.constructor.prototype);for(var c in this)if(!1!=={}.hasOwnProperty.call(this,c))if("activeSite"===c)b[c]=this[c];else if("renderOptions"===c)b[c]=u.merge({},this[c]);else if(!0===a||"_elements"!==c&&"_elementOffsets"!==c){if(!a||"_elements"!==c&&"_elementOffsets"!==c)"activeVexflowNote"===c||"storedVexflowstave"===c||void 0!==Object.getOwnPropertyDescriptor(this,c).get||void 0!==Object.getOwnPropertyDescriptor(this,c).set||"function"==typeof this[c]||(null!==this[c]&&void 0!==this[c]&&!0===this[c].isMusic21Object?b[c]=this[c].clone(a):b[c]=this[c]);else if("_elements"===c){b._elements=[],b._elementOffsets=[];for(var d=0;d<this._elements.length;d++){b._elementOffsets[d]=this._elementOffsets[d];var e=this._elements[d],f=e.clone(a);f.activeSite=b,b._elements[d]=f}}}else b[c]=this[c].slice();return b}},{key:"append",value:function(a){try{void 0!==a.isClassOrSubclass&&a.isClassOrSubclass("NotRest");var b=0;if(this._elements.length>0){var c=this._elements[this._elements.length-1].duration.quarterLength;b=this._elementOffsets[this._elementOffsets.length-1]+c}this._elementOffsets.push(b),this._elements.push(a),a.offset=b,a.activeSite=this}catch(b){console.error("Cannot append element ",a," to stream ",this," : ",b)}return this}},{key:"insert",value:function(a,b){try{void 0!==b.isClassOrSubclass&&b.isClassOrSubclass("NotRest");for(var c=0;c<this._elements.length;c++){if(!(this._elementOffsets[c]<=a))return this._elementOffsets.splice(c,0,a),this._elements.splice(c,0,b),b.offset=a,b.activeSite=this,this}this._elementOffsets.push(a),this._elements.push(b),b.offset=a,b.activeSite=this}catch(a){console.error("Cannot insert element ",b," to stream ",this," : ",a)}return this}},{key:"pop",value:function(){if(this.length>0){var a=this.get(-1);return this._elementOffsets.pop(),this._elements.pop(),a}}},{key:"get",value:function(a){var b=void 0;return void 0===a?void 0:Math.abs(a)>this._elements.length?void 0:a===this._elements.length?void 0:a<0?(b=this._elements[this._elements.length+a],b.offset=this._elementOffsets[this._elements.length+a],b):(b=this._elements[a],b.offset=this._elementOffsets[a],b)}},{key:"hasSubStreams",value:function(){for(var a=!1,b=0;b<this.length;b++){if(this.elements[b].isClassOrSubclass("Stream")){a=!0;break}}return a}},{key:"makeMeasures",value:function(a){var b={meterStream:void 0,refStreamOrTimeRange:void 0,searchContext:!1,innerBarline:void 0,finalBarline:"final",bestClef:!1,inPlace:!1};u.merge(b,a);var c=void 0;c=this.hasVoices()?this.getElementsByClass("Voice").length:0;var d=this.getElementsByClass("TimeSignature");0===d.length&&d.append(this.timeSignature);for(var e=this.clef,f=this.offsetMap(),g=0,h=0;h<f.length;h++)f[h].endTime>g&&(g=f[h].endTime);for(var i=new this.constructor,j=0,k=0,l=void 0,m=void 0,n=void 0;0===k||j<g;){m=new cb.Measure,m.number=k+1;var o=this.timeSignature;if(void 0===o)break;var p=o.barDuration.quarterLength;if(0===p)break;m.clef=e,m.timeSignature=o.clone();for(var q=0;q<c;q++){var r=new cb.Voice;r.id=q,m.insert(0,r)}i.insert(j,m),j+=p,k+=1}for(var s=0;s<f.length;s++){var t=f[s],v=t.element,w=t.offset,x=t.voiceIndex;l=void 0;for(var y=0;y<i.length;y++){m=i.get(y),void 0!==m.timeSignature&&(l=m.timeSignature),n=m.getOffsetBySite(i);var z=n+l.barDuration.quarterLength;if(w>=n&&w<z)break}var A=w-n;if(m.clef!==v&&(0!==A||!v.isClassOrSubclass("TimeSignature"))){var B=m;void 0!==x&&(B=m.getElementsByClass("Voice").get(x)),B.insert(A,v)}}if(!0!==b.inPlace)return i;this.elements=[];for(var C=0;C<i.length;C++){var D=i.get(C);this.insert(D.offset,D)}return this}},{key:"hasLyrics",value:function(){for(var a=0;a<this.length;a++){if(void 0!==this.elements[a].lyric)return!0}return!1}},{key:"offsetMap",value:function(){var b=[],c=[];this.hasVoices()?a.each(this.getElementsByClass("Voice").elements,function(a,b){c.push([b.flat,a])}):c=[[this,void 0]];for(var d=0;d<c.length;d++)for(var e=c[d][0],f=c[d][1],g=0;g<e.length;g++){var h=e.get(g),i=h.duration.quarterLength,j=h.offset,k=j+i,l=new cb.OffsetMap(h,j,k,f);b.push(l)}return b}},{key:"getElementsByClass",value:function(a){for(var b=[],c=0;c<this.length;c++){var d=this.get(c);void 0===d.isClassOrSubclass?console.err("what the hell is a ",d,"doing in a Stream?"):d.isClassOrSubclass(a)&&b.push(d)}var e=new cb.Stream;return e.elements=b,e}},{key:"makeAccidentals",value:function(){for(var b={},c=["C","D","E","F","G","A","B"],d=0;d<c.length;d++){var e=c[d],f=0;if(void 0!==this.keySignature){var g=this.keySignature.accidentalByStep(e);void 0!==g&&(f=g.alter)}b[e]=f}for(var h=[],i=void 0,j=void 0,k=0;k<10;k++)i=a.extend({},b),h.push(i);for(var l=a.extend({},b),m=0;m<this.length;m++){var n=this.get(m);if(void 0!==n.pitch)j=n.pitch,i=h[j.octave],this._makeAccidentalForOnePitch(j,i,l);else if(void 0!==n._notes)for(var o=0;o<n._notes.length;o++)j=n._notes[o].pitch,i=h[j.octave],this._makeAccidentalForOnePitch(j,i,l)}return this}},{key:"_makeAccidentalForOnePitch",value:function(a,b,c){var d=void 0;return d=void 0===a.accidental?0:a.accidental.alter,b[a.step]!==d||c[a.step]!==d?(void 0===a.accidental&&(a.accidental=new W.Accidental("natural")),a.accidental.displayStatus=!0):b[a.step]===d&&c[a.step]===d&&void 0!==a.accidental&&(a.accidental.displayStatus=!1),b[a.step]=d,c[a.step]=d,a}},{key:"setSubstreamRenderOptions",value:function(){return this}},{key:"resetRenderOptions",value:function(a,b){var c=this.renderOptions.events;if(this.renderOptions=new Ua.RenderOptions,b&&(this.renderOptions.events=c),a)for(var d=0;d<this.length;d++){var e=this.get(d);e.isClassOrSubclass("Stream")&&e.resetRenderOptions(a,b)}return this}},{key:"renderVexflowOnCanvas",value:function(a){return a.jquery&&(a=a[0]),new _a.Renderer(this,a).render(),a.storedStream=this,this.setRenderInteraction(a),this}},{key:"estimateStreamHeight",value:function(a){var b=this.renderOptions.naiveHeight,c=this.systemPadding,d=void 0;if(this.isClassOrSubclass("Score")){var e=this.length;d=this.numSystems(),(void 0===d||a)&&(d=1);return d*b*e+(d-1)*c}return this.isClassOrSubclass("Part")?(d=1,a||(d=this.numSystems()),t&&console.log("estimateStreamHeight for Part: numSystems ["+d+"] * staffHeight ["+b+"] + (numSystems ["+d+"] - 1) * systemPadding ["+c+"]."),d*b+(d-1)*c):b}},{key:"estimateStaffLength",value:function(){var a=void 0,b=void 0;if(void 0!==this.renderOptions.overriddenWidth)return this.renderOptions.overriddenWidth;if(this.hasVoices()){var c=0;for(a=0;a<this.length;a++){var d=this.get(a);if(d.isClassOrSubclass("Stream")){var e=d.estimateStaffLength()+d.renderOptions.staffPadding;e>c&&(c=e)}}return c}if(this.hasSubStreams()){for(b=0,a=0;a<this.length;a++){var f=this.get(a);if(f.isClassOrSubclass("Stream")&&(b+=f.estimateStaffLength()+f.renderOptions.staffPadding,0!==a&&!0===f.renderOptions.startNewSystem))break}return b}var g=this.renderOptions;return b=30*this.length,b+=g.displayClef?30:0,b+=g.displayKeySignature&&this.keySignature?this.keySignature.width:0,b+=g.displayTimeSignature?30:0}},{key:"playStream",value:function(a){var b={instrument:this.instrument,tempo:this.tempo,done:void 0,startNote:void 0};u.merge(b,a);var c=b.startNote,d=0;void 0!==c&&(d=c);var e=this.flat.elements,f=e.length;this._stopPlaying=!1;var g=this;return function a(b,c){if(d<f&&!g._stopPlaying){var e=b[d],h=void 0;d<f+1&&(h=b[d+1]);var i=0;void 0!==e.playMidi&&(i=e.playMidi(c.tempo,h,c)),d+=1,setTimeout(function(){a(b,c)},i)}else c&&c.done&&c.done.call()}(e,b),this}},{key:"stopPlayStream",value:function(){this._stopPlaying=!0;for(var a=0;a<127;a++)c.noteOff(0,a,0);return this}},{key:"createNewCanvas",value:function(b,c){this.hasSubStreams()&&this.setSubstreamRenderOptions();var d=a("<canvas/>");if(void 0!==b)"string"==typeof b&&(b=u.stripPx(b)),d.attr("width",b);else{var e=this.estimateStaffLength()+this.renderOptions.staffPadding+0;d.attr("width",e)}if(void 0!==c)d.attr("height",c);else{var f=void 0;f=void 0===this.renderOptions.height?this.estimateStreamHeight():this.renderOptions.height,d.attr("height",f*this.renderOptions.scaleFactor.y)}return d}},{key:"createPlayableCanvas",value:function(a,b){return this.renderOptions.events.click="play",this.createCanvas(a,b)}},{key:"createCanvas",value:function(a,b){var c=this.createNewCanvas(a,b);return this.renderVexflowOnCanvas(c),c}},{key:"appendNewCanvas",value:function(b,c,d){void 0===b&&(b="body");var e=b;void 0===b.jquery&&(e=a(b));var f=this.createCanvas(c,d);return e.append(f),f[0]}},{key:"replaceCanvas",value:function(b,c){void 0===b&&(b="body");var d=void 0;void 0===b.jquery?d=a(b):(d=b,b=d[0]);var e=void 0;if(e="CANVAS"===d.prop("tagName")?d:d.find("canvas"),0===e.length)throw new q("No canvas defined for replaceCanvas!");e.length>1&&(e=a(e[e.length-1]));var f=void 0;if(c){var g=e.width(),h=e.height();f=this.createCanvas(g,h)}else f=this.createCanvas();return e.replaceWith(f),f}},{key:"renderScrollableCanvas",value:function(b){var c=b;void 0===b?c=a(document.body):void 0===b.jquery&&(c=a(b));var d=a("<div>").css("position","absolute"),e=void 0;return this.renderOptions.events.click=function(a){return function(b){a.scrollScoreStart(e,b)}}(this),e=this.appendNewCanvas(d),this.setRenderInteraction(d),c.append(d),e}},{key:"scrollScoreStart",value:function(a,b){var c=new Wa.ScrollPlayer(this,a);return c.startPlaying(),void 0!==b&&b.stopPropagation(),c}},{key:"setRenderInteraction",value:function(b){var c=b;if(void 0===b)return this;void 0===b.jquery&&(c=a(b));var d=function(){this.playStream()}.bind(this);return a.each(this.renderOptions.events,a.proxy(function(a,b){c.off(a),"string"==typeof b&&"play"===b?c.on(a,d):"string"==typeof b&&"resize"===a&&"reflow"===b?this.windowReflowStart(c):void 0!==b&&c.on(a,b)},this)),this}},{key:"recursiveGetStoredVexflowStave",value:function(){var a=this.storedVexflowStave;if(void 0===a){if(!this.hasSubStreams())return;var b=this.getElementsByClass("Stream");void 0===(a=b.get(0).storedVexflowStave)&&b.get(0).hasSubStreams()&&(a=b.get(0).get(0).storedVexflowStave)}return a}},{key:"getUnscaledXYforCanvas",value:function(b,c){var d=null;d=void 0===b?{left:0,top:0}:a(b).offset();var e=void 0,f=void 0;return void 0!==c.pageX&&void 0!==c.pageY?(e=c.pageX,f=c.pageY):(e=c.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,f=c.clientY+document.body.scrollTop+document.documentElement.scrollTop),[e-d.left,f-d.top]}},{key:"getScaledXYforCanvas",value:function(a,b){var c=this.getUnscaledXYforCanvas(a,b),d=n(c,2),e=d[0],f=d[1],g=this.renderOptions.scaleFactor,h=f/g.y;return[e/g.x,h]}},{key:"diatonicNoteNumFromScaledY",value:function(a){var b=this.recursiveGetStoredVexflowStave(),c=b.options.spacing_between_lines_px,d=b.options.space_above_staff_ln,e=2*a/c,f=2*(b.options.num_lines-1+d)-e;return this.clef.lowestLine+Math.round(f)}},{key:"noteElementFromScaledX",value:function(a,b,c){var d=void 0;void 0===b&&(b=10);for(var e=0;e<this.length;e++){var f=this.get(e);if(a>f.x-b&&a<f.x+f.width+b){d=f;break}}return d}},{key:"findNoteForClick",value:function(a,b,c,d){if(void 0===c||void 0===d){var e=this.getScaledXYforCanvas(a,b),f=n(e,2);c=f[0],d=f[1]}return[this.diatonicNoteNumFromScaledY(d),this.noteElementFromScaledX(c)]}},{key:"noteChanged",value:function(a,b,c){var d=b,e=new W.Pitch("C");return e.diatonicNoteNum=a,e.accidental=d.pitch.accidental,d.pitch=e,d.stemDirection=void 0,this.activeNote=d,this.redrawCanvas(c),void 0!==this.changedCallbackFunction?this.changedCallbackFunction({foundNote:d,canvas:c}):void 0}},{key:"redrawCanvas",value:function(b){var c=a(b),d=this.createNewCanvas(b.width,b.height);return this.renderVexflowOnCanvas(d),c.replaceWith(d),this}},{key:"editableAccidentalCanvas",value:function(b,c){var d=a("<div/>").css("text-align","left").css("position","relative"),e=this.getAccidentalToolbar();return d.append(e),d.append(a("<br clear='all'/>")),this.renderOptions.events.click=this.canvasChangerFunction,this.appendNewCanvas(d,b,c),d}},{key:"getAccidentalToolbar",value:function(b,c,d){var e=this;void 0===b&&(b=-1),void 0===c&&(c=1),b=Math.round(b),c=Math.round(c);for(var f=function(b,c){var f=d;if(void 0===f){for(var g=a(c.target).parent();void 0!==g&&(void 0===f||void 0===f[0]);)f=g.find("canvas"),g=g.parent();if(void 0===f[0])return void console.log("Could not find a canvas...")}
if(void 0!==e.activeNote){e.activeNote.pitch.accidental=new W.Accidental(b),e.redrawCanvas(f[0]),void 0!==e.changedCallbackFunction&&e.changedCallbackFunction({canvas:f[0]})}},g=a("<div/>").attr("class","accidentalToolbar scoreToolbar"),h=b;h<=c;h++)!function(b){var c=new W.Accidental(b);g.append(a("<button>"+c.unicodeModifier+"</button>").click(function(a){return f(b,a)}))}(h);return g}},{key:"getPlayToolbar",value:function(){var b=this,c=a("<div/>").attr("class","playToolbar scoreToolbar"),d=a("<button>&#9658</button>");d.click(function(){b.playStream()}),c.append(d);var e=a("<button>&#9724</button>");return e.click(function(){b.stopPlayStream()}),c.append(e),c}},{key:"windowReflowStart",value:function(b){var c=this,d=b;return a(window).bind("resizeEnd",function(){var b=d.parent(),e=b.width(),f=e;console.log("resizeEnd triggered",e),c.resetRenderOptions(!0,!0),c.maxSystemWidth=f-40,d.remove();var g=c.appendNewCanvas(b);d=a(g)}),a(window).resize(function(){this.resizeTO&&clearTimeout(this.resizeTO),this.resizeTO=setTimeout(function(){a(this).trigger("resizeEnd")},200)}),setTimeout(function(){var b=a(window),c=b.data("triggerResizeOnCreateCanvas");void 0!==c&&!0!==c||(a(this).trigger("resizeEnd"),b.data("triggerResizeOnCreateCanvas",!1))},1e3),this}},{key:"hasVoices",value:function(){for(var a=0;a<this.length;a++){if(this.get(a).isClassOrSubclass("Voice"))return!0}return!1}},{key:"duration",get:function(){return void 0!==this._duration?this._duration:new x.Duration(this.highestTime)},set:function(a){this._duration=a}},{key:"flat",get:function(){if(this.hasSubStreams()){for(var a=[],b=0;b<this.length;b++){var c=this.get(b);if(void 0!==c.elements){for(var d=c.offset,e=c.flat,f=0;f<e.length;f++)e.get(f).offset+=d;a.push.apply(a,o(e._elements))}else a.push(c)}var g=this.clone(!1);return g.elements=a,g}return this}},{key:"notes",get:function(){return this.getElementsByClass(["Note","Chord"])}},{key:"notesAndRests",get:function(){return this.getElementsByClass("GeneralNote")}},{key:"tempo",get:function(){return void 0===this._tempo&&void 0!==this.activeSite?this.activeSite.tempo:void 0===this._tempo?150:this._tempo},set:function(a){this._tempo=a}},{key:"instrument",get:function(){return void 0===this._instrument&&void 0!==this.activeSite?this.activeSite.instrument:this._instrument},set:function(a){"string"==typeof a&&(a=new za.Instrument(a)),this._instrument=a}},{key:"clef",get:function(){return void 0===this._clef&&void 0===this.activeSite?new fa.Clef("treble"):void 0===this._clef?this.activeSite.clef:this._clef},set:function(a){this._clef=a}},{key:"keySignature",get:function(){return void 0===this._keySignature&&void 0!==this.activeSite?this.activeSite.keySignature:this._keySignature},set:function(a){this._keySignature=a}},{key:"timeSignature",get:function(){return void 0===this._timeSignature&&void 0!==this.activeSite?this.activeSite.timeSignature:this._timeSignature},set:function(a){"string"==typeof a&&(a=new Sa.TimeSignature(a)),this._timeSignature=a}},{key:"autoBeam",get:function(){return void 0===this._autoBeam&&void 0!==this.activeSite?this.activeSite.autoBeam:void 0===this._autoBeam||this._autoBeam},set:function(a){this._autoBeam=a}},{key:"maxSystemWidth",get:function(){var a=750;return void 0===this.renderOptions.maxSystemWidth&&void 0!==this.activeSite?a=this.activeSite.maxSystemWidth:void 0!==this.renderOptions.maxSystemWidth&&(a=this.renderOptions.maxSystemWidth),a/this.renderOptions.scaleFactor.x},set:function(a){this.renderOptions.maxSystemWidth=a*this.renderOptions.scaleFactor.x}},{key:"parts",get:function(){for(var a=[],b=0;b<this.length;b++){var c=this.get(b);c.isClassOrSubclass("Part")&&a.push(c)}return a}},{key:"measures",get:function(){for(var a=[],b=0;b<this.length;b++){var c=this.get(b);c.isClassOrSubclass("Measure")&&a.push(c)}return a}},{key:"length",get:function(){return this._elements.length}},{key:"elements",get:function(){return this._elements},set:function(a){var b=0;this._elements=[],this._elementOffsets=[];var c=[],d=void 0,e=void 0;for(d=0;d<a.length;d++){e=a[d];var f=e.offset;null===f||f===b?(this._elements.push(e),e.offset=b,this._elementOffsets.push(b),void 0===e.duration&&console.error("No duration for ",e," in ",this),b+=e.duration.quarterLength):c.push(e)}for(d=0;d<c.length;d++)e=c[d],this.insert(e.offset,e)}}]),d}(A.Music21Object);cb.Stream=db;var eb=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("Voice"),a}return l(b,a),b}(db);cb.Voice=eb;var fb=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("Measure"),a.number=0,a}return l(b,a),b}(db);cb.Measure=fb;var gb=function(b){function c(){j(this,c);var a=m(this,(c.__proto__||Object.getPrototypeOf(c)).call(this));return a.classes.push("Part"),a.systemHeight=a.renderOptions.naiveHeight,a}return l(c,b),k(c,[{key:"numSystems",value:function(){for(var a=1,b=this.getElementsByClass("Stream"),c=1;c<b.length;c++)b.get(c).renderOptions.startNewSystem&&(a+=1);return a}},{key:"getMeasureWidths",value:function(){for(var a=[],b=0;b<this.length;b++){var c=this.get(b);if(c.isClassOrSubclass("Measure")){var d=c.renderOptions;a[d.measureIndex]=d.width}}return a}},{key:"estimateStaffLength",value:function(){if(void 0!==this.renderOptions.overriddenWidth)return this.renderOptions.overriddenWidth;if(this.hasSubStreams()){for(var a=0,b=this.getElementsByClass("Measure"),c=0;c<b.length;c++){var d=b.get(c);if(a+=d.estimateStaffLength()+d.renderOptions.staffPadding,0!==c&&!0===d.renderOptions.startNewSystem)break}return a}var e=new cb.Measure;return e.elements=this.elements,e.estimateStaffLength()}},{key:"fixSystemInformation",value:function(a){void 0===a?a=this.systemHeight:t&&console.log("overridden systemHeight: "+a);var b=this.renderOptions.systemPadding||this.renderOptions.naiveSystemPadding,c=this.getMeasureWidths(),d=this.maxSystemWidth,e=[],f=[],g=0,h=20,i=void 0;for(i=0;i<c.length;i++){var j=h+c[i];j>d&&g!==i?(f.push(i-1),e.push(h),h=20+c[i],g=i):h=j}var k=0,l=0,m=void 0;for(i=0;i<this.length;i++){var n=this.get(i);if(void 0!==n.renderOptions){if(0===i&&(n.renderOptions.startNewSystem=!0),h=n.renderOptions.left,-1!==f.indexOf(i-1)){var o=n.renderOptions.width;n.renderOptions.displayClef=!0,n.renderOptions.displayKeySignature=!0,n.renderOptions.startNewSystem=!0;var p=n.estimateStaffLength()+n.renderOptions.staffPadding;n.renderOptions.width=p,l=h-20,m=l-(p-o),k+=1}else 0!==i&&(n.renderOptions.startNewSystem=!1,n.renderOptions.displayClef=!1,n.renderOptions.displayKeySignature=!1);n.renderOptions.systemIndex=k;var q=void 0;if(k>=e.length)q=1;else{q=d/e[k]}var r=h-l;void 0!==m&&(l=m,m=void 0),n.renderOptions.left=Math.floor(r*q),n.renderOptions.width=Math.floor(n.renderOptions.width*q);var s=n.renderOptions.top+k*(a+b);n.renderOptions.top=s}}return e}},{key:"setSubstreamRenderOptions",value:function(){for(var a=0,b=20,c=this.renderOptions,d=void 0,e=void 0,f=void 0,g=0;g<this.length;g++){var h=this.get(g);if(h.isClassOrSubclass("Measure")){var i=h.renderOptions;i.measureIndex=a,i.top=c.top,i.partIndex=c.partIndex,i.left=b,0===a?(f=h._clef,d=h._timeSignature,e=h._keySignature,i.displayClef=!0,i.displayKeySignature=!0,i.displayTimeSignature=!0):(void 0!==h._clef&&void 0!==f&&h._clef.name!==f.name?(console.log("changing clefs for ",i.measureIndex," from ",f.name," to ",h._clef.name),f=h._clef,i.displayClef=!0):i.displayClef=!1,void 0!==h._keySignature&&void 0!==e&&h._keySignature.sharps!==e.sharps?(e=h._keySignature,i.displayKeySignature=!0):i.displayKeySignature=!1,void 0!==h._timeSignature&&void 0!==d&&h._timeSignature.ratioString!==d.ratioString?(d=h._timeSignature,i.displayTimeSignature=!0):i.displayTimeSignature=!1),i.width=h.estimateStaffLength()+i.staffPadding,i.height=h.estimateStreamHeight(),b+=i.width,a+=1}}return this}},{key:"findNoteForClick",value:function(b,c){var d=this.getScaledXYforCanvas(b,c),e=n(d,2),f=e[0],g=e[1];t&&console.log("this.estimateStreamHeight(): "+this.estimateStreamHeight()+" / $(canvas).height(): "+a(b).height());var h=this.renderOptions.systemPadding;void 0===h&&(h=this.renderOptions.naiveSystemPadding);var i=Math.floor(g/(this.systemHeight+h)),j=g-i*(this.systemHeight+h);return[this.diatonicNoteNumFromScaledY(j),this.noteElementFromScaledX(f,void 0,i)]}},{key:"noteElementFromScaledX",value:function(a,b,c){for(var d=void 0,e=0;e<this.length;e++){var f=this.get(e),g=f.renderOptions,h=g.left,i=h+g.width,j=g.top,k=j+g.height;if(t&&console.log("Searching for X:"+Math.round(a)+" in M "+e+" with boundaries L:"+h+" R:"+i+" T: "+j+" B: "+k),a>=h&&a<=i){if(void 0===c){d=f;break}if(g.systemIndex===c){d=f;break}}}return d?d.noteElementFromScaledX(a,b):void 0}}]),c}(db);cb.Part=gb;var hb=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("Score"),a.measureWidths=[],a.partSpacing=a.renderOptions.naiveHeight,a}return l(b,a),k(b,[{key:"setSubstreamRenderOptions",value:function(){for(var a=0,b=0,c=this.partSpacing,d=0;d<this.length;d++){var e=this.get(d);e.isClassOrSubclass("Part")&&(e.renderOptions.partIndex=a,e.renderOptions.top=b,e.setSubstreamRenderOptions(),b+=c,a+=1)}this.evenPartMeasureSpacing();for(var f=this.estimateStreamHeight(!0),g=0;g<this.length;g++){var h=this.get(g);h.isClassOrSubclass("Part")&&h.fixSystemInformation(f)}return this.renderOptions.height=this.estimateStreamHeight(),this}},{key:"estimateStaffLength",value:function(){if(void 0!==this.renderOptions.overriddenWidth)return this.renderOptions.overriddenWidth;for(var a=0;a<this.length;a++){var b=this.get(a);if(b.isClassOrSubclass("Part"))return b.estimateStaffLength()}console.log("no parts found in score");var c=new cb.Part;return c.elements=this.elements,c.estimateStaffLength()}},{key:"playStream",value:function(a){for(var b=0;b<this.length;b++){var c=this.get(b);c.isClassOrSubclass("Part")&&c.playStream(a)}return this}},{key:"stopPlayStream",value:function(){for(var a=0;a<this.length;a++){var b=this.get(a);b.isClassOrSubclass("Part")&&b.stopPlayStream()}return this}},{key:"getMaxMeasureWidths",value:function(){var a=[],b=[],c=void 0;for(c=0;c<this.length;c++){var d=this.get(c);b.push(d.getMeasureWidths())}for(c=0;c<b[0].length;c++){for(var e=0,f=0;f<this.length;f++)b[f][c]>e&&(e=b[f][c]);a.push(e)}return a}},{key:"findNoteForClick",value:function(a,b){var c=this.getScaledXYforCanvas(a,b),d=n(c,2),e=d[0],f=d[1],g=this.parts.length,h=g*this.partSpacing+this.systemPadding,i=Math.floor(f/h),j=f-i*h,k=Math.floor(j/this.partSpacing),l=j-k*this.partSpacing,m=this.get(k);return[m.diatonicNoteNumFromScaledY(l),m.noteElementFromScaledX(e,void 0,i)]}},{key:"numSystems",value:function(){return this.getElementsByClass("Part").get(0).numSystems()}},{key:"evenPartMeasureSpacing",value:function(){var a=[],b=0,c=[],d=void 0,e=void 0;for(d=0;d<this.length;d++){var f=this.get(d);if(f.isClassOrSubclass("Part")){var g=f.getMeasureWidths();for(e=0;e<g.length;e++){var h=g[e];void 0===a[e]?(a[e]=[],c[e]=h):h>c[e]&&(c[e]=h),a[e][b]=h}b+=1}}var i=20;for(d=0;d<c.length;d++){var j=c[d];for(e=0;e<this.length;e++){var k=this.get(e),l=k.get(d),m=l.renderOptions;m.width=j,m.left=i}i+=j}return this}},{key:"systemPadding",get:function(){var a=(this.parts.length,this.renderOptions.systemPadding);return void 0===a&&(a=this.renderOptions.naiveSystemPadding),a}}]),b}(db);cb.Score=hb;var ib=function a(b,c,d,e){j(this,a),this.element=b,this.offset=c,this.endTime=d,this.voiceIndex=e};cb.OffsetMap=ib;var jb={};jb.makeLayoutFromScore=function(a,b){var c=a.parts,d=c.length,e=c[0],f=e.length,g=e.getMeasureWidths(),h=b||a.maxSystemWidth,i=new jb.LayoutScore,j=new jb.Page;j.measureStart=1,j.measureEnd=f,i.insert(0,j);var k=new jb.System,l=1;k.measureStart=1;var m=[],n=function(a,b,c){for(var d=0;d<b;d++){var e=new jb.Staff;e.measureStart=c,e.staffNumber=d+1,a.push(e)}};n(m,d,1);for(var o=[],p=[],q=0,r=20,s=0;s<g.length;s++){var t=r+g[s];if(t>h&&q!==s){for(var u=0;u<m.length;u++)m.measureEnd=s,k.insert(0,m[u]);m=[],n(m,d,s+1),k.measureEnd=s,j.insert(0,k),l+=1,k=new jb.System,k.measureStart=s+1,k.systemNumber=l,p.push(s-1),o.push(r),console.log("setting new width at "+r+" measure "+s),r=20+g[s],q=s}else r=t;for(var v=0;v<m.length;v++)m[v].append(c[v].get(s))}for(var w=0;w<m.length;w++)m.measureEnd=g.length-1,k.insert(0,m[w]);return j.insert(0,k),i};var kb=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("LayoutScore"),a.scoreLayout=void 0,a.measureStart=void 0,a.measureEnd=void 0,a._width=void 0,a.height=void 0,a.top=0,a.left=0,a}return l(b,a),k(b,[{key:"getPositionForStaff",value:function(a,b,c,d){d=d||"pixels"}},{key:"pages",get:function(){return this.getElementsByClass("Page")}},{key:"width",get:function(){return this._width?this._width:this.activeSite?this.activeSite.width:void 0}}]),b}(cb.Score);jb.LayoutScore=kb;var lb=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("Page"),a.pageNumber=1,a.measureStart=void 0,a.measureEnd=void 0,a.systemStart=void 0,a.systemEnd=void 0,a.pageLayout=void 0,a}return l(b,a),k(b,[{key:"systems",get:function(){return this.getElementsByClass("System")}},{key:"width",get:function(){return this._width?this._width:this.activeSite?this.activeSite.width:void 0}}]),b}(cb.Score);jb.Page=lb;var mb=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("System"),a.systemNumber=1,a.systemLayout=void 0,a.measureStart=void 0,a.measureEnd=void 0,a._width=void 0,a.height=void 0,a.top=void 0,a.left=void 0,a}return l(b,a),k(b,[{key:"staves",get:function(){return this.getElementsByClass("Staff")}},{key:"width",get:function(){return this._width?this._width:this.activeSite?this.activeSite.width:void 0}}]),b}(cb.Score);jb.System=mb;var nb=function(a){function b(){j(this,b);var a=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.classes.push("Staff"),a.staffNumber=1,a.optimized=0,a.top=void 0,a.left=void 0,a._width=void 0,a.height=void 0,a.inheritedHeight=void 0,a.staffLayout=void 0,a}return l(b,a),k(b,[{key:"width",get:function(){return this._width?this._width:this.activeSite?this.activeSite.width:void 0}}]),b}(cb.Part);jb.Staff=nb;var ob={},pb=["start","stop","continue","let-ring",void 0],qb=function(a){function b(a){j(this,b);var c=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return c._type=void 0,c.style="normal",c.type=a,c.placement=void 0,c}return l(b,a),k(b,[{key:"type",get:function(){return this._type},set:function(a){if(!pb.includes(a))throw new q('Tie type must be one of "start", "stop", "continue", "let-ring"');this._type=a}}]),b}(v.ProtoM21Object);ob.Tie=qb;var rb={divisionsPerQuarter:10080},sb=function(){function b(){j(this,b),this.xmlText=void 0,this.xmlUrl=void 0,this.$xmlRoot=void 0,this.stream=new cb.Score,this.definesExplicitSystemBreaks=!1,this.definesExplicitPageBreaks=!1,this.mxScorePartDict={},this.m21PartObjectsById={},this.partGroupList=[],this.parts=[],this.musicXmlVersion="1.0"}return k(b,[{key:"scoreFromUrl",value:function(b){var c=this;return this.xmlUrl=b,a.get(b,{},function(a,b){return c.scoreFromDOMTree(a)})}},{key:"scoreFromText",value:function(b){this.xmlText=b;var c=a.parseXML(b);return this.scoreFromDOMTree(c)}},{key:"scoreFromDOMTree",value:function(b){return this.$xmlRoot=a(a(b).children("score-partwise")),this.xmlRootToScore(this.$xmlRoot,this.stream),this.stream}},{key:"xmlRootToScore",value:function(b,c){var d=c;void 0===c&&(d=new cb.Score),this.parsePartList(b);var e=!0,f=!1,g=void 0;try{for(var h,i=b.children("part")[Symbol.iterator]();!(e=(h=i.next()).done);e=!0){var j=h.value,k=a(j),l=k.attr("id"),m=this.mxScorePartDict[l],n=this.xmlPartToPart(k,m);void 0!==n&&(d.insert(0,n),this.m21PartObjectsById[l]=n,this.parts.push(n))}}catch(a){f=!0,g=a}finally{try{!e&&i.return&&i.return()}finally{if(f)throw g}}return d}},{key:"xmlPartToPart",value:function(a,b){var c=new tb(a,b,this);return c.parse(),c.stream}},{key:"parsePartList",value:function(b){var c=b.children("part-list");if(c){var d=!0,e=!1,f=void 0;try{for(var g,h=c[Symbol.iterator]();!(d=(g=h.next()).done);d=!0){var i=g.value,j=a(i),k=j.attr("id");this.mxScorePartDict[k]=j}}catch(a){e=!0,f=a}finally{try{!d&&h.return&&h.return()}finally{if(e)throw f}}}}}]),b}(),tb=function(){function b(a,c,d){j(this,b),this.$mxPart=a,this.$mxScorePart=c,void 0!==a&&(this.partId=a.attr("id")),this.stream=new cb.Part,this.atSoundingPitch=!0,this.staffReferenceList=[],this.lastTimeSignature=void 0,this.lastMeasureWasShort=!1,this.lastMeasureOffset=0,this.lastClefs={0:new fa.TrebleClef},this.activeTuplets=[],this.activeTuplets.length=7,this.activeTuplets.fill(void 0),this.maxStaves=1,this.lastMeasureNumber=0,this.lastNumberSuffix=void 0,this.multiMeasureRestsToCapture=0,this.activeMultimeasureRestSpanner=void 0,this.activeInstrument=void 0,this.firstMeasureParsed=!1,this.$activeAttributes=void 0,this.lastDivisions=rb.divisionsPerQuarter,this.appendToScoreAfterParse=!0,this.lastMeasureParser=void 0}return k(b,[{key:"parse",value:function(){this.parseXmlScorePart(),this.parseMeasures()}},{key:"parseXmlScorePart",value:function(){g(this.stream,this.$mxScorePart,"part-name")}},{key:"parseMeasures",value:function(){var b=!0,c=!1,d=void 0;try{for(var e,f=this.$mxPart.children("measure")[Symbol.iterator]();!(b=(e=f.next()).done);b=!0){var g=e.value,h=a(g);this.xmlMeasureToMeasure(h)}}catch(a){c=!0,d=a}finally{try{!b&&f.return&&f.return()}finally{if(c)throw d}}void 0!==this.lastMeasureParser&&(this.lastMeasureParser.parent=void 0)}},{key:"xmlMeasureToMeasure",value:function(a){var b=new ub(a,this);b.parse(),void 0!==this.lastMeasureParser&&(this.lastMeasureParser.parent=void 0),this.lastMeasureParser=b,this.firstMeasureParsed=!0;var c=b.stream;this.setLastMeasureInfo(c),this.stream.append(c),this.adjustTimeAttributesFromMeasure(c)}},{key:"setLastMeasureInfo",value:function(a){a.number!==this.lastMeasureNumber&&(this.lastMeasureNumber=a.number,this.lastNumberSuffix=a.numberSuffix),void 0!==a.timeSignature?this.lastTimeSignature=a.timeSignature:void 0===this.lastTimeSignature&&(this.lastTimeSignature=new Sa.TimeSignature("4/4"))}},{key:"adjustTimeAttributesFromMeasure",value:function(a){var b=a.highestTime,c=b;this.lastMeasureOffset+=c}}]),b}(),ub=function(){function b(a,c){j(this,b),this.$mxMeasure=a,this.$mxMeasureElements=[],this.divisions=void 0,this.parent=c,this.transposition=void 0,this.staffReference={},this.useVoices=!1,this.voicesById={},this.voiceIndices=new Set,this.staves=1,this.$activeAttributes=void 0,this.attributesAreInternal=!0,this.measureNumber=void 0,this.numberSuffix=void 0,this.divisions=void 0!==c?c.lastDivisions:rb.divisionsPerQuarter,this.staffLayoutObjects=[],this.stream=new cb.Measure,this.$mxNoteList=[],this.$mxLyricList=[],this.nLast=void 0,this.chordVoice=void 0,this.fullMeasureRest=!1,this.restAndNoteCount={rest:0,note:0},this.lastClefs={0:void 0},this.parseIndex=0,this.offsetMeasureNote=0,this.attributeTagsToMethods={time:"handleTimeSignature",clef:"handleClef",key:"handleKeySignature"},this.musicDataMethods={note:"xmlToNote",attributes:"parseAttributesTag"}}return k(b,[{key:"parse",value:function(){this.parseMeasureAttributes();var b=this.$mxMeasure.children();this.$mxMeasureElements=[];var c=!0,d=!1,e=void 0;try{for(var f,g=b[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=f.value,i=a(h);this.$mxMeasureElements.push(i)}}catch(a){d=!0,e=a}finally{try{!c&&g.return&&g.return()}finally{if(d)throw e}}var j=0,k=!0,l=!1,m=void 0;try{for(var n,o=this.$mxMeasureElements[Symbol.iterator]();!(k=(n=o.next()).done);k=!0){var p=n.value,q=p[0].tagName;this.parseIndex=j;var r=this.musicDataMethods[q];void 0!==r&&this[r](p),j+=1}}catch(a){l=!0,m=a}finally{try{!k&&o.return&&o.return()}finally{if(l)throw m}}}},{key:"insertInMeasureOrVoice",value:function(a,b){this.stream.append(b)}},{key:"xmlToNote",value:function(a){var b=!1,c=this.$mxMeasureElements[this.parseIndex+1];void 0!==c&&"note"===c[0].tagName&&c.children("chord").length>0&&(b=!0);var d=!1,e=!1,f=0;a.children("rest").length>0&&(e=!0),a.children("chord").length>0&&(d=!0),b&&(d=!0);var g=void 0;if(d?this.$mxNoteList.push(a):d||e?(this.restAndNoteCount.rest+=1,g=this.xmlToRest(a)):(this.restAndNoteCount.note+=1,g=this.xmlToSimpleNote(a)),d||(this.insertInMeasureOrVoice(a,g),f=g.duration.quarterLength,this.nLast=g),this.$mxNoteList&&!b){var h=this.xmlToChord(this.$mxNoteList);this.insertInMeasureOrVoice(a,h),this.$mxNoteList=[],this.$mxLyricList=[],f=h.duration.quarterLength,this.nLast=h}this.offsetMeasureNote+=f}},{key:"xmlToChord",value:function(a){var b=[],c=!0,d=!1,e=void 0;try{for(var f,g=a[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=f.value;b.push(this.xmlToSimpleNote(h,!1))}}catch(a){d=!0,e=a}finally{try{!c&&g.return&&g.return()}finally{if(d)throw e}}return new da.Chord(b)}},{key:"xmlToSimpleNote",value:function(a,b){var c=new Z.Note;return this.xmlToPitch(a,c.pitch),this.xmlNoteToGeneralNoteHelper(c,a,b)}},{key:"xmlToPitch",value:function(b,c){var d=c;void 0===c&&(d=new W.Pitch);var e=void 0;if("pitch"===b[0].tagName)e=b;else if(e=a(b.children("pitch")[0]),0===e.length)return d;g(d,e,"step"),g(d,e,"octave",void 0,parseInt);var f=e.children("alter"),h=void 0;f&&(h=parseFloat(f.text().trim()));var i=b.children("accidental");if(i.length>0){var j=this.xmlToAccidental(i);d.accidental=j,d.accidental.displayStatus=!0}else void 0!==h&&(d.accidental=new W.Accidental(h),d.accidental.displayStatus=!1);return d}},{key:"xmlToAccidental",value:function(b){var c=new W.Accidental,d=a(b[0]).text().trim().toLowerCase();return c.set(d),c}},{key:"xmlToRest",value:function(a){var b=new Z.Rest;return this.xmlNoteToGeneralNoteHelper(b,a)}},{key:"xmlNoteToGeneralNoteHelper",value:function(a,b,c){return void 0===c&&(c=!0),this.xmlToDuration(b,a.duration),b.children("tie").length>0&&(a.tie=this.xmlToTie(b)),a}},{key:"xmlToDuration",value:function(b,c){var d=c;void 0===c&&(d=new x.Duration);var e=this.divisions,f=b.children("duration")[0],g=0;if(f){g=parseFloat(a(f).text().trim())/e}var h=b.children("type")[0];if(h){var i=a(h).text().trim(),j=b.children("dot").length;d.type=i,d.dots=j}else d.quarterLength=g;return d}},{key:"xmlToTie",value:function(b){var c=new ob.Tie,d=b.children("tie");if(d.length>1)c.type="continue";else{var e=a(d[0]);c.type=e.attr("type")}return c}},{key:"insertIntoMeasureOrVoice",value:function(a,b){this.stream.insert(this.offsetMeasureNote,b)}},{key:"parseMeasureAttributes",value:function(){this.parseMeasureNumbers()}},{key:"parseMeasureNumbers",value:function(){var a=this.$mxMeasure.attr("number"),b=parseInt(a);this.stream.number=b,this.parent&&(this.parent.lastMeasureNumber=b),this.measureNumber=b}},{key:"parseAttributesTag",value:function(b){this.attributesAreInternal=!1,this.$activeAttributes=b;var c=!0,d=!1,e=void 0;try{for(var f,g=b[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=f.value,i=h.tagName,j=a(h),k=this.attributeTagsToMethods[i];void 0!==k?this[k](j):"staves"===i?this.staves=parseInt(j.text()):"divisions"===i&&(this.divisions=parseFloat(j.text()))}}catch(a){d=!0,e=a}finally{try{!c&&g.return&&g.return()}finally{if(d)throw e}}void 0!==this.parent&&(this.parent.lastDivisions=this.divisions,this.parent.$activeAttributes=this.$activeAttributes)}},{key:"handleTimeSignature",value:function(a){var b=this.xmlToTimeSignature(a);this.insertIntoMeasureOrVoice(a,b)}},{key:"xmlToTimeSignature",value:function(b){var c=a(b.children("beats")[0]).text().trim(),d=a(b.children("beat-type")[0]).text().trim();return new Sa.TimeSignature(c+"/"+d)}},{key:"handleClef",value:function(a){var b=this.xmlToClef(a);this.insertIntoMeasureOrVoice(a,b),this.lastClefs[0]=b}},{key:"xmlToClef",value:function(b){var c=a(b.children("sign")[0]).text().trim(),d=a(b.children("line")[0]).text().trim(),e=0,f=b.children("clef-octave-change");return f.length>0&&(e=parseInt(a(f[0]).text().trim())),fa.clefFromString(c+d,e)}},{key:"handleKeySignature",value:function(a){var b=this.xmlToKeySignature(a);this.insertIntoMeasureOrVoice(a,b)}},{key:"xmlToKeySignature",value:function(a){var b=new Ha.KeySignature;return g(b,a,"fifths","sharps",parseInt),b}}]),b}(),vb={ScoreParser:sb,PartParser:tb,MeasureParser:ub},wb={};wb.romanToNumber=[void 0,"i","ii","iii","iv","v","vi","vii"];var xb=function(a){function b(a,c){j(this,b);var d=m(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));d.classes.push("RomanNumeral"),d.figure=a,d._scale=void 0,d._key=void 0,d.key=c;var e=a,f="major",g=e.toLowerCase();e.match("/o")?(f="half-diminished",e=e.replace("/o","")):e.match("o")?(f="diminished",e=e.replace("o","")):e===g&&(f="minor");var h=e.match(/\d+/);d.numbers=void 0,null!=h&&(e=e.replace(/\d+/,""),d.numbers=parseInt(h[0]));var i=wb.romanToNumber.indexOf(e.toLowerCase());if(-1===i)throw new q("Cannot make a romanNumeral from "+e);if(d.scaleDegree=i,d.root=d.scale[d.scaleDegree-1],"minor"===d.key.mode&&(6===d.scaleDegree||7===d.scaleDegree)&&-1!==["minor","diminished","half-diminished"].indexOf(f)){var k=new Ba.Interval("A1");d.root=k.transposePitch(d.root),t&&console.log("raised root because minor/dim on scaleDegree 6 or 7")}return 7===d.numbers&&(5===i&&"major"===f?f="dominant-seventh":f+="-seventh"),d.impliedQuality=f,d.updatePitches(),d}return l(b,a),k(b,[{key:"updatePitches",value:function(){for(var a=this.impliedQuality,b=da.chordDefinitions[a],c=[this.root],d=this.root,e=0;e<b.length;e++){var f=b[e],g=new Ba.Interval(f),h=g.transposePitch(d);c.push(h),d=h}this.pitches=c}},{key:"asString",value:function(a,b){var c=this.key,d=c.tonic,e=c.mode;void 0===b&&(b=0);var f="";1===b?f="roman"===a?"6":" (first inversion)":2===b&&(f="roman"===a?"64":" (second inversion)");var g=void 0,h=" in ",i="";"roman"===a?g=this.figure:"nameOnly"===a?(g="",h="",i=" triad"):"bassName"===a?(g=this.bass().name.replace(/-/,"b"),h=" in ",i=""):(g=this.degreeName,void 0!==this.numbers&&(g+=" "+this.numbers.toString()));var j=d.replace(/-/,"b");return"minor"===e&&(j=j.toLowerCase()),g+f+h+j+" "+e+i}},{key:"scale",get:function(){return void 0!==this._scale?this._scale:(this._scale=this.key.getScale(),this._scale)}},{key:"key",get:function(){return this._key},set:function(a){this._key="string"==typeof a?new Ha.Key(a):void 0===a?new Ha.Key("C"):a}},{key:"degreeName",get:function(){if(this.scaleDegree<7)return[void 0,"Tonic","Supertonic","Mediant","Subdominant","Dominant","Submediant"][this.scaleDegree];var a=new W.Pitch(this.key.tonic),b=(a.ps-this.root.ps)%12;return b<0&&(b+=12),1===b?"Leading-tone":"Subtonic"}}]),b}(da.Chord);wb.RomanNumeral=xb;var yb={};yb.defaultTempoValues={larghissimo:16,largamente:32,grave:40,"molto adagio":40,largo:46,lento:52,adagio:56,slow:56,langsam:56,larghetto:60,adagietto:66,andante:72,andantino:80,"andante moderato":83,maestoso:88,moderato:92,moderate:92,allegretto:108,animato:120,"allegro moderato":128,allegro:132,fast:132,schnell:132,allegrissimo:140,"molto allegro":144,"très vite":144,vivace:160,vivacissimo:168,presto:184,prestissimo:208},yb.baseTempo=60;var zb=function(b){function d(a){j(this,d);var b=m(this,(d.__proto__||Object.getPrototypeOf(d)).call(this));return b.classes.push("Metronome"),b._tempo=60,b.tempo=void 0===a?yb.baseTempo:a,b.numBeatsPerMeasure=4,b.minTempo=10,b.maxTempo=600,b.beat=b.numBeatsPerMeasure,b.chirpTimeout=void 0,b.silent=!1,b.flash=!1,b.tempoRanges=[0,40,60,72,120,144,240,999],b.tempoIncreases=[0,1,2,3,4,6,8,15,100],b}return l(d,b),k(d,[{key:"_silentFlash",value:function(b){this.$metronomeDiv.find(".metroFlash").css("background-color",b).fadeOut(1e3*this.beatLength*1/4,function(){a(this).css("background-color","#ffffff").fadeIn(1)})}},{key:"chirp",value:function(){this.beat+=1,this.beat>this.numBeatsPerMeasure?(this.beat=1,!0!==this.silent&&(c.noteOn(0,96,100,0),c.noteOff(0,96,.1)),!0===this.flash&&this._silentFlash("#0000f0")):(!0!==this.silent&&(c.noteOn(0,84,70,0),c.noteOff(0,84,.1)),!0===this.flash&&this._silentFlash("#ff0000"));var a=this;this.chirpTimeout=setTimeout(function(){a.chirp()},6e4/this.tempo)}},{key:"stopChirp",value:function(){void 0!==this.chirpTimeout&&(clearTimeout(this.chirpTimeout),this.chirpTimeout=void 0)}},{key:"increaseSpeed",value:function(a){void 0===a&&(a=1);for(var b=0;b<a;b++){for(var c=this.tempo,d=0;d<this.tempoRanges.length;d++){var e=this.tempoRanges[d],f=this.tempoIncreases[d];if(c<e){c+=f,c=f*Math.round(c/f);break}}this.tempo=c}return this.tempo}},{key:"decreaseSpeed",value:function(a){void 0===a&&(a=1);for(var b=0;b<a;b++){for(var c=this.tempo,d=this.tempoRanges.length,e=1;e<=d;e++){var f=this.tempoRanges[d-e],g=this.tempoIncreases[d-e+1];if(c>f){c-=g,c=g*Math.floor(c/g);break}}this.tempo=c}}},{key:"addDiv",value:function(b){var c=void 0;c=void 0!==b&&void 0!==b.jquery?b:a(void 0!==b?b:"body");var d=this,e=a('<span class="tempoHolder">'+this.tempo.toString()+"</span>");e.css({"font-size":"24px","padding-left":"10px","padding-right":"10px"});var f=a('<div class="metronomeRendered"></div>');f.append(e);var g=a("<button>start</button>");g.on("click",function(){d.chirp()});var h=a("<button>stop</button>");h.on("click",function(){d.stopChirp()}),f.prepend(h),f.prepend(g);var i=a("<button>up</button>");i.on("click",function(){d.increaseSpeed(),a(this).prevAll(".tempoHolder").html(d.tempo.toString())});var j=a("<button>down</button>");j.on("click",function(){d.decreaseSpeed(),a(this).prevAll(".tempoHolder").html(d.tempo.toString())}),f.append(i),f.append(j);var k=a('<span class="metroFlash">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>');return k.css("margin-left","40px"),k.css("height","40px"),f.append(k),c.append(f),this.$metronomeDiv=f,f}},{key:"tempo",get:function(){return this._tempo},set:function(a){this._tempo=a,this._tempo>this.maxTempo?this._tempo=this.maxTempo:this._tempo<this.minTempo&&(this._tempo=this.minTempo)}},{key:"beatLength",get:function(){return 60/this.tempo}}]),d}(v.ProtoM21Object);yb.Metronome=zb;var Ab={};Ab.regularExpressions={REST:/r/,OCTAVE2:/([A-G])[A-G]+/,OCTAVE3:/([A-G])/,OCTAVE5:/([a-g])('+)/,OCTAVE4:/([a-g])/,EDSHARP:/\((#+)\)/,EDFLAT:/\((-+)\)/,EDNAT:/\(n\)/,SHARP:/^[A-Ga-g]+'*(#+)/,FLAT:/^[A-Ga-g]+'*(-+)/,NAT:/^[A-Ga-g]+'*n/,TYPE:/(\d+)/,TIE:/.~/,PRECTIE:/~/,ID_EL:/=([A-Za-z0-9]*)/,LYRIC:/_(.*)/,DOT:/\.+/,TIMESIG:/(\d+)\/(\d+)/,PARTBREAK:/partBreak/,TRIP:/trip\{/,QUAD:/quad\{/,ENDBRAC:/\}$/},Ab.TinyNotation=function(a){a=a.trim();for(var b=a.split(" "),c=void 0,d=new cb.Part,e=new cb.Measure,f=4,g=1,h={lastNoteTied:!1,inTrip:!1,inQuad:!1,endTupletAfterNote:!1},i=Ab.regularExpressions,j=0;j<b.length;j++){e.duration.quarterLength>=f&&(d.append(e),e=new cb.Measure);var k=b[j],l=void 0;if(i.PARTBREAK.exec(k))e.length>0&&(d.append(e),e=new cb.Measure),void 0===c&&(c=new cb.Score),c.insert(0,d),d=new cb.Part,h.lastNoteTied=!1,h.inTrip=!1,h.inQuad=!1,h.endTupletAfterNote=!1;else if(i.TRIP.exec(k)&&(k=k.slice(5),h.inTrip=!0),i.QUAD.exec(k)&&(k=k.slice(5),h.inQuad=!0),i.ENDBRAC.exec(k)&&(k=k.slice(0,-1),h.endTupletAfterNote=!0),i.TIMESIG.exec(k)){var m=i.TIMESIG.exec(k),n=new Sa.TimeSignature;n.numerator=parseInt(m[1]),n.denominator=parseInt(m[2]),e.timeSignature=n,f=n.barDuration.quarterLength}else{if(i.REST.exec(k))l=new Z.Rest(g);else if(i.OCTAVE2.exec(k)){var o=i.OCTAVE2.exec(k);l=new Z.Note(o[1],g),l.pitch.octave=4-o[0].length}else if(i.OCTAVE3.exec(k)){var p=i.OCTAVE3.exec(k);l=new Z.Note(p[1],g),l.pitch.octave=3}else if(i.OCTAVE5.exec(k)){var q=i.OCTAVE5.exec(k);l=new Z.Note(q[1].toUpperCase(),g),l.pitch.octave=3+q[0].length}else if(i.OCTAVE4.exec(k)){var r=i.OCTAVE4.exec(k);l=new Z.Note(r[1].toUpperCase(),g),l.pitch.octave=4}if(void 0!==l){i.TIE.exec(k)?(l.tie=new ob.Tie("start"),h.lastNoteTied&&(l.tie.type="continue"),h.lastNoteTied=!0):h.lastNoteTied&&(l.tie=new ob.Tie("stop"),h.lastNoteTied=!1),
i.SHARP.exec(k)?l.pitch.accidental=new W.Accidental("sharp"):i.FLAT.exec(k)?l.pitch.accidental=new W.Accidental("flat"):i.NAT.exec(k)&&(l.pitch.accidental=new W.Accidental("natural"),l.pitch.accidental.displayType="always");var s=i.TYPE.exec(k);if(s){var t=parseInt(s[0]);l.duration.quarterLength=4/t}if(s=i.DOT.exec(k)){var u=s[0].length,v=1-Math.pow(.5,u)+1;l.duration.quarterLength*=v}g=l.duration.quarterLength,h.inTrip&&l.duration.appendTuplet(new x.Tuplet(3,2,l.duration.quarterLength)),h.inQuad&&l.duration.appendTuplet(new x.Tuplet(4,3,l.duration.quarterLength)),h.endTupletAfterNote&&(h.inTrip=!1,h.inQuad=!1,h.endTupletAfterNote=!1),e.append(l)}}}var w=void 0;if(void 0!==c){e.length>0&&d.append(e),d.length>0&&c.append(d);for(var y=0;y<c.length;y++){var z=c.get(y);z.clef=fa.bestClef(z)}w=c}else d.length>0?(d.append(e),d.clef=fa.bestClef(d),w=d):(e.clef=fa.bestClef(e),w=e);return w},Ab.renderNotationDivs=function(b,c){void 0===b&&(b=".music21.tinyNotation");var d=[];void 0===c?d=a(b):(void 0===c.jquery&&(c=a(c)),d=c.find(b));for(var e=0;e<d.length;e++){var f=d[e],g=a(f),h=void 0;if(void 0!==g.attr("tinynotationcontents")?h=g.attr("tinynotationcontents"):void 0!==f.textContent&&(h=f.textContent,h=h.replace(/s+/g," ")),void 0!==String.prototype.trim&&void 0!==h&&(h=h.trim()),h){var i=Ab.TinyNotation(h);g.hasClass("noPlayback")&&(i.renderOptions.events.click=void 0);var j=i.createCanvas();g.attr("tinynotationcontents",h),g.empty(),g.data("stream",i),g.append(j)}}};var Bb={};Bb.selectedOutputPort=void 0,Bb.selectedInputPort=void 0,Bb.access=void 0,Bb.$selectDiv=void 0,Bb.jazzDownloadUrl="http://jazz-soft.net/download/Jazz-Plugin/",Bb.storedPlugin=void 0,Bb.selectedJazzInterface=void 0,Bb.jazzMidiInArrived=function(a,b,c,d){var e={timestamp:a,data:[b,c,d]};return Bb.midiInArrived(e)},Bb.midiInArrived=function(a){var b=a.timeStamp,c=a.data[0],d=a.data[1],e=a.data[2],f=Ka.callBacks.raw(b,c,d,e);return Ka.callBacks.general instanceof Array?Ka.callBacks.general.forEach(function(a,b,c){a(f)}):void 0!==Ka.callBacks.general?Ka.callBacks.general(f):void 0},Bb.createPlugin=function(b,c){if(Bb.storedPlugin&&!0!==c)return Bb.storedPlugin;void 0===b&&(b=a("body")[0]);var d=document.createElement("object");return d.classid="CLSID:1ACE1618-1C7D-4561-AEE1-34842AA85E90",d.isJazz||(d.type="audio/x-jazz"),d.style.visibility="hidden",d.style.width="0px",d.style.height="0px",b.appendChild(d),d.isJazz?(Bb.storedPlugin=d,d):(b.removeChild(d),void console.error("Cannot use jazz plugin; install at "+Bb.jazzDownloadUrl))},Bb.createJazzSelector=function(b,c){var d={};u.merge(d,c);var e=Bb.createPlugin();if(void 0!==e){b.change(function(){var b=a("#midiInSelect option:selected").text();"None selected"!==b?Bb.selectedJazzInterface=e.MidiInOpen(b,Bb.jazzMidiInArrived):e.MidiInClose(),t&&console.log("current input changed to: "+Bb.selectedInterface)});var f=e.MidiInList(),g=a("<option value='None'>None selected</option>");b.append(g);for(var h=!1,i=[],j=0;j<f.length;j++){var k=a("<option value='"+f[j]+"'>"+f[j]+"</option>");f[j]===Bb.selectedJazzInterface&&(k.attr("selected",!0),h=!0),i.push(k),b.append(k)}return!1===h&&f.length>0?(b.val(f[0]),i[0].attr("selected",!0),Bb.selectedJazzInterface=e.MidiInOpen(f[0],Bb.jazzMidiInArrived),h=!0):g.attr("selected",!0),void 0!==d.onsuccess&&d.onsuccess(),!0===h&&void 0!==d.oninputsuccess?d.oninputsuccess():!1===h&&void 0!==d.oninputempty&&d.oninputempty(),b}},Bb.selectionChanged=function(){var a=Bb.$select.val();if(a===Bb.selectedInputPort)return!1;var b=Bb.access.onstatechange;return Bb.access.onstatechange=function(){},t&&console.log("current input changed to: "+a),Bb.selectedInputPort=a,Bb.access.inputs.forEach(function(b){b.name===a?b.onmidimessage=Bb.midiInArrived:b.close()}),Bb.access.onstatechange=b,!1},Bb.createSelector=function(b,c){var d={autoUpdate:!0,existingMidiSelect:!1};u.merge(d,c),void 0===b&&(b=a("body")),void 0===b.jquery&&(b=a(b));var e=void 0,f=b.find("select#midiInSelect");return f.length>0?(e=f[0],d.existingMidiSelect=!0):(e=a("<select>").attr("id","midiInSelect"),b.append(e)),Bb.$select=e,void 0===navigator.requestMIDIAccess?Bb.createJazzSelector(e,d):(!0!==d.existingMidiSelect&&e.change(Bb.selectionChanged),navigator.requestMIDIAccess().then(function(a){Bb.access=a,Bb.populateSelect(),d.autoUpdate&&(a.onstatechange=Bb.populateSelect),Bb.$select.change(),void 0!==d.onsuccess&&d.onsuccess(),"None"!==Bb.selectedInputPort&&void 0!==d.oninputsuccess?d.oninputsuccess():"None"===Bb.selectedInputPort&&void 0!==d.oninputempty&&d.oninputempty()},function(a){b.html(a.message)})),Ka.clearOldChords(),e},Bb.populateSelect=function(){var b=Bb.access.inputs;Bb.$select.empty();var c=a("<option value='None'>None selected</option>");Bb.$select.append(c);var d=[],e=[],f=0;b.forEach(function(b){var c=a("<option value='"+b.name+"'>"+b.name+"</option>");d.push(c),e.push(b.name),Bb.$select.append(c),f+=1}),d.length>0?(Bb.$select.val(e[0]),d[0].attr("selected",!0)):c.attr("selected",!0),Bb.$select.change()},Bb.callBacks=Ka.callBacks;var Cb={},Db=function(){function b(a,c){var d=this;j(this,b),this.stream=a,this.canvasDiv=c,this.values=["whole","half","quarter","eighth","16th","dot","undo"],this.stream.hasSubStreams()?this.measureMode=!0:this.measureMode=!1,this.tieActive=!1,this.autoAddMeasure=!0,this.valueMappings={whole:"&#xEB9B;&#xE1D2;",half:"&#xEB9B;&#xE1D3;",quarter:"&#xEB9B;&#xE1D5;",eighth:"&#xEB9B;&#xE1D7;","16th":"&#xEB9B;&#xE1D9;","32nd":"&#xEB9B;&#xE1DB;",addMeasure:"&#xE031",dot:"&#xEB9B;&#xE1E7;",undo:"&#x232B;",tie:'<span style="position: relative; top: -20px;">&#xE1FD</span>',rest_whole:"&#xE4F4;",rest_half:"&#xE4F5;",rest_quarter:"&#xE4E5;",rest_eighth:"&#xE4E6;",rest_16th:"&#xE4E7;",rest_32nd:"&#xE4E8;"},this.styles={undo:"font-family: serif; font-size: 30pt; top: -7px;"},this.buttonHandlers={undo:function(a){return d.stream.length>0?d.stream.pop():void 0},dot:function(a){if(d.stream.length>0){var b=d.stream.pop();return b.duration.dots+=1,d.stream.append(b),b}},tie:function(a){if(d.stream.length>0){var b=d.stream.get(-1);return b.tie=new ob.Tie("start"),d.tieActive=!0,b}},default:function(a){var b=new Z.Note("B4");return b.stemDirection="up",0===a.indexOf("rest_")&&(b=new Z.Rest,a=a.slice("rest_".length)),b.duration.type=a,d.tieActive&&(b.tie=new ob.Tie("stop"),d.tieActive=!1),d.stream.append(b),b}},this.measureButtonHandlers={undo:function(a){if(d.stream.length>0){var b=d.stream.get(-1),c=b.pop();return 0===b.length&&d.stream.length>1&&d.stream.pop(),c}},dot:function(a){if(d.stream.length>0){var b=d.stream.get(-1),c=b.pop();return c.duration.dots+=1,b.append(c),c}},addMeasure:function(a){var b=d.stream.get(-1),c=new cb.Measure;c.renderOptions.staffLines=b.renderOptions.staffLines,c.renderOptions.measureIndex=b.renderOptions.measureIndex+1,c.renderOptions.rightBarline="end",b.renderOptions.rightBarline="single",c.autoBeam=b.autoBeam,d.stream.append(c)},tie:function(a){var b=d.stream.get(-1),c=void 0;if(b.length>0)c=b.get(-1);else{var e=d.stream.get(-2);e&&(c=e.get(-1))}if(void 0!==c){var f="start";void 0!==c.tie&&(f="continue"),c.tie=new ob.Tie(f),d.tieActive=!0}},default:function(a){var b=new Z.Note("B4");b.stemDirection="up",0===a.indexOf("rest_")&&(b=new Z.Rest,a=a.slice("rest_".length)),b.duration.type=a,d.tieActive&&(b.tie=new ob.Tie("stop"),d.tieActive=!1);var c=d.stream.get(-1);return d.autoAddMeasure&&c.duration.quarterLength>=d.stream.timeSignature.barDuration.quarterLength&&(d.measureButtonHandlers.addMeasure.apply(d,[a]),c=d.stream.get(-1)),c.append(b),b}}}return k(b,[{key:"addDiv",value:function(b){var c=b;void 0!==b&&void 0===b.jquery&&(c=a(b));for(var d=a('<div class="rhythmButtonDiv"/>'),e=0;e<this.values.length;e++){var f=this.values[e],g=this.valueMappings[f],h=a('<button class="btButton" m21Type="'+f+'">'+g+"</button>");void 0!==this.styles[f]&&h.attr("style",this.styles[f]),h.click(function(a){this.handleButton(a)}.bind(this,f)),d.append(h)}return void 0!==b&&c.append(d),d}},{key:"handleButton",value:function(a){var b=this.buttonHandlers;this.measureMode&&(b=this.measureButtonHandlers);var c=b[a];void 0===c&&(c=b.default),c.apply(this,[a]);var d=this.stream;d.isClassOrSubclass("Part")&&void 0!==d.activeSite&&(d=d.activeSite),void 0!==this.canvasDiv&&d.replaceCanvas(this.canvasDiv)}}]),b}();Cb.RhythmChooser=Db;var Eb=function(){function b(a,c){j(this,b),this.streamObj=a,this.canvasDiv=c}return k(b,[{key:"performChange",value:function(a,b){var c=!1;void 0===b&&(c=!0,b=this.streamObj);for(var d=0;d<b.length;d++){var e=b.get(d);!0===e.isStream?this.performChange(a,e):e.duration.quarterLength*=a}void 0!==b.timeSignature&&(b.timeSignature.denominator*=1/a),void 0!==this.canvasDiv&&!0===c&&(this.canvasDiv=b.replaceCanvas(this.canvasDiv))}},{key:"makeSmaller",value:function(){return this.performChange(.5)}},{key:"makeLarger",value:function(){return this.performChange(2)}},{key:"addDiv",value:function(b){var c=this,d=a('<div class="augmenterDiv" />'),e=a('<button class="augmenterButton">Make Smaller</button>'),f=a('<button class="augmenterButton">Make Larger</button>');return e.on("click",function(){c.makeSmaller()}),f.on("click",function(){c.makeLarger()}),d.append(e),d.append(f),b.append(d),d}}]),b}();Cb.Augmenter=Eb;var Fb={};return Fb.common=u,Fb.debug=t,Fb.prebase=v,Fb.base=A,Fb.articulations=C,Fb.audioRecording=S,Fb.audioSearch=P,Fb.beam=T,Fb.chord=da,Fb.clef=fa,Fb.dynamics=qa,Fb.duration=x,Fb.exceptions21=s,Fb.expressions=sa,Fb.fromPython=xa,Fb.instrument=za,Fb.interval=Ba,Fb.key=Ha,Fb.keyboard=Na,Fb.layout=jb,Fb.meter=Sa,Fb.miditools=Ka,Fb.musicxml=vb,Fb.note=Z,Fb.pitch=W,Fb.renderOptions=Ua,Fb.roman=wb,Fb.scale=Ga,Fb.stream=cb,Fb.streamInteraction=Wa,Fb.tempo=yb,Fb.tie=ob,Fb.tinyNotation=Ab,Fb.vfShow=_a,Fb.webmidi=Bb,Fb.widgets=Cb,Fb});
//# sourceMappingURL=music21.min.js.map